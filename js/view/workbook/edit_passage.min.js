function pageinit(){const l=Number(sessionStorage.getItem("editingPassageId")),e=Number(sessionStorage.getItem("workbookId")),t=getComputedStyle(document.querySelector(".one-sentence-unit-section")).backgroundColor;u(),$("#addPassageBtn").click(()=>location.assign("/workbook/passage/add/"+ntoa(e))),$("#viewPassageBtn").click(()=>location.assign("/workbook/passage/"+ntoa(e)+"/"+ntoa(l))),$("#editWorkbookBtn").click(()=>location.assign("/workbook/mybook/edit/"+ntoa(e))),$(".list-sentence-section").sortable({axis:"y",items:">.one-sentence-unit-section",handle:".js-move-sentence",classes:{"ui-sortable-helper":"shadow-lg"},cursor:"move",update:(e,t)=>{if(confirm("문장을 여기로 이동하겠습니까?")){var n=t.item.prev(".one-sentence-unit-section"),s=t.item.next(".one-sentence-unit-section");if(0==s.length)t.item[0].dataset.ordernum=Number(n[0].dataset.ordernum)+1e3;else if(0==n.length){var o=Number(s[0].dataset.ordernum),a=Math.round(o/2);if(a==o)return alert("더이상 이동할 수 없습니다."),void $(".list-sentence-section").sortable("cancel");t.item[0].dataset.ordernum=a}else{const i=Number(n[0].dataset.ordernum),d=Number(s[0].dataset.ordernum),c=Math.round((i+d)/2);if(-1<[i,d].indexOf(c))return alert("더이상 이동할 수 없습니다."),void $(".list-sentence-section").sortable("cancel");t.item[0].dataset.ordernum=c}o={sentenceId:Number(t.item.data("sid")),sameText:!0,passageId:l,eng:t.item.find(".sentence-text").text(),orderNum:Number(t.item[0].dataset.ordernum)};editPassageSentece(o,r)}else $(".list-sentence-section").sortable("cancel")}}),$(".js-open-add-sentence").click(function(){$(this).add($(".add-section")).slideToggle(100,()=>$(".add-section textarea").focus())}),$(".js-cancel-add").click(function(){$(".add-section textarea").val("").trigger("input"),$(".add-section,.js-open-add-sentence").slideToggle(100)}),$(document).on("click",'.one-sentence-unit-section [data-toggle="collapse"]',function(){$(this.closest(".one-sentence-unit-section")).find(".collapse").collapse("toggle")});function c(e){anime({targets:e,duration:1e3,easing:"linear",backgroundColor:["#ffc107",t]})}function r(){$(".list-sentence-section").html($(".one-sentence-unit-section").sort((e,t)=>e.dataset.ordernum-t.dataset.ordernum).each((e,t)=>$(t).find(".numbering-text").text(e+1)))}function u(){var e=1500<=Array.from($(".one-sentence-unit-section .sentence-text").get(),e=>e.textContent).join("").length;$(".exceed-max-notice")[e?"slideDown":"slideUp"](100),$(".js-open-add-sentence")[e?"slideUp":"slideDown"](100)}$(document).on("input",".edit-section textarea,.add-section textarea",function(){const e=$(this.closest(".edit-section,.add-section")),t=e.find(".js-edit,.js-add"),n=e.find(".invalid-text");let s=$(this).val().parseToSentences().join(" ").capitalize1st();0==s.length?(n.hide(),t.prop("disabled",!0)):0==s.length||500<s.length||s.match(/[^\u0020-\u007F\u0085\u00A0\u2028\u2029\u2018-\u201A\u201C-\u201D]/gi)?(n.show(),t.prop("disabled",!0)):(n.hide(),t.prop("disabled",!1))}),$(".js-add").click(function(){var e=$(".add-section textarea").val().parseToSentences().join(" ").capitalize1st(),t=Number($(".one-sentence-unit-section:last")[0].dataset.ordernum)+1e3,e={sentenceId:0,passageId:l,eng:e,orderNum:t};$("#loadingModal").modal("show"),editPassageSentece(e,function(s){if($("#loadingModal").modal("hide"),0<s.length){let n="아래와 같은 "+s.length+"개의 문장이 추가되었습니다.";$(".js-cancel-add").trigger("click");const a=$(".list-sentence-section"),i=[];for(let e=0,t=s.length;e<t;e++){var o=s[e];const d=$(".one-sentence-unit-section:last").clone();d.find(".sentence-text, textarea").text(o.eng),d[0].dataset.sid=o.sentenceId,d[0].dataset.ordernum=o.orderNum,a.append(d),n+="\n["+(e+1)+"] "+o.eng,i.push(d[0])}r(),u(),alert(n),c(i)}},function(){alert("등록에 실패했습니다."),$("#loadingModal").modal("hide")})}),$(document).on("click",".js-edit",function(){const d=$(this.closest(".one-sentence-unit-section"));let e=d.find(".sentence-text").text(),t=d.find(".edit-section textarea").val().parseToSentences().join(" ").capitalize1st();if(!(0==t.length||500<t.length||t.match(/[^\u0020-\u007F\u0085\u00A0\u2028\u2029\u2018-\u201A\u201C-\u201D]/gi)))if(t==e)d.find(".collapse").collapse("toggle");else{const n={sentenceId:Number(d[0].dataset.sid),passageId:l,eng:t,sameText:!1,orderNum:Number(d[0].dataset.ordernum)};e.toLowerCase().replace(/\s/g,"")==t.toLowerCase().replace(/\s/g,"")?n.sameTextSeq=!0:n.sameTextSeq=!1,$("#loadingModal").modal("show"),editPassageSentece(n,function(i){if($("#loadingModal").modal("hide"),1<i.length){let a="문장이 아래와 같이 "+i.length+"개로 나뉘었습니다.";d.find(".edit-section").one("hidden.bs.collapse",function(){d.hide(function(){const n=[];for(let e=0,t=i.length;e<t;e++){var s=i[e];const o=d.clone();o.find(".sentence-text, textarea").text(s.eng),o[0].dataset.sid=s.sentenceId,o[0].dataset.ordernum=s.orderNum,d.before(o),a+="\n["+(e+1)+"] "+s.eng,n.push(o[0])}d.remove(),$(".one-sentence-unit-section").slideDown(),r(),u(),alert(a),c(n)})}),d.find(".edit-section").collapse("hide")}else 1==i.length&&(alert("수정되었습니다."),d.find(".sentence-text").text(i[0].eng),d[0].dataset.sid=i[0].sentenceId,d.find(".edit-section textarea").val(i[0].eng),d.find(".edit-section").collapse("hide"),c(d[0]))},function(){alert("수정에 실패했습니다."),$("#loadingModal").modal("hide")})}}).on("click",".js-del-sentence",function(){if(confirm("문장을 삭제하시겠습니까?")){const e=$(this.closest(".one-sentence-unit-section"));delPassageSentence({passageId:l,sentenceId:Number(e[0].dataset.sid)},function(){alert("문장이 삭제되었습니다."),e.slideUp(function(){$(this).remove(),r(),u()})})}})}
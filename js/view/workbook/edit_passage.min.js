function pageinit(e,t){$("#loadingModal").modal("hide");const r=Number(sessionStorage.getItem("editingPassageId")||sessionStorage.getItem("passageId")),n=Number(sessionStorage.getItem("workbookId")),i=".list-sentence-section",c=".one-sentence-unit-section",g={el:"div",class:"one-sentence-unit-section p-2 p-lg-4 mb-2 border-0","data-ordernum":"0","data-sid":"0",children:[{el:"div",class:"origin-sentence-section my-auto",children:[{el:"div",class:"d-none d-md-block edit-btn-section",children:[{el:"span",role:"button",class:"js-move-sentence btn edit-btn ui-sortable-handle","data-toggle":"tooltip",title:"위치 이동",children:[{el:"span",class:"fas fa-arrows-alt"}]},{el:"button",type:"button",class:"js-del-sentence btn edit-btn","data-toggle":"tooltip",title:"문장 삭제",children:[{el:"span",class:"fas fa-trash-alt"}]},{el:"button",type:"button",class:"edit-icon-section btn edit-btn","data-toggle":"collapse",children:[{el:"span",class:"edit-icon fas fa-pen"}]}]},{el:"div",class:"d-block d-md-none float-end border rounded-3 px-1",children:[{el:"span",role:"button",class:"js-move-sentence d-block btn p-1 ui-sortable-handle","data-toggle":"tooltip",title:"위치 이동",children:[{el:"span",class:"fas fa-arrows-alt"}]},{el:"button",type:"button",class:"js-del-sentence d-block btn p-1 mx-auto","data-toggle":"tooltip",title:"문장 삭제",children:[{el:"span",class:"fas fa-trash-alt"}]},{el:"button",type:"button",class:"edit-icon-section d-block btn p-1","data-toggle":"collapse",children:[{el:"span",class:"edit-icon fas fa-pen"}]}]},{el:"div",class:"origin-sentence",role:"button","data-toggle":"collapse",children:[{el:"span",class:"numbering-text",textContent:"3"},{el:"span",class:"sentence-text",textContent:""}]},{el:"div",class:"edit-section collapse mt-2",children:[{el:"textarea",class:"form-control mb-2",rows:"5",textContent:""},{el:"button",type:"button",class:"btn btn-outline-fico","data-toggle":"collapse",textContent:"취소"},{el:"button",type:"button",class:"js-edit btn btn-fico",disabled:!0,textContent:"수정"},{el:"span",class:"invalid-text text-danger",style:"display: none;",textContent:"영문이 아니거나 글자수가 너무 많습니다."}]}]}]},u=5e3,a=u.toLocaleString(),o=(new Date).format("yyyy-MM-dd");let h=localStorage.getItem("MFUSG");function s(){h.length>=u&&($(".js-open-add-sentence,.edit-icon-section").prop("disabled",!0),$(".origin-sentence").removeAttr("data-toggle"),g.children[0].children[0].children[2].disabled=!0,g.children[0].children[1].children[2].disabled=!0,delete g.children[0].children[2]["data-toggle"],h.confirmed||(alertModal(`일일 분석량<span class="text-red-700">(${a}자)</span>을 모두 <span class="text-red-700">소진</span>하여
문장을 <span class="text-red-700">추가 및 수정</span>할 수 없습니다.
문장을 <span class="text-blue-600">순서 이동 및 삭제</span>할 수 있습니다.`),h.confirmed=!0)),localStorage.setItem("MFUSG",btoa(JSON.stringify(h)))}function m(e){anime({targets:e,duration:1e3,easing:"linear",direction:"alternate",backgroundColor:"#ffc107"})}function p(){$(i).html($(c).sort((e,t)=>e.dataset.ordernum-t.dataset.ordernum).each((e,t)=>$(t).find(".numbering-text").text(e+1)))}function f(){var e=1500<=Array.from($(c+" .sentence-text").get(),e=>e.textContent).join("").length;$(".exceed-max-notice")[e?"slideDown":"slideUp"](100),$(".js-open-add-sentence")[e?"slideUp":"slideDown"](100)}h&&h.user==ntoa(t)?((h=JSON.parse(atob(localStorage.getItem("MFUSG")))).date!=o&&Object.assign(h,{date:o,length:0,confirmed:!0}),s()):(h={user:ntoa(t)},$.getJSON("/workbook/passage/usage",function(e){Object.assign(h,{date:o,length:e,confirmed:!1})}).fail(()=>{Object.assign(h,{date:o,length:0,confirmed:!1})}).always(s)),e.sort((e,t)=>e.orderNum-t.orderNum).forEach((e,t)=>{var n=createElement(g);n.dataset.ordernum=e.orderNum,n.dataset.sid=e.sentenceId,n.querySelector(".numbering-text").textContent=t+1,n.querySelector(".sentence-text").textContent=e.eng,n.querySelector(".edit-section textarea").textContent=e.eng,document.querySelector(i).appendChild(n)}),f(),$("#addPassageBtn").click(()=>location.assign("/workbook/passage/add/"+ntoa(n))),$("#viewPassageBtn").click(()=>location.assign(`/workbook/passage/${ntoa(n)}/`+ntoa(r))),$("#editWorkbookBtn").click(()=>location.assign("/workbook/mybook/edit/"+ntoa(n))),$(i).sortable({axis:"y",items:">"+c,handle:".js-move-sentence",classes:{"ui-sortable-helper":"shadow-lg"},cursor:"move",update:(e,t)=>{if(confirm("문장을 여기로 이동하겠습니까?")){var n=t.item.prev(c),a=t.item.next(c);if(0==a.length)t.item[0].dataset.ordernum=Number(n[0].dataset.ordernum)+1e3;else if(0==n.length){var o=Number(a[0].dataset.ordernum),s=Math.round(o/2);if(s==o)return alertModal("더이상 이동할 수 없습니다."),void $(i).sortable("cancel");t.item[0].dataset.ordernum=s}else{o=Number(n[0].dataset.ordernum),s=Number(a[0].dataset.ordernum),n=Math.round((o+s)/2);if(-1<[o,s].indexOf(n))return alertModal("더이상 이동할 수 없습니다."),void $(i).sortable("cancel");t.item[0].dataset.ordernum=n}a={sentenceId:Number(t.item.data("sid")),sameText:!0,passageId:r,eng:t.item.find(".sentence-text").text(),orderNum:Number(t.item[0].dataset.ordernum)};editPassageSentece(a,p)}else $(i).sortable("cancel")}}),$(".js-open-add-sentence").click(function(){$(this).add($(".add-section")).slideToggle(100,()=>$(".add-section textarea").focus())}),$(".js-cancel-add").click(function(){$(".add-section textarea").val("").trigger("input"),$(".add-section,.js-open-add-sentence").slideToggle(100)}),$(document).on("click",c+' [data-toggle="collapse"]',function(){$(this.closest(c)).find(".collapse").collapse("toggle")}),$(document).on("input",".edit-section textarea,.add-section textarea",function(){var e=$(this.closest(".edit-section,.add-section")),t=e.find(".js-edit,.js-add"),e=e.find(".invalid-text"),{input:n,arr:a,inputCursor:o}=extractHighlightInfo(this.value,this.selectionStart);0===n.length?(e.hide(),t.prop("disabled",!0)):500<n.length||n.includes("×")?(e.show(),this.value=n,$(this).highlightWithinTextarea({highlight:[{className:"bg-fc-yellow",highlight:["×"]},{className:"bg-fc-purple corrected",highlight:a}]}),this.setSelectionRange(o,o),this.focus(),t.prop("disabled",!0)):(e.hide(),t.prop("disabled",!1))}),$(".js-add").on("click",function(){var e=tokenizer.sentences($(".add-section textarea").val()),t=Number($(c+":last")[0]?.dataset?.ordernum||0)+1e3,n=Array.from(e,e=>e.replace(/^['"]?[^a-zA-Z]+\. (['"]?[A-Z])/,"$1").replace(/(['"])\s+\d+[?!.]$/,"$1")).filter(e=>/[a-zA-Z\s]/.test(e)),e=n.join(" ").capitalize1st();const a=$(".add-section textarea").get(0);a.value=e;let o=0;for(let t=0,e=n.length;t<e;t++){const l=n[t];var s=e=>{alertModal(t+1+`번째 ${e}
문장 내용은 아래와 같습니다.
`+l,()=>{a.focus(),a.setSelectionRange(o,o+l.length)})};if(500<l.length)return void s("문장의 길이가 너무 길어 AI가 더욱 힘들어 합니다.");if(!/^["'(]?[A-Z0-9]/.test(l))return void s(`문장의 시작이 영문대문자나 숫자 혹은 따옴표(" ')가 아닙니다.`);if(!new RegExp("[.?!][\"']?$").test(l))return void s(`문장의 끝이 구두점(. ? !)이나 따옴표(" ')가 아닙니다.`);o+=l.length+(t<e-1?1:0)}h.length<u&&h.length+e.length>=u&&(h.confirmed=!1,$(".js-open-add-sentence,.edit-icon-section").prop("disabled",!0),$(".origin-sentence").removeAttr("data-toggle"),g.children[0].children[0].children[2].disabled=!0,g.children[0].children[1].children[2].disabled=!0,delete g.children[0].children[2]["data-toggle"]),h.length+=e.length,localStorage.setItem("MFUSG",btoa(JSON.stringify(h)));e={sentenceId:0,passageId:r,eng:e,orderNum:t};$("#loadingModal").modal("show"),editPassageSentece(e,function(a){if($("#loadingModal").modal("hide"),0<a.length){let n=`아래와 같은 ${a.length}개의 문장이 추가되었습니다.`;$(".js-cancel-add").trigger("click");var o=document.querySelector(i),s=[];for(let e=0,t=a.length;e<t;e++){var l=a[e],d=createElement(g);d.querySelector(".sentence-text").textContent=l.eng,d.querySelector(".edit-section textarea").textContent=l.eng,d.dataset.sid=l.sentenceId,d.dataset.ordernum=l.orderNum,o.appendChild(d),n+=`
[${e+1}] `+l.eng,s.push(d)}p(),f(),alertModal(n),m(s)}},function(){alertModal("등록에 실패했습니다."),$("#loadingModal").modal("hide")})}),$(document).on("click",".js-edit",function(){const d=$(this.closest(c));var e,t=d.find(".sentence-text").text(),n=tokenizer.sentences(d.find(".edit-section textarea").val()),a=Array.from(n,e=>e.replace(/^['"]?[^a-zA-Z]+\. (['"]?[A-Z])/,"$1").replace(/(['"])\s+\d+[?!.]$/,"$1")).filter(e=>/[a-zA-Z\s]/.test(e)),n=a.join(" ").capitalize1st();const o=d.find(".edit-section textarea").get(0);o.value=n;let s=0;for(let t=0,e=a.length;t<e;t++){const i=a[t];var l=e=>{alertModal(t+1+`번째 ${e}
문장 내용은 아래와 같습니다.
`+i,()=>{o.focus(),o.setSelectionRange(s,s+i.length)})};if(500<i.length)return void l("문장의 길이가 너무 길어 AI가 더욱 힘들어 합니다.");if(!/^["'(]?[A-Z0-9]/.test(i))return void l(`문장의 시작이 영문대문자나 숫자 혹은 따옴표(" ')가 아닙니다.`);if(!new RegExp("[.?!][\"']?$").test(i))return void l(`문장의 끝이 구두점(. ? !)이나 따옴표(" ')가 아닙니다.`);s+=i.length+(t<e-1?1:0)}n==t?d.find(".collapse").collapse("toggle"):(e={sentenceId:Number(d[0].dataset.sid),passageId:r,eng:n,sameText:!1,orderNum:Number(d[0].dataset.ordernum)},h.length<u&&h.length+n.length>=u&&(h.confirmed=!1,$(".js-open-add-sentence,.edit-icon-section").prop("disabled",!0),$(".origin-sentence").removeAttr("data-toggle"),g.children[0].children[0].children[2].disabled=!0,g.children[0].children[1].children[2].disabled=!0,delete g.children[0].children[2]["data-toggle"]),h.length+=n.length,localStorage.setItem("MFUSG",btoa(JSON.stringify(h))),e.sameTextSeq=t.toLowerCase()==n.toLowerCase(),$("#loadingModal").modal("show"),editPassageSentece(e,function(l){if($("#loadingModal").modal("hide"),1<l.length){let s=`문장이 아래와 같이 ${l.length}개로 나뉘었습니다.`;d.find(".edit-section").one("hidden.bs.collapse",function(){d.hide(function(){var n=[];for(let e=0,t=l.length;e<t;e++){var a=l[e],o=d.clone();o.find(".sentence-text, textarea").text(a.eng),o[0].dataset.sid=a.sentenceId,o[0].dataset.ordernum=a.orderNum,d.before(o),s+=`
[${e+1}] `+a.eng,n.push(o[0])}d.remove(),$(c).slideDown(),p(),f(),alertModal(s),m(n)})}),d.find(".edit-section").collapse("hide")}else 1==l.length&&(alertModal("수정되었습니다."),d.find(".sentence-text").text(l[0].eng),d[0].dataset.sid=l[0].sentenceId,d.find(".edit-section textarea").val(l[0].eng),d.find(".edit-section").collapse("hide"),m(d[0]))},function(){alertModal("수정에 실패했습니다."),$("#loadingModal").modal("hide")}))}).on("click",".js-del-sentence",function(){if(confirm("문장을 삭제하시겠습니까?")){const e=$(this.closest(c));delPassageSentence({passageId:r,sentenceId:Number(e[0].dataset.sid)},function(){alertModal("문장이 삭제되었습니다."),e.slideUp(function(){$(this).remove(),p(),f()})})}})}
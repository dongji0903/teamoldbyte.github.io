function pageinit(){const l=Number(sessionStorage.getItem("editingPassageId")),o=Number(sessionStorage.getItem("workbookId"));$("#addPassageBtn").click(()=>location.assign("/workbook/passage/add/"+ntoa(o))),$("#viewPassageBtn").click(()=>location.assign("/workbook/passage/"+ntoa(o)+"/"+ntoa(l))),$("#editWorkbookBtn").click(()=>location.assign("/workbook/mybook/edit/"+ntoa(o))),$(".list-sentence-section").sortable({axis:"y",items:">.one-sentence-unit-section",handle:".js-move-sentence",classes:{"ui-sortable-helper":"shadow-lg"},cursor:"move",update:(e,t)=>{if(confirm("문장을 여기로 이동하겠습니까?")){var n=t.item.prev(".one-sentence-unit-section"),s=t.item.next(".one-sentence-unit-section");if(0==s.length)t.item[0].dataset.ordernum=Number(n[0].dataset.ordernum)+1e3;else if(0==n.length){var o=Number(s[0].dataset.ordernum),i=Math.round(o/2);if(i==o)return alert("더이상 이동할 수 없습니다."),void $(".list-sentence-section").sortable("cancel");t.item[0].dataset.ordernum=i}else{const a=Number(n[0].dataset.ordernum),d=Number(s[0].dataset.ordernum),c=Math.round((a+d)/2);if(-1<[a,d].indexOf(c))return alert("더이상 이동할 수 없습니다."),void $(".list-sentence-section").sortable("cancel");t.item[0].dataset.ordernum=c}o={sentenceId:Number(t.item.data("sid")),sameText:!0,passageId:l,eng:t.item.find(".sentence-text").text(),orderNum:Number(t.item[0].dataset.ordernum)};editPassageSentece(o,r)}else $(".list-sentence-section").sortable("cancel")}}),$(".js-open-add-sentence").click(function(){if(1500<=Array.from($(".one-sentence-unit-section .sentence-text").get(),e=>e.textContent).join("").length){if(!confirm("지문의 크기가 너무 커서 문장을 추가할 수 없습니다.\n새 지문으로 등록하시겠습니까?"))return;location.assign("/workbook/passage/add/"+ntoa(o))}$(this).add($(".add-section")).slideToggle(100,()=>$(".add-section textarea").focus())}),$(".js-cancel-add").click(function(){$(".add-section textarea").val("").trigger("input"),$(".add-section,.js-open-add-sentence").slideToggle(100)}),$(document).on("click",'.one-sentence-unit-section [data-toggle="collapse"]',function(){$(this.closest(".one-sentence-unit-section")).find(".collapse").collapse("toggle")});function r(){$(".list-sentence-section").html($(".one-sentence-unit-section").sort((e,t)=>e.dataset.ordernum-t.dataset.ordernum).each((e,t)=>$(t).find(".numbering-text").text(e+1)))}$(document).on("input",".edit-section textarea,.add-section textarea",function(){const e=$(this.closest(".edit-section,.add-section")),t=e.find(".js-edit,.js-add"),n=e.find(".invalid-text");let s=$(this).val().parseToSentences().join(" ").capitalize1st();0==s.length?(n.hide(),t.prop("disabled",!0)):0==s.length||500<s.length||s.match(/[^\u0020-\u007F\u0085\u00A0\u2028\u2029\u2018-\u201A\u201C-\u201D]/gi)?(n.show(),t.prop("disabled",!0)):e.is(".add-section")&&1500<=Array.from($(".one-sentence-unit-section .sentence-text").get(),e=>e.textContent).join("").length+s.length||e.is(".edit-section")&&1500<=Array.from($(`.one-sentence-unit-section:not(:eq(${e.closest(".one-sentence-unit-section").index(".one-sentence-unit-section")})) .sentence-text`).get(),e=>e.textContent).join("").length+s.length?confirm("지문의 크기가 너무 커서 문장을 추가할 수 없습니다.\n새 지문으로 등록하시겠습니까?")?location.assign("/workbook/passage/add/"+ntoa(o)):(n.show(),t.prop("disabled",!0)):(n.hide(),t.prop("disabled",!1))}),$(".js-add").click(function(){var e=$(".add-section textarea").val().parseToSentences().join(" ").capitalize1st(),t=Number($(".one-sentence-unit-section:last")[0].dataset.ordernum)+1e3,e={sentenceId:0,passageId:l,eng:e,orderNum:t};$("#loadingModal").modal("show"),editPassageSentece(e,function(s){if($("#loadingModal").modal("hide"),0<s.length){let n="아래와 같은 "+s.length+"개의 문장이 추가되었습니다.";$(".js-cancel-add").trigger("click");const i=$(".list-sentence-section");for(let e=0,t=s.length;e<t;e++){var o=s[e];const a=$(".one-sentence-unit-section:last").clone();a.find(".sentence-text, textarea").text(o.eng),a[0].dataset.sid=o.sentenceId,a[0].dataset.ordernum=o.orderNum,i.append(a),n+="\n["+(e+1)+"] "+o.eng}r(),alert(n)}},function(){alert("등록에 실패했습니다."),$("#loadingModal").modal("hide")})}),$(document).on("click",".js-edit",function(){const a=$(this.closest(".one-sentence-unit-section"));let e=a.find(".sentence-text").text(),t=a.find(".edit-section textarea").val().parseToSentences().join(" ").capitalize1st();if(!(0==t.length||500<t.length||t.match(/[^(\u0020-\u007F|\u000A|\u000C|\u000D|\u0085|\u00A0|\u2028|\u2029|\u2018-\u201A|\u201C-\u201D)]/gi)))if(t==e)a.find(".collapse").collapse("toggle");else{const n={sentenceId:Number(a[0].dataset.sid),passageId:l,eng:t,sameText:!1,orderNum:Number(a[0].dataset.ordernum)};e.toLowerCase().replace(/\s/g,"")==t.toLowerCase().replace(/\s/g,"")?n.sameTextSeq=!0:n.sameTextSeq=!1,$("#loadingModal").modal("show"),editPassageSentece(n,function(i){if($("#loadingModal").modal("hide"),1<i.length){let o="문장이 아래와 같이 "+i.length+"개로 나뉘었습니다.";a.find(".edit-section").one("hidden.bs.collapse",function(){a.hide(function(){for(let e=0,t=i.length;e<t;e++){var n=i[e];const s=a.clone();s.find(".sentence-text, textarea").text(n.eng),s[0].dataset.sid=n.sentenceId,s[0].dataset.ordernum=n.orderNum,a.before(s),o+="\n["+(e+1)+"] "+n.eng}a.remove(),$(".one-sentence-unit-section").slideDown(),r(),alert(o)})}),a.find(".edit-section").collapse("hide")}else 1==i.length&&(alert("수정되었습니다."),a.find(".sentence-text").text(i[0].eng),a[0].dataset.sid=i[0].sentenceId,a.find(".edit-section textarea").val(i[0].eng),a.find(".edit-section").collapse("hide"))},function(){alert("수정에 실패했습니다."),$("#loadingModal").modal("hide")})}}).on("click",".js-del-sentence",function(){if(confirm("문장을 삭제하시겠습니까?")){const e=$(this.closest(".one-sentence-unit-section"));delPassageSentence({passageId:l,sentenceId:Number(e[0].dataset.sid)},function(){alert("문장이 삭제되었습니다."),e.slideUp(function(){$(this).remove(),r()})})}})}
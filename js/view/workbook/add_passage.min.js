function pageinit(r,e){$("#loadingModal").modal("hide");const d={itemSelector:".passage",columnWidth:".passage",gutter:10,percentPosition:!0,transitionDuration:"0.8s"},t=5e3.toLocaleString();var a=(new Date).format("yyyy-MM-dd");const p="MFUSG";var s=localStorage.getItem(p);let g=s?JSON.parse(atob(s)):{};function n(){5e3<=g.length&&($("#inputComplete, .ocr-btn").prop("disabled",!0),$("#newPassageText").prop("disabled",!0).addClass("form-control").attr("placeholder",`일일 분석량(${t}자)을 모두 소진했습니다. 내일 다시 찾아와 주세요.`),alertModal(`일일 분석량<span class="text-red-700">(${t}자)</span>을 모두 <span class="text-red-700">소진</span>했습니다.
내일 다시 찾아와 주세요.`)),localStorage.setItem(p,btoa(JSON.stringify(g)))}"MeaiWcUUcUUWSiQgSaUg"!=ntoa(e)&&g.user==ntoa(e)&&g.date==a?n():(g={user:ntoa(e),date:a,length:0},$.getJSON("/workbook/passage/usage").done(e=>Object.assign(g,{length:e})).always(()=>n())),$("[class^=step-] .title-section").click(function(){$("[class^=step-] .collapse").not($(this).closest("[class^=step-]").find(".collapse").collapse("show")).collapse("hide")}),r&&(sessionStorage.setItem("workbookCover","https://static.findsvoc.com/images/app/workbook/bookcover/hellobook_cover.jpeg"),new bootstrap.Tooltip(document.querySelector(".ocr-btn"),{trigger:"hover focus"}).enable());let l="",u=!1,i={};s=$("#newPassageText").autocomplete({position:{my:"left+10 top-10"},delay:300,search:function(e){var t=this.value.sentenceNormalize(),a=t.length;return!(a<5||a>o||t.match(invalidEnglishRegex)||l==tokenizer.sentences(t)[0])},source:(e,t)=>{(l=tokenizer.sentences(e.term.sentenceNormalize())[0])in i?t(i[l]):$.getJSON("/sentence/search",{eng:l},e=>{u=0<e.length;e=Array.from(e,e=>e.eng);i[l]=e,t(e)}).fail(()=>{u=!1,i[l]=[],t([])})},focus:(e,t)=>!1,close:function(e,t){var a=this.value.trim().length;$(".demo-counter").text(a+"/"+o),$(".reset-textarea").toggle(0<a)},change:function(e,t){r&&null!=t.item&&(this.value=t.item.value,t=t.item.value.length,$(".demo-counter").text(t+"/"+o),$(".reset-textarea").toggle(0<t))},select:function(e,t){if(!r)return confirm("선택한 문장으로 지문을 검색하시겠습니까?")&&$("#searchBtn").trigger("click",t.item.value),!1}}).autocomplete("instance");s._renderItem=function(e,t){var a=$("<li>");return t.disabled&&a.addClass("ui-state-disabled"),a.append(("<div>"+t.label+"</div>").replace(l,'<span class="bg-fc-yellow">$&</span>')),a.appendTo(e)},s._resizeMenu=function(e,t){this.menu.element.outerWidth($("#newPassageText").innerWidth())};let o=r?300:1e3,c;if($(document).on("input","#newPassageText",function(e,t){var a=function(){var e=$("#newPassageText").val(),t=$("#newPassageText")[0].selectionStart;e=extractHighlightInfo(e,t);return $("#newPassageText").val(e.input),$("#newPassageText").highlightWithinTextarea({highlight:[{className:"bg-fc-yellow",highlight:["×"]},{className:"bg-fc-purple corrected",highlight:e.arr}]}),$("#newPassageText").focus()[0].setSelectionRange(e.inputCursor,e.inputCursor),[e.input.includes("×"),0<e.arr.length]}(),s=this.value.trim().quoteNormalize().length;$(".demo-counter").text(s+"/"+o),$(".reset-textarea").toggle(0<s),$(".invalid-input-warning").toggle(a[0]),$(".corrected-input-info").toggle(a[1]),anime({targets:".hwt-backdrop mark.corrected",keyframes:[{opacity:0,easing:"linear"},{opacity:1,easing:"linear"},{opacity:0,easing:"linear"},{opacity:1,easing:"linear"},{opacity:0,duration:1e3,easing:"cubicBezier(.7, .0, 1.0, 0.3)"},{display:"none",easing:"steps(1)"}]}),s<o&&!a[0]?($("#inputComplete").attr("disabled",0==s),c?.hide(),c?.disable(),$(this).trigger("keydown")):((c=c||new bootstrap.Tooltip(this,{title:`영어 문장을 ${o}자 이내로 입력하세요.`,trigger:"manual",customClass:"text-invalid",offset:({placement:e})=>"top"==e?[100,0]:[0,0]})).enable(),c.show(),$("#inputComplete").attr("disabled",!0))}),!r){const h=new FicoOCR;$("#ocrFile").on("input",function(){var e=this.files[0];if(null==e||0==e.size)return alertModal("선택된 사진이 없습니다.\n앨범에서 사진을 선택해 주세요."),!1;h.readAsPreview(e,e=>{var t=document.getElementById("newPassageText");t.value=e,t.scrollTop=0,t.setSelectionRange(0,0),t.focus(),$(t).trigger("input")},()=>alertModal("이미지 인식에 실패했습니다. 입력창에 문장 수동 입력을 해주세요.")),this.value=""}),$(".demo-counter").one("click",function(){o+=500,c?.disable(),c=null,$("#newPassageText").trigger("input")}),30<=JSON.parse(sessionStorage.getItem("passageIdList"))?.length&&(alertModal("워크북의 지문 수가 최대 30개에 도달했습니다.\n새 워크북 등록 화면으로 이동합니다."),location.assign("/workbook/mybook/add"))}$("#inputComplete").click(async function(){var e=document.getElementById("newPassageText"),e=tokenizer.sentences(e.value.sentenceNormalize());(r||1!=e.length?$("#beforeSubmitModal"):(0==$("#askMoreSentenceModal").length&&document.body.appendChild(createElement({el:"div",id:"askMoreSentenceModal",class:"warning-modal modal fade",children:[{el:"div",class:"modal-dialog modal-md modal-dialog-centered",children:[{el:"div",class:"modal-content",children:[{el:"div",class:"modal-header text-center bg-fc-purple mx-auto w-100",children:[{el:"span",className:"text-white d-block w-100",children:["여러 문장을 등록하여 ",{el:"b",class:"text-fc-yellow",textContent:"지문을 관리"},"해 보세요."]}]},{el:"div",class:"modal-body row g-0",children:[{el:"div",class:"logo-section col-6 col-md-3 m-auto pe-md-2 text-center",children:[{el:"img",class:"logo",alt:"logo",src:"https://static.findsvoc.com/images/logo/main_logo_character_anim.svg"}]},{el:"div",class:"text-section my-auto pt-2 pt-md-0 ps-md-2 col-md-9",children:[{el:"p",className:"mb-2",children:["워크북은 사용자에게 학습 응집성을 제공하기 위해 문장을 ",{el:"b",class:"text-fc-red",textContent:"지문단위로 관리"},"합니다."]},{el:"p",className:"mb-2",children:["학습목적이나 주제에 맞는 문장들을 미리 준비하여 ",{el:"b",class:"text-fc-red",textContent:"한번에 등록"},"하는 것을 추천드립니다."]},{el:"p",className:"mb-2",children:["워크북을 자신의 ",{el:"b",class:"text-fc-red",textContent:"학습 자산"},"으로 만들어 보세요."]},{el:"p",className:"mb-4",children:[{el:"span",class:"app-name-text",textContent:"fico"},"가 그 가치를 성장시켜 드리겠습니다."]},{el:"span",className:"text-sm text-bluegray-400",textContent:"관리가 불필요한 한 두문장 등록은 헬로북에서도 가능합니다."}]}]},{el:"div",className:"modal-footer py-0",children:[{el:"div",className:"text-center w-100",children:[{el:"button",type:"button",className:"btn btn-fico me-0 w-50","data-bs-dismiss":"modal",textContent:"예(문장 추가 입력)"},{el:"button",type:"button",id:"goOnSearch",className:"btn btn-outline-fico w-50","data-bs-dismiss":"modal",textContent:"아니오(그대로 분석)",onclick:()=>$("#beforeSubmitModal").modal("show")}]}]}]}]}]})),$("#askMoreSentenceModal"))).modal("show")}),$(document).on("input",".divided-sentence :text",function(){var e=this.value.trim().quoteNormalize();1!=/^["']?[A-Z0-9]+/.test(e)?($(this).siblings(".invalid-tooltip").text("문장의 시작은 영문대문자, 숫자 혹은 따옴표(\" ')여야 합니다."),$(this).addClass("is-invalid")):new RegExp("[.?!][\"']?$").test(e)?$(this).removeClass("is-invalid"):($(this).siblings(".invalid-tooltip").text("문장의 끝은 구두점(. ? !) 혹은 따옴표(\" ')여야 합니다."),$(this).addClass("is-invalid")),$("#addBtn").prop("disabled",0<$("#passageForm .is-invalid").length)}).on("click",".js-delete-sentence-btn",function(){confirm("삭제하시겠습니까?")&&$(this).closest(".divided-sentence").fadeOut(function(){var e=$(this).siblings(".divided-sentence").last();$(this).remove(),e.find(":text").trigger("input")})}).on("click",".js-insert-sentence-btn",async function(){var e=$("#hiddenDivs .divided-sentence").clone();$(this).closest(".divided-sentence").after(e),await sleep(100),e.fadeIn().find(":text").trigger("input")}),$("#searchBtn").click(async function(e,t){const n=document.getElementById("newPassageText");var a=tokenizer.sentences(n.value.sentenceNormalize());if(r){var s=$("#dividedResult").empty();for(let e=0,t=a.length;e<t;e++){var l=$("#hiddenDivs .divided-sentence").clone();l.appendTo(s),await sleep(100),l.fadeIn().find(":text").val(a[e]).trigger("input")}$("#beforeInput").addClass("opacity-50 pe-none"),$(".before-msg").hide(),$("#afterInput").removeClass("d-none opacity-50 pe-none")}else{const c=Array.from(a,e=>e.replace(/^['"]?[^a-zA-Z]+\. (['"]?[A-Z])/,"$1").replace(/(['"])\s+\d+[?!.]$/,"$1")).filter(e=>/[a-zA-Z\s]/.test(e));let s=c[0];if(n.value=c.join(" "),null!=t)s=t;else{let a=0;for(let t=0,e=c.length;t<e;t++){const o=c[t];var i=e=>{alertModal(t+1+`번째 ${e}
문장 내용은 아래와 같습니다.
`+o,()=>{n.focus(),n.setSelectionRange(a,a+o.length)})};if(500<o.length)return void i("문장의 길이가 너무 길어 AI가 더욱 힘들어 합니다.");if(!/^["'(]?[A-Z0-9]/.test(o))return void i(`문장의 시작이 영문대문자나 숫자 혹은 따옴표(" ')가 아닙니다.`);if(!new RegExp("[.?!][\"']?$").test(o))return void i(`문장의 끝이 구두점(. ? !)이나 따옴표(" ')가 아닙니다.`);s=o.length>s.length?o:s,a+=o.length+(t<e-1?1:0)}if(u)return $("#text").val(n.value),$(".search-result-section .list-group-item").removeClass("active"),$(".step-2").addClass("opacity-50 pe-none"),$(".step-3").removeClass("opacity-50 pe-none"),$(".step-1 .collapse,.step-3 .collapse").collapse("toggle"),$("#editPassage, .edit-passage").hide(),void $(".final-pssage").show()}$(".search-sentence").text(s),$.getJSON("/workbook/passage/search",{eng:s},function(e){const a=e.passageDtoList,s=e.sentenceDtoList,n=$(".passage-result").empty();n.data("masonry")&&n.masonry("destroy");for(let e=0,t=a.length;e<t;e++){var l=$("#hiddenDivs .list-group-item").clone(),i=a[e];l.data("passageId",a[e].passageId).html(i.text.replaceAll(new RegExp(c.join("|").replaceAll(/[\(\)\{\}\[\]]/gm,"\\$&"),"gm"),'<span class="bg-fc-yellow">$&</span>')),n.append(l)}if(1==c.length)for(let e=0,t=s.length;e<t;e++){var o=$("#hiddenDivs .list-group-item").clone();o.data("sentenceId",s[e].sentenceId).html(s[e].eng.replace(c,`<span class="bg-fc-yellow">${c}</span>`)),n.append(o)}1<c.length&&0==a.length||1==c.length&&0==s.length?n.append('<li class="list-group-item pe-none">검색 결과가 없습니다.</li>'):n.append($("#jumpTo3").clone(!0,!0));$(".step-2").removeClass("opacity-50 pe-none"),$(".step-2 .collapse").one("shown.bs.collapse",function(){1<c.length&&0==a.length||1==c.length&&0==s.length?$("#jumpTo3").click():n.masonry(d)}),$(".step-1 .collapse, .step-2 .collapse").collapse("toggle")}).fail(()=>alertModal("검색을 할 수 없습니다. 페이지 새로고침 후 다시 시도해 주세요."))}}),$("#passageForm").on("reset",function(){$("#inputComplete").prop("disabled",!0),r?($("#dividedResult").empty(),$("#afterInput").addClass("opacity-50 pe-none"),$("#beforeInput").removeClass("opacity-50 pe-none")):($(".step-2 .collapse,.step-3 .collapse").collapse("hide"),$(".step-1 .collapse").collapse("show"),$(".step-1").removeClass("opacity-50 pe-none"),$(".step-2, .step-3").addClass("opacity-50 pe-none")),$("#newPassageText").val("").prop("disabled",!1).trigger("input").focus()});let m;r||($("#jumpTo3").click(function(){$("#text").val($("#newPassageText").val()),$(".search-result-section .list-group-item").removeClass("active"),$(".step-2,.step-3").removeClass("opacity-50 pe-none"),$(".step-2 .collapse,.step-3 .collapse").collapse("toggle"),$("#editPassage, .edit-passage").hide(),$(".final-pssage").show()}),$(".step-2 .collapse:eq(0)").on("shown.bs.collapse hidden.bs.collapse",function(e){$("#jumpTo3").fadeToggle()}),$(document).on("click",".search-result-section .list-group-item",function(){$(".search-result-section .list-group-item").not(this).removeClass("active"),$(this).addClass("active"),$("#text").val($(this).text()),$(".step-2,.step-3").removeClass("opacity-50 pe-none"),$(".step-2 .collapse,.step-3 .collapse").collapse("toggle"),$("#editPassage, .final-passage").show(),$(".edit-passage").hide()}),$(".step-3 .collapse:eq(0)").on("shown.bs.collapse",async function(){u=!1;let e=0;for(;e!=$("#text")[0].scrollHeight;)e=$("#text")[0].scrollHeight,await sleep(50),$("#text").css("height",e+"px")}),$("#editPassage").click(function(){var e,t=$(".search-result-section .list-group-item.active");async function a(a){$(".final-passage").hide();var s=$(".edit-passage").show().find(".sentence-list").empty();for(let e=0,t=a.length;e<t;e++){var n=$("#hiddenDivs .divided-sentence").clone();n.appendTo(s),await sleep(100),n.data("sentenceId",a[e].sentenceId).data("orgData",a[e].eng).fadeIn().find(":text").val(a[e].eng).trigger("input")}}t.data("passageId")?(e=t.data("passageId"),$.getJSON("/workbook/passage/sentences/edit/"+e,a).fail(()=>alertModal("지문을 편집할 수 없습니다."))):t.data("sentenceId")&&(e=t.data("sentenceId"),a([{eng:t.text(),sentenceId:e}]))}),$("#cancelEdit").click(function(){$(".final-passage, .edit-passage").toggle()}),null!=(m=localStorage.getItem("PassageTagHistory"))?(m=JSON.parse(decodeURI(m)),$("#taghistory").get(0).appendChild(createElement(Array.from(m,e=>({el:"option",textContent:e}))))):m=[]),$("#addBtn").on("click",function(){const s=$("#passageForm");let n=0;if(r){var a=$("#dividedResult :text");const t=[];a.each(function(){var e=this.value.trim().sentenceNormalize();t.push(e),n+=e.length}),createHidden(s,"text",t.join("\n"))}else{0==$("#title").val().length&&$("#title").removeAttr("name");let t=!1;a=$(".search-result-section .list-group-item.active");if(0<a.length){var l=a.data("passageId"),i=a.data("sentenceId");if($(".edit-passage").is(":visible")){var o=$(".edit-passage .divided-sentence");const c=o.filter(function(){return $(this).data("orgData")!=$(this).find(":text").val().trim().sentenceNormalize()});let e=[];o.each(function(){e.push($(this).find(":text").val().trim())}),a.text()!=e.join(" ")?(s[0].action="/workbook/passage/new",o.each(function(e,t){var a;$(t).is(c)?(a=$(t).find(":text").val().trim().sentenceNormalize(),n+=a.length,createHidden(s,`existingSentenceList[${e}].eng`,a)):createHidden(s,`existingSentenceList[${e}].sentenceId`,$(t).data("sentenceId"))}),t=!0):(s.find("#text").prop("disabled",!0),null!=l?(s[0].action="/workbook/passage/add",createHidden(s,"existingPassageId",l)):(s[0].action="/workbook/passage/new",createHidden(s,"existingSentenceList[0].sentenceId",i)))}else null!=l?(s[0].action="/workbook/passage/add",createHidden(s,"existingPassageId",l),s.find("#text").prop("disabled",!0)):null!=i&&(s[0].action="/workbook/passage/new",createHidden(s,"existingSentenceList[0].sentenceId",i),s.find("#text").prop("disabled",!0));createHidden(s,"dirty",t)}else tokenizer.sentences(s.find("#text").val().trim().sentenceNormalize()).forEach(e=>{n+=e.length});a=$("#tag").val().trim();0<a.length&&!m.includes(a)&&(m.push(a),localStorage.setItem("PassageTagHistory",encodeURI(JSON.stringify(m))))}g.length+=n,localStorage.setItem(p,btoa(JSON.stringify(g))),s.submit()}),$("#passageForm").on("submit",()=>$("#loadingModal").modal("show"))}
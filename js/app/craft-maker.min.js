!function e(q,E,O){if(q.cachedScript=q.cachedScript||function(e,t){return q.ajax(q.extend(t||{},{dataType:"script",cache:!0,url:e}))},"undefined"==typeof createElement)q.cachedScript("https://static.findsvoc.com/js/util/DOM-util.min.js",{success:()=>e(q,E,O)});else{let u,v={},n=[],r=[],s=[],y=[],m={step:[{bbid:10000001,title:"단계별 배틀"}]},k,x,l=0,N;const D="data-battle-type",P="(코멘트 없음)";let p=[],h=[],S=(q.getJSON("https://static.findsvoc.com/data/craft/maker-toolbar.json",e=>{v=e,u=createElement(e.craftPanel),n=e.battleAsks,r=e.battleTypeInfos,s=e.commonEditorBtns}),{}),C={},w={},c=createElement({el:"div",className:"btn-toolbar row col-md-3",role:"toolbar"});q(O).on("click",".battle-type-section .btn, .battle-diffLevel-section .btn, .battle-category-section select",function(){let l={};var e=this.closest(".add-battle-section");let n=e.querySelector(".battles-counter-section"),o;n||(n=createElement(v.battleCounterPanel),q.getJSON("/craft/battle/stats/total",e=>{n.querySelector(".counter-total").textContent=e+"건"}).fail(()=>alertModal("전체 배틀 갯수를 조회할 수 없습니다.")),e.querySelector(".battle-type-section").before(n)),l=this.matches(".battle-type-section .btn")?(o="type",{battleType:O.getElementById(this.htmlFor).value}):this.matches(".battle-diffLevel-section .btn")?(o="level",{diffLevel:J(O.getElementById(this.htmlFor).value,e.querySelector(".battle-context").textContent.trim().length)}):(o="gc",{categoryId:parseInt(this.value)}),q.getJSON("/craft/battle/stats/"+o,l,function(e){let t;switch(o){case"type":(t=n.querySelector(".counter-same-type")).replaceChildren(createElement(Array.from(e,(e,t)=>[{el:"label",className:"bg-fc-yellow col-auto ms-2 rounded-pill",textContent:"#"+(t+1)},{el:"span",className:"col-auto ps-1 pe-0",textContent:e+"건"}])));break;case"level":(t=n.querySelector(".counter-same-difflevel")).replaceChildren(createElement([{el:"span",className:"col-auto",textContent:l.diffLevel+`: ${e}건`}]));break;case"gc":(t=n.querySelector(".counter-same-category")).replaceChildren(createElement({el:"span",className:"col-auto",textContent:y.find(e=>e.cid==l.categoryId).title+`: ${e}건`}))}null!=q.fn.bounce&&q(t).bounce()}).fail(()=>alertModal("배틀 갯수 조회에 실패했습니다."))}).on("change",".select-book-type",function(){const t=this.value;var e=q(this).closest(".add-battle-section");const l=e.find(".select-book");if("new"==this.value){if(q.cachedScript("https://cdn.jsdelivr.net/npm/compressorjs/dist/compressor.min.js",{success:()=>Compressor.setDefaults({quality:.8,width:210,height:315,maxWidth:210,maxHeight:315,resize:"cover"})}),e.find(".battle-book-section,.add-book-section").collapse("toggle"),l.empty(),this.value="",!q(this).data("bookPanelOpened")){e=e.find(".add-book-section");openSummernote(e.find(".input-book-desc"));const o="_"+(new Date).getTime();e.find('input[type="radio"]').each(function(){this.name+=o,this.id+=o}),e.find("label[for]").each(function(){this.htmlFor+=o}),q(this).data("bookPanelOpened",!0)}}else m[t]?n():q.getJSON(`/craft/battlebook/my/${this.value}/list`,e=>{m[t]=e,n()});function n(){l[0].replaceChildren(createElement(Array.from(m[t],e=>({el:"option",value:e.battleBookId,textContent:e.title||"제목 없음"}))))}}).on("click",".js-edit-battlebook-cover",function(e){q(this).find(".input-book-cover").trigger("click")}).on("click",".input-book-cover",function(e){e.stopPropagation()}).on("change",".input-book-cover",function(e){const t=q(this).closest(".add-book-section").find(".battlebook-cover-preview");let l=e.target.files[0];if(null==l)return!1;const n=new FileReader;n.onload=function(){t.css("background-image",`url(${this.result})`).css("opacity","1"),URL.revokeObjectURL(n.result),t.siblings(".js-cancel-battlebook-cover").show()},new Compressor(l,{success(e){n.readAsDataURL(e)},error(e){n.readAsDataURL(l)}})}).on("click",".js-cancel-battlebook-cover",function(e){e.preventDefault(),e.stopPropagation(),q(this).closest(".add-book-section").find(".battlebook-cover-preview").css("background-image","").siblings(".input-book-cover").val(null)[0].checkValidity(),q(this).hide()}).on("click",".js-cancel-add-book",function(){q(this).closest(".add-battle-section").find(".battle-book-section,.add-book-section").collapse("toggle")}).on("click",".js-add-battlebook",function(){const t=q(this).closest(".add-book-section");var e=t.find(".input-book-cover")[0];const l={T:"theme",G:"grammar"}[t.find(".input-book-type:checked").val().toUpperCase()];let n=new FormData(t[0]);if(t[0].checkValidity()){const a=[];function o(){q.ajax({type:"POST",url:"/craft/battlebook/add",data:n,processData:!1,contentType:!1,success:function(e){(alertModal||alert)("배틀북을 등록했습니다."),m[l]&&m[l].push(Object.assign({battleBookId:e.bbid},e)),t.closest(".add-battle-section").find(".select-book-type").val(l).trigger("change"),t.add(t.prev()).collapse("toggle"),t[0].reset(),t.find('.input-book-type[value="T"]').prop("checked",!0),t.find('.input-open-type[value="R"]').prop("checked",!0),t.find(".input-book-price").val(0),t.find(".battlebook-cover-preview").css("background-image",""),t.find(".input-book-desc").summernote("reset")},error:function(){(alertModal||alert)("배틀북 등록에 실패했습니다.")}})}n.forEach((e,t)=>{t.match(/_\d+/)&&(n.append(t.replace(/_\d+/,""),e),a.push(t))}),a.forEach(e=>n.delete(e)),n.append("ownerId",N),n.delete("files"),e.value?new Compressor(e.files[0],{success(e){n.delete("coverImage"),n.append("coverImage",e,e.name),o()},error(e){o()}}):(n.delete("coverImage"),o())}}).on("change",".battle-type-section input[type=radio]",function(){var e=q(this).closest(".battle-section-panel").data("semantics");b(this.closest(".add-battle-section").querySelector(".craft-maker-container"),e,parseInt(this.value))}).on("change",".ask-select",function(){var e=this.closest(".add-battle-section"),t=this.querySelector("option:checked"),l=t.dataset.tag,n=e.querySelector(".askTag"),n=(n.value=l||"",e.querySelector(".battle-type-section input:checked").value);"2"==n&&(t.value.includes("의 피수식")||t.value.includes("의 수식"))&&(l=t.value.includes("의 피수식")?"피수식":"수식",e=t.value.replace("의 "+l,""),null!=(n=prompt(`???의 ${l}어를 고르세요.
???에 들어갈 단어를 입력하세요.`,e))&&0<n.length?(t.value=n+"의 "+l,t.innerHTML=`(지정)${n}의 ${l}어를 선택하세요.`):t.selected=!1)}).on("change",".battle-category-section select",function(){this.closest(".add-battle-section").querySelector(".askTag").value=w[parseInt(this.value)]||""}).on("change",".battle-maker [role=toolbar] [type=checkbox]",function(){this.checked&&(this.closest("[role=toolbar]").querySelectorAll("[type=checkbox]:checked").forEach(e=>{0!=this.compareDocumentPosition(e)&&(e.checked=!1)}),getSelection().isCollapsed||f(this.closest(".battle-maker")))}).on("click",".battle-context *",function(){this.closest(".battle-maker")&&("SPAN"==this.nodeName?(7==this.closest(".add-battle-section").querySelector(".battle-type-section .btn-check:checked").value&&(this.closest(".battle-maker").querySelector(".select-kor .custom-trans").remove(),this.closest(".battle-maker").querySelector(".select-kor").classList.remove("pe-none")),this.outerHTML=this.innerHTML):this.remove())}).on("click",".battle-maker [value=undo], .battle-maker [value=redo]",function(){var e="undo"==this.value,t=(e?p:h).pop(),l=this.closest(".battle-maker"),n=l.querySelector(".battle-context");(e?h:p).push(n.innerHTML),n.innerHTML=t,q(n).animate({opacity:.5},100).animate({opacity:1},100),l.querySelector("[value=undo]").disabled=0==p.length,l.querySelector("[value=redo]").disabled=0==h.length}).on("keyup",function(e){var t=e.target.closest(".battle-maker");t&&(e.ctrlKey&&"Z"==e.key.toUpperCase()?q(t).find("[value=undo]").trigger("click"):e.ctrlKey&&"Y"==e.key.toUpperCase()&&q(t).find("[value=redo]").trigger("click"))}).on("input change",".add-battle-section :input,.add-battle-section textarea",function(){q(this.closest(".add-battle-section")).find(".js-add-battle").prop("disabled",!1)}).on("change",".select-kor",function(){this.closest(".add-battle-section").querySelector(".kor-answer")&&(this.closest(".add-battle-section").querySelector(".kor-answer").value=this.value)}).on("click",".js-add-battle",function(){const a=this.closest(".add-battle-section"),s=parseInt(a.querySelector(".select-book").value);if(Number.isNaN(s))alertModal("❗배틀북을 선택해 주세요.");else{const r=a.closest(".battle-section-panel"),i=a.querySelector(".battle-context"),d=parseInt(a.querySelector(".battle-category-section select").value),u=a.querySelector(".battle-type-section input:checked").value;var e=a.querySelector(".battle-diffLevel-section input:checked").value,t=a.querySelector(".ask-select").value.trim();const m=a.querySelector(".askTag").value.trim();var l=a.querySelector(".comment").value.trim();const p=a.querySelector(".source").value.trim();var n=i.textContent.trim().length;if(1500<l.length)alertModal("배틀 해설의 길이가 너무 깁니다.");else{const h={battleBookId:s,categoryId:d,battleType:u,ask:t,askTag:m,comment:l,source:p,diffLevel:e,engLength:n,sentenceId:q(r).data("sentenceId"),memberId:N,example:"",answer:"",diffSpecificLevel:J(e,n)};switch(u){case"1":var[o,c]=[M(i,".answer, .option"),M(i,".answer")];if(0==c.length)return void alertModal("문제로 만들 어구를 선택해 주세요.");if(o.length==c.length)return void alertModal("오답 보기를 선택해 주세요.");Object.assign(h,{example:JSON.stringify(o),answer:JSON.stringify(c)});break;case"2":o=M(i,".modifier"),c=M(i,".modificand");if(t.includes("모든 피수식")&&(0<o.length||0==c.length))return void alertModal("피수식어만 1개 이상 선택해 주세요.");if(t.includes("모든 수식")&&(0<c.length||0==o.length))return void alertModal("수식어만 1개 이상 선택해 주세요.");if(!t.includes("모든")&&0==(o.length&&c.length))return void alertModal("수식어/피수식어를 1쌍 이상 선택해 주세요.");h.answer=JSON.stringify([o,c]);break;case"3":o=i.querySelector(".pick-right");if(!o)return void alertModal("문제로 만들 어구를 선택해 주세요.");h.example=JSON.stringify([M(i,".pick-right")[0],o.textContent.trim(),o.dataset.wrong.trim()]),h.answer=JSON.stringify([o.textContent.trim()]);break;case"4":c=i.querySelector(".answer-wrong");if(null==i.querySelector(".option"))return void alertModal("보기 어구를 선택해 주세요.");h.example=JSON.stringify(M(i,".option, .answer-wrong")),h.answer=JSON.stringify([M(i,".answer-wrong")[0],c.textContent.trim(),c.dataset.wrong.trim()]);break;case"5":if(0==i.querySelectorAll(".option").length)return void alertModal("보기를 추가해 주세요.");h.ask=a.querySelector(".select-kor").value,h.example=JSON.stringify(M(i,".option"));break;case"6":{if(null==i.querySelector(".fill-right"))return void alertModal("문제로 만들 어구를 선택해 주세요.");const b=i.querySelectorAll(".fill-right");h.ask=a.querySelector(".select-kor").value,h.example=JSON.stringify(Array.from(M(i,".fill-right"),(e,t)=>[e,b[t].textContent.trim()]));break}case"7":{0<i.querySelectorAll(".option").length?h.ask=JSON.stringify(M(i,".option")):h.ask=JSON.stringify([[0,n]]);const f=a.querySelector(".kor-answer");if(!f.value)return void alertModal("정답 해석을 입력해 주세요.",()=>f.focus());h.answer=JSON.stringify(a.querySelector(".kor-answer").value.trim().split(/\s*\/\s*/)),h.example=JSON.stringify(a.querySelector(".battle-opt-ext").value.trim().split(/\s*\/\s*/));break}case"8":{o=i.querySelector(".pick-right");const g=a.querySelector(".battle-opt-ext");if(!o)return void alertModal("문제로 만들 어구를 선택해 주세요.");if(!g.value.trim().split(/\s*\/\s*/).join(""))return void alertModal("오답 보기를 입력해 주세요.",()=>g.focus());h.example=JSON.stringify([M(i,".pick-right")[0],o.textContent.trim(),g.value.trim().split(/\s*\/\s*/)]),h.answer=JSON.stringify([o.textContent.trim()]);break}}q.ajax({url:"/craft/battle/add",type:"POST",contentType:"application/json",data:JSON.stringify(h),success:function(e){A(m,S),A(p,C),w[d]=m,a.querySelector(".select-kor .custom-trans")&&(a.querySelector(".select-kor .custom-trans").remove(),a.querySelector(".select-kor").classList.remove("pe-none")),O.getElementById("craftResultModal")||O.body.appendChild(createElement(v.addResultModal)),q(a).find("textarea.comment").summernote("reset"),q("#craftResultModal .battle-id").text(e.battleId),q("#craftResultModal .group-count").text(e.groupCount),k={type:a.querySelector(".select-book-type").value,bookId:s},!x&&0<h.source.length&&E.location.pathname.startsWith("/workbook/passage")&&(x=h.source),i.replaceChildren(i.textContent),h.battleId=e.battleId,h.grammarTitle=y.find(e=>e.cid==d).title;var e=r.querySelector(".existing-battles-section"),t=j(q(r).data("eng"),h);let l=e.querySelector(`[${D}="${u}"]`),n;l?(o=l.querySelector(".battle-count"),l.appendChild(createElement({el:"span",class:"badge bg-danger",textContent:"New"})),o.textContent=parseInt(o.textContent)+1,n=O.querySelector(l.dataset.bsTarget)):(e.querySelector(`[${D}]`)||e.replaceChildren(),o=Date.now()+1,[l,n]=T(u,1,o,[]),l=createElement(l),n=createElement(n),e.append(l),q(l).css("height",0).animate({height:"100%"},500,function(){this.style.height="auto"}),l.appendChild(createElement({el:"span",class:"badge bg-danger",textContent:"New"})),e.append(n));var o=createElement(t);q(o).find(".js-delete-battle").after(createElement({el:"span",class:"badge bg-danger",textContent:"New"})),n.append(o),q(o).css("display","none").slideDown(),q("#craftResultModal").modal("show").on("hidden.bs.modal",()=>{l.scrollIntoView({behavior:"instant",block:"nearest"})})},error:function(e){alertModal(e)}})}}}).on("click",".js-delete-battle",function(){const l=this.closest(".battle-preview-one"),n=l.closest(".battle-preview"),o=n.previousElementSibling;var e=l.dataset.id;q.post("/craft/battle/del/"+e,function(){alertModal("배틀이 삭제되었습니다."),l.remove();var e=o.querySelector(".battle-count"),t=parseInt(e.textContent)-1;0<t?e.textContent=t:(n.remove(),o.remove())}).fail(()=>alertModal("배틀 삭제에 실패했습니다."))});const R=/[^\s,.!?;:…]/,H=/^(\s|[,.!?;:…])/,$=/(\s|[,.!?;:…])$/,_=/('m|'re|'s|'d|'ll|'ve)$/,o={A:[{limit:30,rank:"이병"},{limit:60,rank:"일병"},{limit:1/0,rank:"병장"}],B:[{limit:50,rank:"하사"},{limit:70,rank:"상사"},{limit:100,rank:"소위"},{limit:120,rank:"대위"},{limit:1/0,rank:"소령"}],C:[{limit:150,rank:"대령"},{limit:200,rank:"준장"},{limit:1/0,rank:"소장"}]};function b(e,t,l){e.replaceChildren(),h=[],p=[];var n,o=createElement({el:"div",className:"battle-maker row",tabIndex:0}),e=(e.append(o),Array.from(r)[l-1]),a=([1,2].includes(l)&&e.forEach(e=>{null!=e.selector&&null!=t.querySelector(".sem"+e.selector)&&(e.recommended=!0)}),i(l,o),tandem?.cleanSvocDOMs(t).textContent.length),s=(o.querySelector(".eng-length").textContent=a,o.querySelector('.battle-level-select[value="C"]')),c=o.querySelector('.battle-level-select[value="B"]');150<a?(s.checked=!0,bootstrap.Tooltip.getOrCreateInstance(s.nextElementSibling).enable(),bootstrap.Tooltip.getOrCreateInstance(c.nextElementSibling).disable()):(bootstrap.Tooltip.getOrCreateInstance(s.nextElementSibling).disable(),80<a?(c.checked=!0,bootstrap.Tooltip.getOrCreateInstance(c.nextElementSibling).enable()):bootstrap.Tooltip.getOrCreateInstance(c.nextElementSibling).disable()),o.querySelector('.battle-level-select[value="B"]').checked=80<a,o.querySelector('.battle-level-select[value="C"]').checked=150<a,o.prepend(createElement({el:"div",className:"col-12 col-md-3 row",children:[{el:"label",textContent:"질문",className:"col-auto lh-1 my-auto text-fc-purple fw-bold"},{el:"select",className:"form-select ask-select col",children:d(l,e)}]})),[1,2].includes(l)&&(s=o.closest(".add-battle-section").querySelector(".ask-select"),q(s).trigger("change")),n=o,g({el:"div",className:"row pe-2",children:[{el:"label",className:"col-auto lh-1 my-auto text-white fw-bold",textContent:"본문"},{el:"div",className:"battle-context fs-5 bg-white mt-3 px-2 col form-control",textContent:tandem.cleanSvocDOMs(t).innerText,onmouseup:()=>f(n)}]},n)}function i(e,t){var l=v["battle"+e];c.innerHTML="",g(l,c);for(let e=0,t=s.length;e<t;e++)g(s[e],c);t.prepend(c.cloneNode(!0));const n=Date.now(),o={el:"div",className:"battle-diffLevel-section col-12 col-md-3 row",children:[{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"난이도"}]};[{text:"쉬움",value:"A"},{text:"보통",value:"B"},{text:"어려움",value:"C"}].forEach(function(e,t){o.children.push({el:"input",type:"radio",autocomplete:"off",name:"btnRadioBattleLevel"+n,id:"btnRadioBattleLevel"+n+t,className:"btn-check battle-level-select",checked:0==t,value:e.value}),o.children.push({el:"label",textContent:e.text,"data-bs-toggle":0<t?"tooltip":"",htmlFor:"btnRadioBattleLevel"+n+t,"data-bs-html":"true","data-bs-title":"문장 길이로 시스템이 파악한<br>최소 난이도입니다.","data-bs-trigger":"manual",className:"col btn col-auto px-4 ms-1 rounded-pill btn-outline-fico"})}),g(o,t),t.appendChild(createElement([{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"길이"},{el:"span",className:"col-auto my-auto eng-length"}]));var a,l=t.closest(".add-battle-section")?.querySelector(".battle-category-section select");[5,6,7].includes(e)&&t.appendChild(createElement({el:"div",className:"col-12 row mt-3",children:[{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"해석"},{el:"select",className:"select-kor form-select d-inline-block col",children:[{el:"option",value:"",textContent:"해석을 선택해 주세요.",disabled:!0,selected:!0}].concat(Array.from(q(t).closest(".battle-section-panel").data("transList"),({text:e})=>({el:"option",value:e.trim(),textContent:e.trim(),"data-trans":e.trim(),selected:!1})))}]})),7==e&&t.appendChild(createElement({el:"div",className:"col-12 row mt-3",children:[{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"정답"},{el:"input",type:"text",className:"kor-answer form-control d-inline-block col",placeholder:"문장 혹은 문장의 일부에 대한 정답 해석을 선택하거나 직접 입력해 주세요. / 기호로 구분하여 보기에 표시됩니다. 예) 우리에게 불가능한/문장은/없습니다.","data-bs-toggle":"tooltip",title:"문장 혹은 문장의 일부에 대한 정답 해석을 선택하거나 직접 입력해 주세요. / 기호로 구분하여 보기에 표시됩니다. 예) 우리에게 불가능한/문장은/없습니다.","data-bs-template":'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner w-max-100"></div></div>'}]})),[7,8].includes(e)&&(a="오답 보기로 추가할 단어나 구들을 입력해 주세요. / 기호로 구분됩니다. 예) "+(7===e?"우리가/우리를":"we/us"),t.appendChild(createElement({el:"div",className:"col-12 row mt-3",children:[{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"오답"},{el:"input",type:"text",className:"battle-opt-ext form-control col lh-1 my-auto",title:a,"data-bs-toggle":"tooltip","data-bs-template":'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner w-max-100"></div></div>',placeholder:a}]}))),2<e&&q(l).trigger("change")}function d(n,e){const o=[];return e.forEach((e,t)=>{var l={el:"option"};e.recommended&&(l.className="bg-fc-light-purple"),l.value=e.tag||"#"+n,e.tag&&(l["data-tag"]=e.tag),l.innerHTML=B(n,e.tag),0==t&&2!=n&&(l.selected=!0),o.push(l)}),2==parseInt(n)&&(e=null!=e.find(e=>e.recommended),o.unshift({el:"option",className:e?"bg-fc-light-purple":"",value:"의 피수식",innerHTML:"(지정)___의 피수식어를 선택하세요."}),o.unshift({el:"option",className:e?"bg-fc-light-purple":"",value:"의 수식",innerHTML:"(지정)___의 수식어를 선택하세요."}),o.unshift({el:"option",className:e?"bg-fc-light-purple":"",value:"모든 피수식",innerHTML:"피수식어를 모두 선택하세요."}),o.unshift({el:"option",className:e?"bg-fc-light-purple":"",value:"모든 수식",selected:!0,innerHTML:"수식어를 모두 선택하세요."})),o}function f(e){var t=getSelection(),l=e.querySelector("[role=toolbar] [type=checkbox]:checked");if(!t.isCollapsed&&l){var n=e.querySelector(".battle-context");if(t.toString().replace(/\W/g,"")!=n.textContent.replace(/\W/g,"")&&8&t.anchorNode.compareDocumentPosition(n)&t.focusNode.compareDocumentPosition(n)){var o=parseInt(e.closest(".add-battle-section").querySelector(".battle-type-section input:checked").value),l=l.value;if(([3,4].includes(o)&&l.match(/pick-right|answer-wrong/)||7==o||8==o)&&0<n.getElementsByClassName(l).length)alertModal("이 유형의 배틀은 복수 정답을 허용하지 않습니다.\n기존 정답을 눌러 지워 주세요."),getSelection().removeAllRanges();else{for((t.anchorNode.compareDocumentPosition(t.focusNode)&Node.DOCUMENT_POSITION_PRECEDING||0==t.anchorNode.compareDocumentPosition(t.focusNode)&&t.anchorOffset>t.focusOffset)&&t.setBaseAndExtent(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset);0<t.anchorOffset&&t.anchorNode.textContent.charAt(t.anchorOffset).match(R)&&t.anchorNode.textContent.charAt(t.anchorOffset-1).match(R)&&(![1,3].includes(o)||!t.toString().trim().match(_));)t.setBaseAndExtent(t.anchorNode,t.anchorOffset-1,t.focusNode,t.focusOffset);for(;t.toString().match(H);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset+1,t.focusNode,t.focusOffset);for(;t.focusOffset<t.focusNode.textContent.length&&t.focusNode.textContent.charAt(t.focusOffset-1).match(R)&&t.focusNode.textContent.charAt(t.focusOffset).match(R)&&(![1,3].includes(o)||!(2<t.focusNode.textContent.length&&t.focusNode.textContent.substring(t.focusOffset,t.focusOffset+3).trim().match(_)));)t.setBaseAndExtent(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset+1);for(;t.toString().match($);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset-1);if(0!=t.toString().trim().length&&t.toString().replace(/\W/g,"")!=n.textContent.replace(/\W/g,"")){a=n,p.push(a.innerHTML),h=[],a.closest(".battle-maker").querySelector('[role=toolbar] [value="undo"]').disabled=!1;for(var a=O.createElement("span"),s=(a.className=l,t.getRangeAt(0)),c=(a.textContent=s.extractContents().textContent,s.insertNode(a),t.removeAllRanges(),O.createTreeWalker(n,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>0===e.textContent.length?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}));c.nextNode();)c.currentNode.parentNode.removeChild(c.currentNode);for(var r,i,d=O.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);d.nextNode();){let e=d.currentNode["textContent"];e.startsWith(" ")&&(i=e.match(/^\s+/)[0],r=O.createTextNode(i),d.currentNode.parentNode.insertBefore(r,d.currentNode),d.currentNode.textContent=e.substring(i.length),e=d.currentNode.textContent),e.endsWith(" ")&&(r=e.match(/\s+$/)[0],i=O.createTextNode(r),d.currentNode.parentNode.insertBefore(i,d.nextSibling),d.currentNode.textContent=e.substring(0,e.length-r.length))}[3,4,7].includes(o)&&l.match(/pick-right|answer-wrong/)&&((s=prompt(a.textContent+"의 오답을 입력하세요."))?a.dataset.wrong=s:n.innerHTML=p.pop()),7==o&&((l=prompt("선택한 구간의 해석을 입력하세요."))?((a=e.querySelector(".select-kor .custom-trans")||e.querySelector(".select-kor").appendChild(createElement({el:"option",className:"custom-trans",selected:!0,children:["(출제자 해석) ",{el:"span",className:"custom-input"}]}))).value=l,a.dataset.trans=l,a.querySelector(".custom-input").textContent=l,e.querySelector(".kor-answer").value=l):n.innerHTML=p.pop())}}}}}function T(e,t,l,n){return[{el:"div",className:"js-open-existing-battle d-inline-block btn border",role:"button","data-battle-type":e,"data-bs-toggle":"collapse","data-bs-target":"#"+("existingBattleView"+l),children:[`Battle #${e}: `,{el:"span",className:"battle-count",textContent:t}," 건 ",{el:"span",className:"fold-icon text-xl align-middle"}]},{el:"div",id:"existingBattleView"+l,className:"battle-preview fade collapse",children:n}]}function g(e,t){!function n(o,a){Array.isArray(o)?o.forEach((e,t)=>o[t]=n(e,a)):"object"==typeof o&&Object.entries(o).forEach(([e,l])=>{l&&Array.isArray(l)&&l.forEach((e,t)=>l[t]=n(e,a)),o[e]=l});return a.apply(this,[o])}(e,e=>(e.className||"div"!=e.el?e.title&&"checkbox"!=e.type&&(e["data-toggle"]="tooltip",e["data-placement"]="bottom"):e.className="btn-group col-auto",e));e=createElement(e);e.querySelectorAll("[type=checkbox]").forEach(e=>{e.className||(e.className="btn-check");var t="btn-check-"+l++,t=(e.id=t,createElement({el:"label",htmlFor:t,className:"btn btn-outline-fico",textContent:e.textContent}));e.title&&(t.title=e.title,t.dataset.toggle="tooltip",t.dataset.placement="bottom"),e.after(t)}),t.append(e)}function M(e,l){let n=0,o=[];return e.childNodes.forEach(e=>{var t=e.textContent.replaceAll(/[\n\u200b]/gm,"").length;e.className&&e.matches(l)&&o.push([n,n+t]),n+=t}),o}function I(e,t){return e[0]-t[0]}function j(e,t){const{battleId:l,battleType:n,askTag:o,diffLevel:a,memberId:s,grammarTitle:c,comment:r,source:i}=t;e={el:"div","data-id":l,className:"battle-preview-one m-1 ms-5 bg-light border border-2 px-2",children:[{el:"div",className:"row",children:[{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"질문:"},{el:"span",textContent:B(parseInt(n),o)}]},{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"난이도:"},{el:"span",textContent:a}]},{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"문법:"},{el:"span",textContent:c||"(미입력)"}]},{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"출처:"},{el:"span",textContent:i||"(출처없음)"}]}]},{el:"div",className:"battle-context pb-3",children:L(e,t)},{el:"div",className:"row pb-3 comment-section",children:[{el:"label",className:"col-auto fw-bold me-2",textContent:"코멘트"},{el:"span",className:"col-8 comment short text-truncate",role:"button",innerHTML:r||P,onclick:function(){q(this).add(q(this).siblings(".comment")).toggle()}},{el:"div",className:"col comment long ws-breakspaces",role:"button",style:"display: none;",innerHTML:r||P,onclick:function(){q(this).add(q(this).siblings(".comment")).toggle()}}].concat(N==s?[{el:"button",className:"js-open-edit-battle-comment col-auto btn btn-fico",textContent:"수정",onclick:function(){q(this).siblings(".edit-comment-section").add(this).toggle(),q(this).siblings(".comment").hide();var e=q(this).siblings(".comment").html()==P?"":q(this).siblings(".comment").html();openSummernote(q(this).siblings(".edit-comment-section").find("textarea").val(e))}},{el:"div",className:"edit-comment-section",style:"display: none;",children:[{el:"textarea",maxLength:1500},{el:"div",class:"btn-group btn-set float-end mt-0 mt-sm-2",children:[{el:"button",class:"btn btn-sm btn-outline-fico",textContent:"취소",onclick:function(){q(this).closest(".edit-comment-section").hide().closest(".comment-section").find(".comment.long").show(),q(this).closest(".comment-section").find(".js-open-edit-battle-comment").show()}},{el:"button",class:"btn btn-sm btn-fico",textContent:"수정",onclick:function(){const e=q(this).closest(".edit-comment-section").children("textarea").val().trim();q.ajax({url:"/craft/battle/edit/comment",type:"post",contentType:"application/json",data:JSON.stringify({battleId:l,comment:e}),success:()=>{alertModal("코멘트를 수정했습니다.",()=>{q(this).closest(".edit-comment-section").hide().closest(".comment-section").find(".comment").html(e||P).eq(1).show(),q(this).closest(".comment-section").find(".js-open-edit-battle-comment").show()})},error:()=>{alertModal("코멘트 수정에 실패했습니다.")}})}}]}]}]:[])}]};return N==s&&e.children.push({el:"div",class:"position-relative",children:[{el:"button",className:"btn btn-sm btn-fico js-delete-battle",textContent:"삭제"}]}),e}function L(c,e){const r=JSON.parse(e.answer||"[]");var t=JSON.parse(e.example||"[]");let i=0;const d=[];var{battleType:e,ask:l}=e;const u=(e,t)=>c.substring(i,e),a=(t,l)=>{return r.find(e=>e[0]==t&&e[1]==l)?"answer":"option"};switch(e){case"1":t.sort(I).forEach(([e,t],l,n)=>{d.push(u(i)),d.push({el:"span",className:a(e,t),textContent:c.substring(e,t)}),l==n.length-1&&t<c.length&&d.push(c.substring(t)),i=t});break;case"2":var[n,o]=r;[...n.map(e=>[...e,"modifier"]),...o.map(e=>[...e,"modificand"])].sort(I).forEach(([e,t,l],n,o)=>{var a,s;d.push(u(i)),d.push({el:"span",className:l,...(a=e,s=t,l=r.find(e=>e[0]==a&&e[1]==s),l?{"data-wrong":l[2]}:{}),textContent:c.substring(e,t)}),n==o.length-1&&t<c.length&&d.push(c.substring(t)),i=t});break;case"3":var[[n,o],,s]=t;d.push(u(i)),d.push({el:"span",className:"pick-right","data-wrong":s,textContent:c.substring(n,o)}),o<c.length&&d.push(c.substring(o));break;case"4":const[[p,h],,b]=r;t.sort(I).forEach(([e,t],l,n)=>{var o=u(e),o=(o&&d.push(o),{el:"span",className:a(e,t),textContent:c.substring(e,t)});p==e&&h==t&&(o.className="answer-wrong",o["data-wrong"]=b),d.push(o),l==n.length-1&&t<c.length&&d.push(c.substring(t)),i=t});break;case"5":t.sort(I).forEach(([e,t],l,n)=>{var o=u(e);o&&d.push(o),d.push({el:"span",className:"option",textContent:c.substring(e,t)}),l==n.length-1&&t<c.length&&d.push(c.substring(t)),i=t});break;case"6":t.sort((e,t)=>e[0][0]-t[0][0]).forEach(([[e,t]],l,n)=>{var o=u(e);o&&d.push(o),d.push({el:"span",className:"fill-right",textContent:c.substring(e,t)}),l==n.length-1&&t<c.length&&d.push(c.substring(t)),i=t});break;case"7":var[s,n]=JSON.parse(l)[0];d.push({el:"div",className:"row",children:[{el:"label",class:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"영문"},c.substring(0,s),{el:"span",textContent:c.substring(s,n)},c.substring(n,c.length)]}),d.push({el:"div",className:"row",children:[{el:"label",class:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"정답"},{el:"span",textContent:r.join(" ")}]}),d.push({el:"div",className:"row",children:[{el:"label",class:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"보기"},{el:"span",children:[...r.filter(e=>({el:"span",class:"btn border border-dark",textContent:e})),...t.filter(e=>0<e.length).map(e=>({el:"span",class:"btn border border-danger",textContent:e}))]}]});break;case"8":var[o,s]=t[0],n=c.substring(i,o),o=c.substring(o,s),s=c.substring(s),m=c.substring(i,t[0][0]);m&&d.push(m),d.push(n,{el:"span",className:"pick-right","data-wrong":t[2].join("/"),textContent:o},s)}return d}function A(n,o){if(0<n.length)for(let t=0,l=n.length;t<l;t++)for(let e=t+1;e<=l;e++){var a=n.substring(t,e);a in o||(o[a]=[]),o[a].includes(n)||o[a].push(n),o[a].sort()}}function B(e,t){let l=n[e-1].replace("{}",t);return 1===e&&l.includes("절의")?l=l.replace("문장의","문장에서"):2===e&&(t.includes("의 수식")||t.includes("의 피수식"))?l+="어를 선택하세요.":8===e&&(l=t),l}function J(e,t){let l;return l=o[e]?o[e].find(({limit:e})=>t<=e)?.rank:l}E.craft=Object.assign({},E.craft,{openBattleMakerPanel:async function t(l,o,a,s,c){if(q.fn.autocomplete){const n=u.querySelector(".battle-category-section select");if(0==y.length)q.getJSON("/grammar/category/list",e=>{y=e,e=Array.from(y,e=>({el:"option",value:e.cid,textContent:(e.parentCategory?"└─ ":"")+e.title})),n.append(createElement(e)),t(l,o,a,s,c)});else{N=o;const r=tandem.cleanSvocDOMs(s).innerText;let n=u.cloneNode(!0);var e;"undefined"==typeof openSummernote&&await q.cachedScript("https://static.findsvoc.com/js/util/summernote.editor.min.js"),u.querySelector(".battle-comment-section textarea.comment~.note-editor")||(0<(e=q(l).closest(".one-sentence-unit-section")).length&&0<e.find(".note-list .note-text").length&&q(n).find(".battle-comment-section textarea.comment").val(e.find(".note-list .note-text").html()),await openSummernote(q(n).find(".battle-comment-section textarea.comment").removeClass("d-inline"))),q(n).data("semantics",s).data("sentenceId",a).data("eng",r).data("transList",c.filter(e=>!!e.id));const i=Date.now();n.querySelectorAll("[data-radio]").forEach((e,t)=>{const l=""+e.dataset.radio+i+t;e.querySelectorAll("input[type=radio]").forEach((e,t)=>{e.name=l,e.id=l+t,e.nextElementSibling.htmlFor=l+t})}),q.getJSON("/craft/battle/search/"+a,e=>{let t={};e.forEach(e=>{null==t[e.battleType]&&(t[e.battleType]=[]),t[e.battleType].push(e)});const l=n.querySelector(".existing-battles-section");l.replaceChildren(),0==Object.entries(t).length?l.append("등록된 배틀이 없습니다."):Object.entries(t).forEach((e,t)=>{t=Date.now()+t,l.append(createElement(T(e[0],e[1].length,t,Array.from(e[1],e=>j(r,e)))))})}),l.replaceChildren(),b(n.querySelector(".craft-maker-container"),s,1),l.append(n),q(n).find(".ask-select").trigger("change"),q(n).find(".askTag, .source").each(function(){const n=`/craft/battle/${this.matches(".askTag")?"tag":"source"}/search/{}`,o=this.matches(".askTag")?S:C;q(this).autocomplete({minLength:1,delay:50,source:function(e,t){const l=e.term&&e.term.trim();l in o?t(o[l]):q.getJSON(n.replace("{}",l),function(e){0<e.length&&(o[l]=e.sort()),t(e)}).fail(()=>{t([])})}})}),k&&(n.querySelector(".select-book-type").value=k.type,n.querySelector("select.select-book").replaceChildren(createElement(Array.from(m[k.type],e=>({el:"option",value:e.battleBookId,textContent:e.title||"제목 없음"})))),n.querySelector("select.select-book").value=k.bookId),x&&(n.querySelector("input.source").value=x)}}else{O.head.append(createElement([{el:"link",rel:"stylesheet",href:"https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.13.1/jquery-ui.min.css"},{el:"link",rel:"stylesheet",href:"https://static.findsvoc.com/css/app/craft-maker.min.css"}]));const d=q.fn.tooltip;q.cachedScript("https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.13.1/jquery-ui.min.js",{success:()=>{q.fn.tooltip=d,t(l,o,a,s,c)}})}},appendToolbar:i,getAsks:function(e){return r[parseInt(e)-1]},previewBattle:j,combineAsk:B,createAskOptions:d,createBattleContext:L,calcDiffSpecific:J,findPositions:M})}}(jQuery,window,document);
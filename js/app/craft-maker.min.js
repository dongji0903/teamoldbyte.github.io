!function e(S,t,k){if(S.cachedScript=S.cachedScript||function(e,t){return S.ajax(S.extend(t||{},{dataType:"script",cache:!0,url:e}))},"undefined"==typeof createElement)S.cachedScript("https://static.findsvoc.com/js/util/DOM-util.min.js",{success:()=>e(S,t,k)});else{let d,f={},p=[],h=[],b=[],g=[],n=0,y,v=[],x=[],u=(S.getJSON("https://static.findsvoc.com/data/tandem/craft-toolbar.json",e=>{f=e,d=createElement(e.craftPanel),p=e.battleAsks,h=e.battleTypeInfos,b=e.commonEditorBtns}),{}),m={},N=createElement({el:"div",className:"btn-toolbar row col-md-3",role:"toolbar"});function C(e,t,a){e.replaceChildren(),x=[],v=[];const n=createElement({el:"div",className:"battle-maker row",tabIndex:0});e.append(n);let l=h[a-1];[1,2].includes(a)&&(l.forEach(e=>{null!=e.selector&&null!=t.querySelector(".sem"+e.selector)&&(e.recommended=!0)}),l.sort((e,t)=>e.recommended?t.recommended?0:-1:1));{e=a;var o=n,c=f["battle"+e];N.innerHTML="",E(c,N);for(let e=0,t=b.length;e<t;e++)E(b[e],N);o.prepend(N.cloneNode(!0));const i=Date.now(),d={el:"div",className:"battle-diffLevel-section col-12 col-md-3 row",children:[{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"난이도"}]};[{text:"쉬움",value:"E"},{text:"보통",value:"N"},{text:"어려움",value:"D"}].forEach(function(e,t){d.children.push({el:"input",type:"radio",autocomplete:"off",name:"btnRadioBattleLevel"+i,id:"btnRadioBattleLevel"+i+t,className:"btn-check battle-level-select",checked:0==t,value:e.value}),d.children.push({el:"label",textContent:e.text,htmlFor:"btnRadioBattleLevel"+i+t,className:"col btn col-auto px-4 ms-1 rounded-pill btn-outline-fico"})}),E(d,o),5==e&&o.append(createElement({el:"div",className:"col-12 col-md-3 row",children:[{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"해석"},{el:"select",className:"select-kor form-select d-inline-block col",children:Array.from(S(o).closest(".battle-section-panel").data("transList"),(e,t)=>({el:"option",value:e.id,textContent:t+1+"번째 해석"}))}]}))}{var r=a;c=l,e=n;const u={el:"div",className:"col-12 col-md-3 row",children:[{el:"label",textContent:"질문",className:"col-auto lh-1 my-auto text-fc-purple fw-bold"}]},m={el:"select",className:"form-select ask-select col",children:[]};c.forEach((e,t)=>{const a={el:"option"};e.recommended&&(a.className="bg-fc-light-purple"),a.value="#"+r,e.tag&&(a["data-tag"]=e.tag),a.innerHTML=p[r-1].replace("{}",e.tag),0==t&&(a.selected=!0),m.children.push(a)}),u.children.push(m),e.prepend(createElement(u))}s=n,E({el:"div",className:"row pe-2",children:[{el:"label",className:"col-auto lh-1 my-auto text-white fw-bold",textContent:"본문"},{el:"div",className:"battle-context fs-5 bg-white mt-3 px-2 col form-control",textContent:tandem.cleanSvocDOMs(t).innerText,onmouseup:()=>w(s)}]},s);var s,o=n.closest(".add-battle-section").querySelector(".ask-select");S(o).trigger("change")}function w(e){let t=getSelection();var a=e.querySelector("[role=toolbar] [type=checkbox]:checked");if(!t.isCollapsed&&a&&t.toString().trim()!=e.querySelector(".battle-context").textContent.trim()){o(e.querySelector(".battle-context"));var e=Number(e.closest(".add-battle-section").querySelector(".battle-type-section input:checked").value);if(![1,3].includes(e)){for((2==t.anchorNode.compareDocumentPosition(t.focusNode)||0==t.anchorNode.compareDocumentPosition(t.focusNode)&&t.anchorOffset>t.focusOffset)&&t.setBaseAndExtent(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset);0<t.anchorOffset&&t.anchorNode.textContent.charAt(t.anchorOffset).match(/\S/)&&t.anchorNode.textContent.charAt(t.anchorOffset-1).match(/\S/);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset-1,t.focusNode,t.focusOffset);for(;t.toString().match(/^\s/);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset+1,t.focusNode,t.focusOffset);for(;t.focusOffset<t.focusNode.textContent.length-1&&t.focusNode.textContent.charAt(t.focusOffset-1).match(/\S/)&&t.focusNode.textContent.charAt(t.focusOffset).match(/\S/);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset+1);for(;t.toString().match(/\s$/);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset-1)}const n=k.createElement("span"),l=(n.className=a.value,t.getRangeAt(0));n.textContent=l.extractContents().textContent,l.insertNode(n),t.removeAllRanges(),n.matches(".pick-right,.answer-wrong")&&((e=prompt(n.textContent+"의 오답을 입력하세요."))?n.dataset.wrong=e:S(n.firstChild).unwrap())}}function q(e,t,a,n){return[{el:"div",className:"js-open-existing-battle d-inline-block btn border",role:"button","data-battle-type":e,"data-bs-toggle":"collapse","data-bs-target":"#"+("existingBattleView"+a),children:[`Battle #${e}: `,{el:"span",className:"battle-count",textContent:t}," 건 ",{el:"span",className:"fold-icon text-xl align-middle"}]},{el:"div",id:"existingBattleView"+a,className:"battle-preview fade collapse",children:n}]}function E(e,t){!function n(l,o){Array.isArray(l)?l.forEach((e,t)=>l[t]=n(e,o)):"object"==typeof l&&Object.entries(l).forEach(([e,a])=>{a&&Array.isArray(a)&&a.forEach((e,t)=>a[t]=n(e,o)),l[e]=a});return o.apply(this,[l])}(e,e=>(e.className||"div"!=e.el?e.title&&"checkbox"!=e.type&&(e["data-toggle"]="tooltip",e["data-placement"]="bottom"):e.className="btn-group col-auto",e));const a=createElement(e);a.querySelectorAll("[type=checkbox]").forEach(e=>{e.className||(e.className="btn-check");var t="btn-check-"+n++;e.id=t;const a=createElement({el:"label",htmlFor:t,className:"btn btn-outline-fico",textContent:e.textContent});e.title&&(a.title=e.title,a.dataset.toggle="tooltip",a.dataset.placement="bottom"),e.after(a)}),t.append(a)}function a(e,a){let n=0,l=[];return e.childNodes.forEach(e=>{var t=e.textContent.replaceAll(/[\n\u200b]/gm,"").length;e.className&&e.matches(a)&&l.push([n,n+t]),n+=t}),l}function l(e,t){return e[0]-t[0]}function O(o,e){const c=JSON.parse(e.answer),t=JSON.parse(e.example);let r=0;const s=[];var a;"1"==e.battleType?t.sort(l).forEach((t,e,a)=>{var n=o.substring(r,t[0]);n&&s.push(n),s.push({el:"span",className:c.find(e=>e[0]==t[0]&&e[1]==t[1])?"answer":"option",textContent:o.substring(t[0],t[1])}),e==a.length-1&&t[1]<o.length&&s.push(o.substring(t[1])),r=t[1]}):"2"==e.battleType?c.sort(l).forEach((e,t,a)=>{var n=o.substring(r,e[0]);n&&s.push(n),s.push({el:"span",className:0==t?"modifier":"modificand",textContent:o.substring(e[0],e[1])}),t==a.length-1&&e[1]<o.length&&s.push(o.substring(e[1])),r=e[1]}):"3"==e.battleType?((a=o.substring(r,t[0][0]))&&s.push(a),s.push({el:"span",className:"pick-right","data-wrong":t[2],textContent:o.substring(t[0][0],t[0][1])}),t[0][1]<o.length&&s.push(o.substring(t[0][1]))):"4"==e.battleType?t.sort(l).forEach((e,t,a)=>{var n=o.substring(r,e[0]);n&&s.push(n);const l={el:"span",className:"option",textContent:o.substring(e[0],e[1])};c[0][0]==e[0]&&c[0][1]==e[1]&&(l.className="answer-wrong",l["data-wrong"]=c[2]),s.push(l),t==a.length-1&&e[1]<o.length&&s.push(o.substring(e[1])),r=e[1]}):"5"==e.battleType&&t.sort(l).forEach((e,t,a)=>{var n=o.substring(r,e[0]);n&&s.push(n),s.push({el:"span",className:"option",textContent:o.substring(e[0],e[1])}),t==a.length-1&&e[1]<o.length&&s.push(o.substring(e[1])),r=e[1]});const n={el:"div","data-id":e.battleId,className:"battle-preview-one m-1 ms-5 bg-light border border-2 px-2",children:[{el:"div",className:"row",children:[{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"질문:"},{el:"span",textContent:p[e.battleType-1].replace("{}",e.askTag)}]},{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"난이도:"},{el:"span",textContent:e.diffLevel}]},{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"문법:"},{el:"span",textContent:e.grammarTitle}]}]},{el:"div",className:"battle-context pb-3",children:s}]};return y==e.memberId&&n.children.push({el:"div",children:[{el:"button",className:"btn btn-sm btn-fico js-delete-battle",textContent:"삭제"}]}),n}function o(e){v.push(e.innerHTML),x=[],e.closest(".battle-maker").querySelector('[role=toolbar] [value="undo"]').disabled=!1}function T(e,t){let a;return"E"==e?a=t<=30?"하1":"하2":"N"==e?a=t<=70?"중1":t<=100?"중2":t<=150?"중3":"중4":"D"==e&&(a=t<=150?"고1":t<=200?"고2":"고3"),a}S(k).on("click",".battle-type-section .btn, .battle-diffLevel-section .btn, .battle-category-section select",function(){let e={};const t=this.closest(".add-battle-section");let a=t.querySelector(".battles-counter-section"),n;if(a||(a=createElement(f.battleCounterPanel),S.getJSON("/craft/battle/stats/total",e=>{a.querySelector(".counter-total").textContent=e}).fail(()=>alert("전체 배틀 갯수를 조회할 수 없습니다.")),t.querySelector(".battle-type-section").after(a)),this.matches(".battle-type-section .btn")){n="type";var l=k.getElementById(this.htmlFor).value;e={battleType:l}}else if(this.matches(".battle-diffLevel-section .btn")){n="level";k.getElementById(this.htmlFor).value;l=t.querySelector(".battle-context").textContent.trim().length,l=T(diffLEvel,l);e={diffLevel:l}}else{n="gc";const categoryId=parseInt(this.value);e={categoryId:categoryId}}S.getJSON("/craft/battle/stats"+n,e,function(e){switch(n){case"type":a.querySelector(".counter-same-type").replaceChildren(createElement(Array.from(e,(e,t)=>[{el:"label",className:"border-fc-navy-2",textContent:t+1},{el:"span",textContent:e}])));break;case"level":a.querySelector(".counter-same-difflevel").replaceChildren(createElement([{el:"span",textContent:diffLevel+": "+e}]));break;case"gc":a.querySelector(".counter-same-category").replaceChildren(createElement({el:"span",textContent:g.find(e=>e.cid==categoryId).title+": "+e}))}}).fail(()=>alert("배틀 갯수 조회에 실패했습니다."))}).on("change",".battle-type-section input[type=radio]",function(){var e=S(this).closest(".battle-section-panel").data("semantics");C(this.closest(".add-battle-section").querySelector(".craft-maker-container"),e,this.value)}).on("change",".ask-select",function(){var e=this.querySelector("option:checked").dataset.tag;const t=this.closest(".add-battle-section").querySelector(".askTag");t.value=e||""}).on("change",".battle-maker [role=toolbar] [type=checkbox]",function(){const e=this.closest(".battle-maker");var t=e.querySelector(".battle-context");this.checked&&(this.closest("[role=toolbar]").querySelectorAll("[type=checkbox]:checked").forEach(e=>{0!=this.compareDocumentPosition(e)&&(e.checked=!1)}),getSelection().isCollapsed||(o(t),w(this.closest(".battle-maker"))))}).on("click",".battle-context *",function(){this.closest(".battle-maker")&&("SPAN"==this.nodeName?this.outerHTML=this.innerHTML:this.remove())}).on("click",".battle-maker [value=undo], .battle-maker [value=redo]",function(){var e="undo"==this.value,t=(e?v:x).pop();const a=this.closest(".battle-maker"),n=a.querySelector(".battle-context");(e?x:v).push(n.innerHTML),n.innerHTML=t,S(n).animate({opacity:.5},100).animate({opacity:1},100),a.querySelector("[value=undo]").disabled=0==v.length,a.querySelector("[value=redo]").disabled=0==x.length}).on("keyup",function(e){var t=e.target.closest(".battle-maker");t&&(e.ctrlKey&&"Z"==e.key.toUpperCase()?S(t).find("[value=undo]").trigger("click"):e.ctrlKey&&"Y"==e.key.toUpperCase()&&S(t).find("[value=redo]").trigger("click"))}).on("click",".js-add-battle",function(){const c=this.closest(".add-battle-section"),r=c.closest(".battle-section-panel"),s=c.querySelector(".battle-context"),i=Number(c.querySelector(".battle-category-section select").value),d="data-battle-type",u=c.querySelector(".battle-type-section input:checked").value;var e=c.querySelector(".battle-diffLevel-section input:checked").value,t=s.textContent.trim().length;const m={sentenceId:S(r).data("sentenceId"),categoryId:i,battleType:u,memberId:y,example:"",answer:"",ask:c.querySelector(".ask-select").value.trim(),askTag:c.querySelector(".askTag").value.trim(),comment:c.querySelector(".comment").value.trim(),source:c.querySelector(".source").value.trim(),diffLevel:e,engLength:t,diffSpecificLevel:T(e,t)};switch(u){case"1":m.example=JSON.stringify(a(s,".answer, .option")),m.answer=JSON.stringify(a(s,".answer"));break;case"2":m.answer=JSON.stringify([a(s,".modifier")[0],a(s,".modificand")[0]]);break;case"3":let e=s.querySelector(".pick-right");if(!e)return void alert("문제로 만들 어구를 선택해 주세요.");m.example=JSON.stringify([a(s,".pick-right")[0],e.textContent.trim(),e.dataset.wrong.trim()]),m.answer=JSON.stringify([e.textContent.trim()]);break;case"4":let t=s.querySelector(".answer-wrong");m.example=JSON.stringify(a(s,".option, .answer-wrong")),m.answer=JSON.stringify([a(s,".answer-wrong")[0],t.textContent.trim(),t.dataset.wrong.trim()]);break;case"5":m.example=JSON.stringify(a(s,".option")),m.ask=c.querySelector(".select-kor").value}S.ajax({url:"/craft/battle/add",type:"POST",contentType:"application/json",data:JSON.stringify(m),success:function(e){alert(`[등록 결과]
battleId: ${e.battleId}
groupCount: `+e.groupCount),s.replaceChildren(s.textContent),c.querySelector(".comment").value="",m.battleId=e.battleId,m.grammarTitle=g.find(e=>e.cid==i).title;const t=r.querySelector(".existing-battles-section");e=O(S(r).data("eng"),m);let a=t.querySelector(`[${d}="${u}"]`),n;if(a){const o=a.querySelector(".battle-count");o.textContent=Number(o.textContent)+1,n=k.querySelector(a.dataset.bsTarget)}else{t.querySelector(`[${d}]`)||t.replaceChildren();var l=Date.now()+1;[a,n]=q(u,1,l,[]),a=createElement(a),n=createElement(n),t.append(a),S(a).css("height",0).animate({height:"100%"},500,function(){this.style.height="auto"}),t.append(n)}l=createElement(e);n.append(l),S(l).css("display","none").slideDown()},error:function(e){alert(e)}})}).on("click",".js-delete-battle",function(){const a=this.closest(".battle-preview-one"),n=a.closest(".battle-preview"),l=n.previousElementSibling;var e=a.dataset.id;S.post("/craft/battle/del/"+e,function(){alert("배틀이 삭제되었습니다."),a.remove();const e=l.querySelector(".battle-count");var t=Number(e.textContent)-1;0<t?e.textContent=t:(n.remove(),l.remove())}).fail(()=>alert("배틀 삭제에 실패했습니다."))}),t.craft=Object.assign({},t.craft,{openBattleMakerPanel:function t(a,l,o,c,r){if(S.fn.autocomplete){const n=d.querySelector(".battle-category-section select");if(0==g.length)S.getJSON("/grammar/category/list",e=>{g=e,e=Array.from(g,e=>({el:"option",value:e.cid,textContent:(e.parentCategory?"└─ ":"")+e.title})),n.append(createElement(e)),t(a,l,o,c,r)});else{y=l;const s=tandem.cleanSvocDOMs(c).innerText;let n=d.cloneNode(!0);S(n).data("semantics",c).data("sentenceId",o).data("eng",s).data("transList",r);const i=Date.now();n.querySelectorAll("[data-radio]").forEach((e,t)=>{const a=""+e.dataset.radio+i+t;e.querySelectorAll("input[type=radio]").forEach((e,t)=>{e.name=a,e.id=a+t,e.nextElementSibling.htmlFor=a+t})}),S.getJSON("/craft/battle/search/"+o,e=>{let t={};e.forEach(e=>{null==t[e.battleType]&&(t[e.battleType]=[]),t[e.battleType].push(e)});const a=n.querySelector(".existing-battles-section");a.replaceChildren(),0==Object.entries(t).length?a.append("등록된 배틀이 없습니다."):Object.entries(t).forEach((e,t)=>{t=Date.now()+t,a.append(createElement(q(e[0],e[1].length,t,Array.from(e[1],e=>O(s,e)))))})}),a.replaceChildren(),C(n.querySelector(".craft-maker-container"),c,1),a.append(n),S(n).find(".ask-select").trigger("change"),S(n).find(".askTag").autocomplete({minLength:1,delay:50,source:function(e,t){const a=e.term&&e.term.trim();a in u?t(u[a]):S.getJSON("/craft/battle/tag/search/"+a,function(e){u[a]=e,t(e)}).fail(()=>{u[a]=null,t([])})}}),S(n).find(".source").autocomplete({minLength:1,delay:50,source:function(e,t){const a=e.term&&e.term.trim();a in m?t(m[a]):S.getJSON("/craft/battle/source/search/"+a,function(e){m[a]=e,t(e)}).fail(()=>{m[a]=null,t([])})}})}}else{k.head.append(createElement([{el:"link",rel:"stylesheet",href:"https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.13.1/jquery-ui.min.css"},{el:"link",rel:"stylesheet",href:"https://static.findsvoc.com/css/app/craft-maker.min.css"}]));const e=S.fn.tooltip;S.cachedScript("https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.13.1/jquery-ui.min.js",{success:()=>{S.fn.tooltip=e,t(a,l,o,c,r)}})}}})}}(jQuery,window,document);
!function(p,e,d){p.cachedScript=p.cachedScript||function(e,t){return p.ajax(p.extend(t||{},{dataType:"script",cache:!0,url:e}))};let u,m={},f=[],h=[],o=0,b,g=[],y=[],v=(p.getJSON("https://static.findsvoc.com/data/tandem/craft-toolbar.json",e=>{m=e,u=O(e.layout),f=e.common}),{}),x={};const N=["다음 문장의 {}를 선택하세요.","[{}] 수식어와 피수식어를 선택하세요.","다음 문장에서 적절한 보기를 선택하세요.","다음 문장에서 어법상 틀린 것을 선택하세요.","다음 어구들을 해석에 맞게 배치해 보세요."],k=[[{selector:".s",ask:"#1",tag:"주어(부)"},{selector:".v",ask:"#1",tag:"동사(부)"},{selector:".o",ask:"#1",tag:"목적어(부)"},{selector:".c",ask:"#1",tag:"보어(부)"},{selector:".oc",ask:"#1",tag:"목적보어(부)"},{selector:'.s[data-rc="s.s."]',tag:"진짜주어(부)",ask:"#1"},{selector:'.o[data-rc="i.o."]',tag:"간접목적어(부)",ask:"#1"},{selector:'.o[data-rc="d.o."]',tag:"직접목적어(부)",ask:"#1"},{selector:".ptc",ask:"#1",tag:"분사"},{selector:".ger",ask:"#1",tag:"동명사"},{selector:".tor",ask:"#1",tag:"to부정사"}],[{selector:".adjphr[data-mfd],.phr[data-mfd]",ask:"#2",tag:"전치사"},{selector:".tor[data-mfd],.ptc[data-mfd]",ask:"#2",tag:"준동사"},{selector:".acls[data-mfd]",ask:"#2",tag:"관계사"},{ask:"#2",tag:"형용사"},{ask:"#2",tag:"동격어구/절"}],[{ask:"#3"}],[{ask:"#4"}],[{ask:"#5"}]];let S=O({el:"div",className:"btn-toolbar row col-md-3",role:"toolbar"});function w(e,t,a){e.childNodes?.forEach(e=>e.remove()),y=[],g=[];const o=O({el:"div",className:"battle-maker row",tabIndex:0});e.append(o);let l=k[a-1];[1,2].includes(a)&&(l.forEach(e=>{null!=e.selector&&null!=t.querySelector(".sem"+e.selector)&&(e.recommended=!0)}),l.sort((e,t)=>e.recommended?t.recommended?0:-1:1));{e=a;var n=o,s=m["battle"+e];S.innerHTML="",q(s,S);for(let e=0,t=f.length;e<t;e++)q(f[e],S);n.prepend(S.cloneNode(!0));const i=Date.now(),d={el:"div",className:"battle-diffLevel-section col-12 col-md-3 row",children:[{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"난이도"}]};[{text:"쉬움",value:"E"},{text:"보통",value:"N"},{text:"어려움",value:"D"}].forEach(function(e,t){d.children.push({el:"input",type:"radio",autocomplete:"off",name:"btnRadioBattleLevel"+i,id:"btnRadioBattleLevel"+i+t,className:"btn-check battle-level-select",checked:0==t,value:e.value}),d.children.push({el:"label",textContent:e.text,htmlFor:"btnRadioBattleLevel"+i+t,className:"col btn col-auto px-4 ms-1 rounded-pill btn-outline-fico"})}),q(d,n),5==e&&n.append(O({el:"div",className:"col-12 col-md-3 row",children:[{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"해석"},{el:"select",className:"select-kor form-select d-inline-block col",children:Array.from(p(n).closest(".battle-section-panel").data("transList"),(e,t)=>({el:"option",value:e.id,textContent:t+1+"번째 해석"}))}]}))}{var c=a;s=l,e=o;const u={el:"div",className:"col-12 col-md-3 row",children:[{el:"label",textContent:"질문",className:"col-auto lh-1 my-auto text-fc-purple fw-bold"}]},h={el:"select",className:"form-select ask-select col",children:[]};s.forEach((e,t)=>{const a={el:"option"};e.recommended&&(a.className="bg-fc-light-purple"),a.value="#"+c,e.tag&&(a["data-tag"]=e.tag),a.innerHTML=N[c-1].replace("{}",e.tag),0==t&&(a.selected=!0),h.children.push(a)}),u.children.push(h),e.prepend(O(u))}r=o,q({el:"div",className:"row pe-2",children:[{el:"label",className:"col-auto lh-1 my-auto text-white fw-bold",textContent:"본문"},{el:"div",className:"battle-context fs-5 bg-white mt-3 px-2 col form-control",textContent:tandem.cleanSvocDOMs(t).innerText,onmouseup:()=>C(r)}]},r);var r,n=o.closest(".add-battle-section").querySelector(".ask-select");p(n).trigger("change")}function C(e){let t=getSelection();var a=e.querySelector("[role=toolbar] [type=checkbox]:checked");if(!t.isCollapsed&&a&&t.toString().trim()!=e.querySelector(".battle-context").textContent.trim()){n(e.querySelector(".battle-context"));var e=Number(e.closest(".add-battle-section").querySelector(".battle-type-section input:checked").value);if(![1,3].includes(e)){for((2==t.anchorNode.compareDocumentPosition(t.focusNode)||0==t.anchorNode.compareDocumentPosition(t.focusNode)&&t.anchorOffset>t.focusOffset)&&t.setBaseAndExtent(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset);0<t.anchorOffset&&t.anchorNode.textContent.charAt(t.anchorOffset).match(/\S/)&&t.anchorNode.textContent.charAt(t.anchorOffset-1).match(/\S/);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset-1,t.focusNode,t.focusOffset);for(;t.toString().match(/^\s/);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset+1,t.focusNode,t.focusOffset);for(;t.focusOffset<t.focusNode.textContent.length-1&&t.focusNode.textContent.charAt(t.focusOffset-1).match(/\S/)&&t.focusNode.textContent.charAt(t.focusOffset).match(/\S/);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset+1);for(;t.toString().match(/\s$/);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset-1)}const o=d.createElement("span"),l=(o.className=a.value,t.getRangeAt(0));o.textContent=l.extractContents().textContent,l.insertNode(o),t.removeAllRanges(),o.matches(".pick-right,.answer-wrong")&&((e=prompt(o.textContent+"의 오답을 입력하세요."))?o.dataset.wrong=e:p(o.firstChild).unwrap())}}function q(e,t){!function o(l,n){Array.isArray(l)?l.forEach((e,t)=>l[t]=o(e,n)):"object"==typeof l&&Object.entries(l).forEach(([e,a])=>{a&&Array.isArray(a)&&a.forEach((e,t)=>a[t]=o(e,n)),l[e]=a});return n.apply(this,[l])}(e,e=>(e.className||"div"!=e.el?e.title&&"checkbox"!=e.type&&(e["data-toggle"]="tooltip",e["data-placement"]="bottom"):e.className="btn-group col-auto",e));const a=O(e);a.querySelectorAll("[type=checkbox]").forEach(e=>{e.className||(e.className="btn-check");var t="btn-check-"+o++;const a=O({el:"label",htmlFor:e.id=t,className:"btn btn-outline-fico",textContent:e.textContent});e.title&&(a.title=e.title,a.dataset.toggle="tooltip",a.dataset.placement="bottom"),e.after(a)}),t.append(a)}function O(t){if("string"==typeof t)return d.createTextNode(t);if(Array.isArray(t)){const o=d.createDocumentFragment();return t.forEach(e=>o.append(O(e))),o}const a=d.createElement(t.el);return Object.keys(t).forEach(e=>{e.match(/^data-/)?a.dataset[e.replace("data-","").replace(/-(\w)/g,e=>e.toUpperCase()[1])]=t[e]:"children"==e?t[e].forEach(e=>a.appendChild(O(e))):"el"!=e&&(a[e]=t[e])}),a}function E(e,a){let o=0,l=[];return e.childNodes.forEach(e=>{var t=e.textContent.replaceAll(/[\n\u200b]/gm,"").length;e.className&&e.matches(a)&&l.push([o,o+t]),o+=t}),l}function l(e,t){return e[0]-t[0]}function T(n,e){const s=JSON.parse(e.answer),t=JSON.parse(e.example);let c=0;const r=[];var a;"1"==e.battleType?t.sort(l).forEach((t,e,a)=>{var o=n.substring(c,t[0]);o&&r.push(o),r.push({el:"span",className:s.find(e=>e[0]==t[0]&&e[1]==t[1])?"answer":"option",textContent:n.substring(t[0],t[1])}),e==a.length-1&&t[1]<n.length&&r.push(n.substring(t[1])),c=t[1]}):"2"==e.battleType?s.sort(l).forEach((e,t,a)=>{var o=n.substring(c,e[0]);o&&r.push(o),r.push({el:"span",className:0==t?"modifier":"modificand",textContent:n.substring(e[0],e[1])}),t==a.length-1&&e[1]<n.length&&r.push(n.substring(e[1])),c=e[1]}):"3"==e.battleType?((a=n.substring(c,t[0][0]))&&r.push(a),r.push({el:"span",className:"pick-right","data-wrong":t[2],textContent:n.substring(t[0][0],t[0][1])}),t[0][1]<n.length&&r.push(n.substring(t[0][1]))):"4"==e.battleType?t.sort(l).forEach((e,t,a)=>{var o=n.substring(c,e[0]);o&&r.push(o);const l={el:"span",className:"option",textContent:n.substring(e[0],e[1])};s[0][0]==e[0]&&s[0][1]==e[1]&&(l.className="answer-wrong",l["data-wrong"]=s[2]),r.push(l),t==a.length-1&&e[1]<n.length&&r.push(n.substring(e[1])),c=e[1]}):"5"==e.battleType&&t.sort(l).forEach((e,t,a)=>{var o=n.substring(c,e[0]);o&&r.push(o),r.push({el:"span",className:"option",textContent:n.substring(e[0],e[1])}),t==a.length-1&&e[1]<n.length&&r.push(n.substring(e[1])),c=e[1]});const o={el:"div","data-id":e.battleId,className:"battle-preview-one m-1 ms-5 bg-light border border-2 px-2",children:[{el:"div",className:"row",children:[{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"질문:"},{el:"span",textContent:N[e.battleType-1].replace("{}",e.askTag)}]},{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"난이도:"},{el:"span",textContent:e.diffLevel}]},{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"문법:"},{el:"span",textContent:e.grammarTitle}]}]},{el:"div",className:"battle-context pb-3",children:r}]};return b==e.memberId&&o.children.push({el:"div",children:[{el:"button",className:"btn btn-sm btn-fico js-delete-battle",textContent:"삭제"}]}),o}function n(e){g.push(e.innerHTML),y=[],e.closest(".battle-maker").querySelector('[role=toolbar] [value="undo"]').disabled=!1}p(d).on("change",".battle-type-section input[type=radio]",function(){var e=p(this).closest(".battle-section-panel").data("semantics");w(this.closest(".add-battle-section").querySelector(".craft-maker-container"),e,this.value)}).on("change",".ask-select",function(){var e=this.querySelector("option:checked").dataset.tag;const t=this.closest(".add-battle-section").querySelector(".askTag");t.value=e||""}).on("change",".battle-maker [role=toolbar] [type=checkbox]",function(){const e=this.closest(".battle-maker");var t=e.querySelector(".battle-context");this.checked&&(this.closest("[role=toolbar]").querySelectorAll("[type=checkbox]:checked").forEach(e=>{0!=this.compareDocumentPosition(e)&&(e.checked=!1)}),getSelection().isCollapsed||(n(t),C(this.closest(".battle-maker"))))}).on("click",".battle-context *",function(){this.closest(".battle-maker")&&("SPAN"==this.nodeName?this.outerHTML=this.innerHTML:this.remove())}).on("click",".battle-maker [value=undo], .battle-maker [value=redo]",function(){var e="undo"==this.value,t=(e?g:y).pop();const a=this.closest(".battle-maker"),o=a.querySelector(".battle-context");(e?y:g).push(o.innerHTML),o.innerHTML=t,p(o).animate({opacity:.5},100).animate({opacity:1},100),a.querySelector("[value=undo]").disabled=0==g.length,a.querySelector("[value=redo]").disabled=0==y.length}).on("keyup",function(e){var t=e.target.closest(".battle-maker");t&&(e.ctrlKey&&"Z"==e.key.toUpperCase()?p(t).find("[value=undo]").trigger("click"):e.ctrlKey&&"Y"==e.key.toUpperCase()&&p(t).find("[value=redo]").trigger("click"))}).on("click",".js-add-battle",function(){const a=this.closest(".add-battle-section"),s=a.closest(".battle-section-panel"),o=a.querySelector(".battle-context"),c=Number(a.querySelector(".battle-category-section select").value),r={sentenceId:p(s).data("sentenceId"),categoryId:c,memberId:b,ask:a.querySelector(".ask-select").value.trim(),askTag:a.querySelector(".askTag").value.trim(),comment:a.querySelector(".comment").value.trim(),source:a.querySelector(".source").value.trim(),diffLevel:a.querySelector(".battle-diffLevel-section input:checked").value};let l="",n="";const i=a.querySelector(".battle-type-section input:checked").value;switch(i){case"1":l=E(o,".answer, .option"),n=E(o,".answer");break;case"2":n=[E(o,".modifier")[0],E(o,".modificand")[0]];break;case"3":let e=o.querySelector(".pick-right");l=[E(o,".pick-right")[0],e.textContent.trim(),e.dataset.wrong.trim()],n=[e.textContent.trim()];break;case"4":let t=o.querySelector(".answer-wrong");l=E(o,".option, .answer-wrong"),n=[E(o,".answer-wrong")[0],t.textContent.trim(),t.dataset.wrong.trim()];break;case"5":l=E(o,".option"),r.ask=a.querySelector(".select-kor").value}r.answer=JSON.stringify(n),r.example=JSON.stringify(l),r.battleType=i,p.ajax({url:"/craft/battle/add",type:"POST",contentType:"application/json",data:JSON.stringify(r),success:function(e){alert(`[등록 결과]
battleId: ${e.battleId}
groupCount: `+e.groupCount),r.battleId=e.battleId,r.grammarTitle=h.find(e=>e.cid==c).title;const t=s.querySelector(".existing-battles-section");e=T(p(s).data("eng"),r);let a=t.querySelector(`[data-battle-type="${i}"]`),o;if(a){const n=a.querySelector(".battle-count");n.textContent=Number(n.textContent)+1,o=d.querySelector(a.dataset.bsTarget)}else{t.querySelector("[data-battle-type]")||t.childNodes.forEach(e=>e.remove());var l=Date.now()+1;a=O({el:"div",className:"js-open-existing-battle d-inline-block btn border",role:"button","data-battle-type":i,"data-bs-toggle":"collapse","data-bs-target":"#existingBattleView"+l,children:[`Battle #${i}: `,{el:"span",className:"battle-count",textContent:1}," 건 ",{el:"span",className:"fold-icon text-xl align-middle"}]}),t.append(a),p(a).css("height",0).animate({height:"100%"},500,function(){this.style.height="auto"}),o=O({el:"div",id:"existingBattleView"+l,className:"battle-preview fade collapse"}),t.append(o)}l=O(e);o.append(l),p(l).css("display","none").slideDown()},error:function(e){alert(e)}})}).on("click",".js-delete-battle",function(){const t=this.closest(".battle-preview-one"),a=t.closest(".battle-preview"),o=a.previousElementSibling;var e=t.dataset.id;p.post("/craft/battle/del/"+e,function(){alert("배틀이 삭제되었습니다."),t.remove();const e=o.querySelector(".battle-count");0<Number(e.textContent)-1?e.textContent=Number(e.textContent)-1:(a.remove(),o.remove())}).fail(()=>alert("배틀 삭제에 실패했습니다."))}),e.craft={openBattleMakerPanel:async function(t,e,a,o,l){if(!p.fn.autocomplete){d.head.append(O([{el:"link",rel:"stylesheet",href:"https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.13.1/jquery-ui.min.css"},{el:"link",rel:"stylesheet",href:"https://static.findsvoc.com/css/app/craft-maker.min.css"}]));const i=p.fn.tooltip;await p.cachedScript("https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.13.1/jquery-ui.min.js",{success:()=>{p.fn.tooltip=i}})}const n=u.querySelector(".battle-category-section select"),s=(0==h.length&&await p.getJSON("/grammar/category/list",e=>{h=e;e=Array.from(h,e=>({el:"option",value:e.cid,textContent:(e.parentCategory?"└─ ":"")+e.title}));n.append(O(e))}),b=e,tandem.cleanSvocDOMs(o).innerText);let c=u.cloneNode(!0);p(c).data("semantics",o).data("sentenceId",a).data("eng",s).data("transList",l);const r=Date.now();c.querySelectorAll("[data-radio]").forEach((e,t)=>{const a=""+e.dataset.radio+r+t;e.querySelectorAll("input[type=radio]").forEach((e,t)=>{e.name=a,e.id=a+t,e.nextElementSibling.htmlFor=a+t})}),p.getJSON("/craft/battle/search/"+a,e=>{let t={};e.forEach(e=>{null==t[e.battleType]&&(t[e.battleType]=[]),t[e.battleType].push(e)});const a=c.querySelector(".existing-battles-section");if(a.childNodes&&a.childNodes.forEach(e=>a.removeChild(e)),0==Object.entries(t).length)a.append("등록된 배틀이 없습니다.");else{const o=[];Object.entries(t).forEach((e,t)=>{t=Date.now()+t;o.push({el:"div",className:"js-open-existing-battle d-inline-block btn border",role:"button","data-battle-type":e[0],"data-bs-toggle":"collapse","data-bs-target":"#existingBattleView"+t,children:[`Battle #${e[0]}: `,{el:"span",className:"battle-count",textContent:e[1].length}," 건 ",{el:"span",className:"fold-icon text-xl align-middle"}]}),o.push({el:"div",id:"existingBattleView"+t,className:"battle-preview fade collapse",children:Array.from(e[1],e=>T(s,e))})}),a.append(O(o))}}),t.childNodes.forEach(e=>t.removeChild(e)),w(c.querySelector(".craft-maker-container"),o,1),t.append(c),p(c).find(".ask-select").trigger("change"),p(c).find(".askTag").autocomplete({minLength:1,delay:50,source:function(e,t){const a=e.term&&e.term.trim();a in v?t(v[a]):p.getJSON("/craft/battle/tag/search/"+a,function(e){v[a]=e,t(e)}).fail(()=>{v[a]=null,t([])})}}),p(c).find(".source").autocomplete({minLength:1,delay:50,source:function(e,t){const a=e.term&&e.term.trim();a in x?t(x[a]):p.getJSON("/craft/battle/source/search/"+a,function(e){x[a]=e,t(e)}).fail(()=>{x[a]=null,t([])})}})}}}(jQuery,window,document);
!function e(q,E,O){if(q.cachedScript=q.cachedScript||function(e,t){return q.ajax(q.extend(t||{},{dataType:"script",cache:!0,url:e}))},"undefined"==typeof createElement)q.cachedScript("https://static.findsvoc.com/js/util/DOM-util.min.js",{success:()=>e(q,E,O)});else{let u,b={},l=[],g=[],y=[],m=[],f,n=0,v;const D=88e4,P="data-battle-type";let x=[],N=[],S=(q.getJSON("https://static.findsvoc.com/data/tandem/craft-toolbar.json",e=>{b=e,u=createElement(e.craftPanel),l=e.battleAsks,g=e.battleTypeInfos,y=e.commonEditorBtns}),{}),C={},k={},w=createElement({el:"div",className:"btn-toolbar row col-md-3",role:"toolbar"});function d(e,t,a){e.replaceChildren(),N=[],x=[];const l=createElement({el:"div",className:"battle-maker row",tabIndex:0});e.append(l);let n=g[a-1];[1,2].includes(a)&&(n.forEach(e=>{null!=e.selector&&null!=t.querySelector(".sem"+e.selector)&&(e.recommended=!0)}),n.sort((e,t)=>e.recommended?t.recommended?0:-1:1));{e=a;var o=l,c=b["battle"+e];w.innerHTML="",I(c,w);for(let e=0,t=y.length;e<t;e++)I(y[e],w);o.prepend(w.cloneNode(!0));const d=Date.now(),h={el:"div",className:"battle-diffLevel-section col-12 col-md-3 row",children:[{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"난이도"}]},p=([{text:"쉬움",value:"A"},{text:"보통",value:"B"},{text:"어려움",value:"C"}].forEach(function(e,t){h.children.push({el:"input",type:"radio",autocomplete:"off",name:"btnRadioBattleLevel"+d,id:"btnRadioBattleLevel"+d+t,className:"btn-check battle-level-select",checked:0==t,value:e.value}),h.children.push({el:"label",textContent:e.text,"data-bs-toggle":0<t?"tooltip":"",htmlFor:"btnRadioBattleLevel"+d+t,"data-bs-html":"true","data-bs-title":"문장 길이로 시스템이 파악한<br>최소 난이도입니다.","data-bs-trigger":"manual",className:"col btn col-auto px-4 ms-1 rounded-pill btn-outline-fico"})}),I(h,o),o.appendChild(createElement([{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"길이"},{el:"span",className:"col-auto my-auto eng-length"}])),o.closest(".add-battle-section").querySelector(".battle-category-section select"));5==e&&(p.value=D,q(p).trigger("click"),o.append(createElement({el:"div",className:"col-12 col-md-auto row",children:[{el:"label",className:"col-auto lh-1 my-auto text-fc-purple fw-bold",textContent:"해석"},{el:"select",className:"select-kor form-select d-inline-block col",children:Array.from(q(o).closest(".battle-section-panel").data("transList"),(e,t)=>({el:"option",value:e.id,textContent:t+1+"번째 해석"}))}]}))),2<e&&q(p).trigger("change")}var r,c=tandem?.cleanSvocDOMs(t).textContent.length;l.querySelector(".eng-length").textContent=c;const s=l.querySelector('.battle-level-select[value="C"]'),i=l.querySelector('.battle-level-select[value="B"]');150<c?(s.checked=!0,bootstrap.Tooltip.getOrCreateInstance(s.nextElementSibling).enable(),bootstrap.Tooltip.getOrCreateInstance(i.nextElementSibling).disable()):(bootstrap.Tooltip.getOrCreateInstance(s.nextElementSibling).disable(),80<c?(i.checked=!0,bootstrap.Tooltip.getOrCreateInstance(i.nextElementSibling).enable()):bootstrap.Tooltip.getOrCreateInstance(i.nextElementSibling).disable()),l.querySelector('.battle-level-select[value="B"]').checked=80<c,l.querySelector('.battle-level-select[value="C"]').checked=150<c;{var u=a;o=n,e=l;const m={el:"div",className:"col-12 col-md-3 row",children:[{el:"label",textContent:"질문",className:"col-auto lh-1 my-auto text-fc-purple fw-bold"}]},f={el:"select",className:"form-select ask-select col",children:[]};o.forEach((e,t)=>{const a={el:"option"};e.recommended&&(a.className="bg-fc-light-purple"),a.value=e.tag||"#"+u,e.tag&&(a["data-tag"]=e.tag),a.innerHTML=M(u,e.tag),0==t&&2!=u&&(a.selected=!0),f.children.push(a)}),2==u&&(o=null!=o.find(e=>e.recommended),f.children.unshift({el:"option",className:o?"bg-fc-light-purple":"",innerHTML:"피수식어를 모두 선택하세요."}),f.children.unshift({el:"option",className:o?"bg-fc-light-purple":"",selected:!0,innerHTML:"수식어를 모두 선택하세요."})),m.children.push(f),e.prepend(createElement(m))}[1,2].includes(a)&&(c=l.closest(".add-battle-section").querySelector(".ask-select"),q(c).trigger("change")),r=l,I({el:"div",className:"row pe-2",children:[{el:"label",className:"col-auto lh-1 my-auto text-white fw-bold",textContent:"본문"},{el:"div",className:"battle-context fs-5 bg-white mt-3 px-2 col form-control",textContent:tandem.cleanSvocDOMs(t).innerText,onmouseup:()=>T(r)}]},r)}function T(e){let t=getSelection();const a=e.querySelector("[role=toolbar] [type=checkbox]:checked");var l=/[^\s,.!?;:…]/,n=/^(\s|[,.!?;:…])/,o=/(\s|[,.!?;:…])$/,c=/('m|'re|'s|'d|'ll|'ve)$/;if(!t.isCollapsed&&a){const s=e.querySelector(".battle-context");if(t.toString().trim()!=s.textContent.trim()&&8&t.anchorNode.compareDocumentPosition(s)&t.focusNode.compareDocumentPosition(s)){var r=parseInt(e.closest(".add-battle-section").querySelector(".battle-type-section input:checked").value);if([3,4].includes(r)&&a.value.match(/pick-right|answer-wrong/)&&0<s.getElementsByClassName(a.value).length)alert("이 유형의 배틀은 복수 정답을 허용하지 않습니다.\n기존 정답을 눌러 지워 주세요.");else{for((2==t.anchorNode.compareDocumentPosition(t.focusNode)||0==t.anchorNode.compareDocumentPosition(t.focusNode)&&t.anchorOffset>t.focusOffset)&&t.setBaseAndExtent(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset);0<t.anchorOffset&&t.anchorNode.textContent.charAt(t.anchorOffset).match(l)&&t.anchorNode.textContent.charAt(t.anchorOffset-1).match(l)&&(![1,3].includes(r)||!t.toString().trim().match(c));)t.setBaseAndExtent(t.anchorNode,t.anchorOffset-1,t.focusNode,t.focusOffset);for(;t.toString().match(n);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset+1,t.focusNode,t.focusOffset);for(;t.focusOffset<t.focusNode.textContent.length-1&&t.focusNode.textContent.charAt(t.focusOffset-1).match(l)&&t.focusNode.textContent.charAt(t.focusOffset).match(l)&&(![1,3].includes(r)||!(2<t.focusNode.textContent.length&&t.focusNode.textContent.substring(t.focusOffset,t.focusOffset+3).trim().match(c)));)t.setBaseAndExtent(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset+1);for(;t.toString().match(o);)t.setBaseAndExtent(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset-1);if(0!=t.toString().trim().length){e=s,x.push(e.innerHTML),N=[],e.closest(".battle-maker").querySelector('[role=toolbar] [value="undo"]').disabled=!1;const i=O.createElement("span"),u=(i.className=a.value,t.getRangeAt(0));i.textContent=u.extractContents().textContent,u.insertNode(i),t.removeAllRanges(),a.value.match(/pick-right|answer-wrong/)&&((e=prompt(i.textContent+"의 오답을 입력하세요."))?i.dataset.wrong=e:q(i.firstChild).unwrap())}}}}}function A(e,t,a,l){return[{el:"div",className:"js-open-existing-battle d-inline-block btn border",role:"button","data-battle-type":e,"data-bs-toggle":"collapse","data-bs-target":"#"+("existingBattleView"+a),children:[`Battle #${e}: `,{el:"span",className:"battle-count",textContent:t}," 건 ",{el:"span",className:"fold-icon text-xl align-middle"}]},{el:"div",id:"existingBattleView"+a,className:"battle-preview fade collapse",children:l}]}function I(e,t){!function l(n,o){Array.isArray(n)?n.forEach((e,t)=>n[t]=l(e,o)):"object"==typeof n&&Object.entries(n).forEach(([e,a])=>{a&&Array.isArray(a)&&a.forEach((e,t)=>a[t]=l(e,o)),n[e]=a});return o.apply(this,[n])}(e,e=>(e.className||"div"!=e.el?e.title&&"checkbox"!=e.type&&(e["data-toggle"]="tooltip",e["data-placement"]="bottom"):e.className="btn-group col-auto",e));const a=createElement(e);a.querySelectorAll("[type=checkbox]").forEach(e=>{e.className||(e.className="btn-check");var t="btn-check-"+n++;e.id=t;const a=createElement({el:"label",htmlFor:t,className:"btn btn-outline-fico",textContent:e.textContent});e.title&&(a.title=e.title,a.dataset.toggle="tooltip",a.dataset.placement="bottom"),e.after(a)}),t.append(a)}function L(e,a){let l=0,n=[];return e.childNodes.forEach(e=>{var t=e.textContent.replaceAll(/[\n\u200b]/gm,"").length;e.className&&e.matches(a)&&n.push([l,l+t]),l+=t}),n}function i(e,t){return e[0]-t[0]}function j(e,t){const a={el:"div","data-id":t.battleId,className:"battle-preview-one m-1 ms-5 bg-light border border-2 px-2",children:[{el:"div",className:"row",children:[{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"질문:"},{el:"span",textContent:M(parseInt(t.battleType),t.askTag)}]},{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"난이도:"},{el:"span",textContent:t.diffLevel}]},{el:"div",className:"col-auto",children:[{el:"label",className:"fw-bold me-2",textContent:"문법:"},{el:"span",textContent:t.grammarTitle}]}]},{el:"div",className:"battle-context pb-3",children:o(e,t)}]};return v==t.memberId&&a.children.push({el:"div",children:[{el:"button",className:"btn btn-sm btn-fico js-delete-battle",textContent:"삭제"}]}),a}function o(o,e){const c=JSON.parse(e.answer||"[]"),t=JSON.parse(e.example||"[]");let r=0;const s=[];if("1"==e.battleType)t.sort(i).forEach((t,e,a)=>{var l=o.substring(r,t[0]);l&&s.push(l),s.push({el:"span",className:c.find(e=>e[0]==t[0]&&e[1]==t[1])?"answer":"option",textContent:o.substring(t[0],t[1])}),e==a.length-1&&t[1]<o.length&&s.push(o.substring(t[1])),r=t[1]});else if("2"==e.battleType){var[a,l]=c;const n=Array.from(a,e=>e.concat("modifier")).concat(Array.from(l,e=>e.concat("modificand")));n.sort(i).forEach((e,t,a)=>{var l=o.substring(r,e[0]);l&&s.push(l),s.push({el:"span",className:e[2],textContent:o.substring(e[0],e[1])}),t==a.length-1&&e[1]<o.length&&s.push(o.substring(e[1])),r=e[1]})}else"3"==e.battleType?((a=o.substring(r,t[0][0]))&&s.push(a),s.push({el:"span",className:"pick-right","data-wrong":t[2],textContent:o.substring(t[0][0],t[0][1])}),t[0][1]<o.length&&s.push(o.substring(t[0][1]))):"4"==e.battleType?t.sort(i).forEach((e,t,a)=>{var l=o.substring(r,e[0]);l&&s.push(l);const n={el:"span",className:"option",textContent:o.substring(e[0],e[1])};c[0][0]==e[0]&&c[0][1]==e[1]&&(n.className="answer-wrong",n["data-wrong"]=c[2]),s.push(n),t==a.length-1&&e[1]<o.length&&s.push(o.substring(e[1])),r=e[1]}):"5"==e.battleType&&t.sort(i).forEach((e,t,a)=>{var l=o.substring(r,e[0]);l&&s.push(l),s.push({el:"span",className:"option",textContent:o.substring(e[0],e[1])}),t==a.length-1&&e[1]<o.length&&s.push(o.substring(e[1])),r=e[1]});return s}function B(l,n){if(0<l.length)for(let t=0,a=l.length;t<a;t++)for(let e=t+1;e<=a;e++){var o=l.substring(t,e);o in n||(n[o]=[]),n[o].includes(l)||n[o].push(l),n[o].sort()}}function M(e,t){let a=l[e-1].replace("{}",t);return a=1==e&&a.match(/종속절의|주절의/)?a.replace("문장의","문장에서"):a}function J(e,t){let a;return"A"==e?a=t<=30?"이병":t<=60?"일병":"병장":"B"==e?a=t<=50?"하사":t<=70?"상사":t<=100?"소위":t<=120?"대위":"소령":"C"==e&&(a=t<=150?"대령":t<=200?"준장":"소장"),a}q(O).on("click",".battle-type-section .btn, .battle-diffLevel-section .btn, .battle-category-section select",function(){let a={};const e=this.closest(".add-battle-section");let l=e.querySelector(".battles-counter-section"),n;l||(l=createElement(b.battleCounterPanel),q.getJSON("/craft/battle/stats/total",e=>{l.querySelector(".counter-total").textContent=e+"건"}).fail(()=>alert("전체 배틀 갯수를 조회할 수 없습니다.")),e.querySelector(".battle-type-section").before(l)),a=this.matches(".battle-type-section .btn")?(n="type",{battleType:O.getElementById(this.htmlFor).value}):this.matches(".battle-diffLevel-section .btn")?(n="level",{diffLevel:J(O.getElementById(this.htmlFor).value,e.querySelector(".battle-context").textContent.trim().length)}):(n="gc",{categoryId:parseInt(this.value)}),q.getJSON("/craft/battle/stats/"+n,a,function(e){let t;switch(n){case"type":(t=l.querySelector(".counter-same-type")).replaceChildren(createElement(Array.from(e,(e,t)=>[{el:"label",className:"bg-fc-yellow col-auto ms-2 rounded-pill",textContent:"#"+(t+1)},{el:"span",className:"col-auto",textContent:e+"건"}])));break;case"level":(t=l.querySelector(".counter-same-difflevel")).replaceChildren(createElement([{el:"span",className:"col-auto",textContent:a.diffLevel+`: ${e}건`}]));break;case"gc":(t=l.querySelector(".counter-same-category")).replaceChildren(createElement({el:"span",className:"col-auto",textContent:m.find(e=>e.cid==a.categoryId).title+`: ${e}건`}))}null!=q.fn.bounce&&q(t).bounce()}).fail(()=>alert("배틀 갯수 조회에 실패했습니다."))}).on("change",".battle-type-section input[type=radio]",function(){var e=q(this).closest(".battle-section-panel").data("semantics");d(this.closest(".add-battle-section").querySelector(".craft-maker-container"),e,parseInt(this.value))}).on("change",".ask-select",function(){var e=this.querySelector("option:checked").dataset.tag;const t=this.closest(".add-battle-section").querySelector(".askTag");t.value=e||""}).on("change",".battle-category-section select",function(){this.closest(".add-battle-section").querySelector(".askTag").value=k[parseInt(this.value)]||""}).on("change",".battle-maker [role=toolbar] [type=checkbox]",function(){this.checked&&(this.closest("[role=toolbar]").querySelectorAll("[type=checkbox]:checked").forEach(e=>{0!=this.compareDocumentPosition(e)&&(e.checked=!1)}),getSelection().isCollapsed||T(this.closest(".battle-maker")))}).on("click",".battle-context *",function(){this.closest(".battle-maker")&&("SPAN"==this.nodeName?this.outerHTML=this.innerHTML:this.remove())}).on("click",".battle-maker [value=undo], .battle-maker [value=redo]",function(){var e="undo"==this.value,t=(e?x:N).pop();const a=this.closest(".battle-maker"),l=a.querySelector(".battle-context");(e?N:x).push(l.innerHTML),l.innerHTML=t,q(l).animate({opacity:.5},100).animate({opacity:1},100),a.querySelector("[value=undo]").disabled=0==x.length,a.querySelector("[value=redo]").disabled=0==N.length}).on("keyup",function(e){var t=e.target.closest(".battle-maker");t&&(e.ctrlKey&&"Z"==e.key.toUpperCase()?q(t).find("[value=undo]").trigger("click"):e.ctrlKey&&"Y"==e.key.toUpperCase()&&q(t).find("[value=redo]").trigger("click"))}).on("click",".js-add-battle",function(){const a=this.closest(".add-battle-section"),c=a.closest(".battle-section-panel"),r=a.querySelector(".battle-context"),s=parseInt(a.querySelector(".battle-category-section select").value),i=a.querySelector(".battle-type-section input:checked").value;var e=a.querySelector(".battle-diffLevel-section input:checked").value;const l=a.querySelector(".ask-select").value.trim(),u=a.querySelector(".askTag").value.trim();var t=a.querySelector(".comment").value.trim();const d=a.querySelector(".source").value.trim();var n=r.textContent.trim().length;const h={categoryId:s,battleType:i,ask:l,askTag:u,comment:t,source:d,diffLevel:e,engLength:n,sentenceId:q(c).data("sentenceId"),memberId:v,example:"",answer:"",diffSpecificLevel:J(e,n)};switch(i){case"1":h.example=JSON.stringify(L(r,".answer, .option")),h.answer=JSON.stringify(L(r,".answer"));break;case"2":var o=L(r,".modifier"),p=L(r,".modificand");if(l.includes("피수식어를 모두")&&(0<o.length||0==p.length))return void alert("피수식어만 1개 이상 선택해 주세요.");if(l.includes("수식어를 모두")&&(0<p.length||0==o.length))return void alert("수식어만 1개 이상 선택해 주세요.");if(!l.includes("모두")&&0==(o.length&&p.length))return void alert("수식어/피수식어를 1쌍 이상 선택해 주세요.");h.answer=JSON.stringify([o,p]);break;case"3":let e=r.querySelector(".pick-right");if(!e)return void alert("문제로 만들 어구를 선택해 주세요.");h.example=JSON.stringify([L(r,".pick-right")[0],e.textContent.trim(),e.dataset.wrong.trim()]),h.answer=JSON.stringify([e.textContent.trim()]);break;case"4":let t=r.querySelector(".answer-wrong");if(null==r.querySelector(".option"))return void alert("보기 어구를 선택해 주세요.");h.example=JSON.stringify(L(r,".option, .answer-wrong")),h.answer=JSON.stringify([L(r,".answer-wrong")[0],t.textContent.trim(),t.dataset.wrong.trim()]);break;case"5":if(Array.from(r.querySelectorAll(".option"),e=>e.textContent).join("").replace(/\W/g,"")!=r.textContent.replace(/\W/g,""))return void alert("보기를 모두 더하면 원문이 되도록 선택해 주세요.");h.example=JSON.stringify(L(r,".option")),h.ask=a.querySelector(".select-kor").value}q.ajax({url:"/craft/battle/add",type:"POST",contentType:"application/json",data:JSON.stringify(h),success:function(e){B(u,S),B(d,C),k[s]=u,O.getElementById("craftResultModal")||O.body.appendChild(createElement(b.addResultModal)),q("#craftResultModal .battle-id").text(e.battleId),q("#craftResultModal .group-count").text(e.groupCount),q("#craftResultModal").modal("show"),!f&&0<h.source.length&&E.location.pathname.startsWith("/workbook/passage")&&(f=h.source),r.replaceChildren(r.textContent),h.battleId=e.battleId,h.grammarTitle=m.find(e=>e.cid==s).title;const t=c.querySelector(".existing-battles-section");e=j(q(c).data("eng"),h);let a=t.querySelector(`[${P}="${i}"]`),l;if(a){const o=a.querySelector(".battle-count");o.textContent=parseInt(o.textContent)+1,l=O.querySelector(a.dataset.bsTarget)}else{t.querySelector(`[${P}]`)||t.replaceChildren();var n=Date.now()+1;[a,l]=A(i,1,n,[]),a=createElement(a),l=createElement(l),t.append(a),q(a).css("height",0).animate({height:"100%"},500,function(){this.style.height="auto"}),t.append(l)}n=createElement(e);l.append(n),q(n).css("display","none").slideDown()},error:function(e){alert(e)}})}).on("click",".js-delete-battle",function(){const a=this.closest(".battle-preview-one"),l=a.closest(".battle-preview"),n=l.previousElementSibling;var e=a.dataset.id;q.post("/craft/battle/del/"+e,function(){alert("배틀이 삭제되었습니다."),a.remove();const e=n.querySelector(".battle-count");var t=parseInt(e.textContent)-1;0<t?e.textContent=t:(l.remove(),n.remove())}).fail(()=>alert("배틀 삭제에 실패했습니다."))}),E.craft=Object.assign({},E.craft,{openBattleMakerPanel:function t(a,n,o,c,r){if(q.fn.autocomplete){const l=u.querySelector(".battle-category-section select");if(0==m.length)q.getJSON("/grammar/category/list",e=>{m=e,e=Array.from(m,e=>({el:"option",value:e.cid,textContent:(e.parentCategory?"└─ ":"")+e.title})),l.append(createElement(e)),t(a,n,o,c,r)});else{v=n;const s=tandem.cleanSvocDOMs(c).innerText;let l=u.cloneNode(!0);q(l).data("semantics",c).data("sentenceId",o).data("eng",s).data("transList",r);const i=Date.now();l.querySelectorAll("[data-radio]").forEach((e,t)=>{const a=""+e.dataset.radio+i+t;e.querySelectorAll("input[type=radio]").forEach((e,t)=>{e.name=a,e.id=a+t,e.nextElementSibling.htmlFor=a+t})}),q.getJSON("/craft/battle/search/"+o,e=>{let t={};e.forEach(e=>{null==t[e.battleType]&&(t[e.battleType]=[]),t[e.battleType].push(e)});const a=l.querySelector(".existing-battles-section");a.replaceChildren(),0==Object.entries(t).length?a.append("등록된 배틀이 없습니다."):Object.entries(t).forEach((e,t)=>{t=Date.now()+t,a.append(createElement(A(e[0],e[1].length,t,Array.from(e[1],e=>j(s,e)))))})}),a.replaceChildren(),d(l.querySelector(".craft-maker-container"),c,1),a.append(l),q(l).find(".ask-select").trigger("change"),q(l).find(".askTag, .source").each(function(){const l=`/craft/battle/${this.matches(".askTag")?"tag":"source"}/search/{}`,n=this.matches(".askTag")?S:C;q(this).autocomplete({minLength:1,delay:50,source:function(e,t){const a=e.term&&e.term.trim();a in n?t(n[a]):q.getJSON(l.replace("{}",a),function(e){0<e.length&&(n[a]=e.sort()),t(e)}).fail(()=>{t([])})}})}),f&&(l.querySelector("input.source").value=f)}}else{O.head.append(createElement([{el:"link",rel:"stylesheet",href:"https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.13.1/jquery-ui.min.css"},{el:"link",rel:"stylesheet",href:"https://static.findsvoc.com/css/app/craft-maker.min.css"}]));const e=q.fn.tooltip;q.cachedScript("https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.13.1/jquery-ui.min.js",{success:()=>{q.fn.tooltip=e,t(a,n,o,c,r)}})}},categories:m,previewBattle:j,combineAsk:M,createBattleContext:o})}}(jQuery,window,document);
!function(S,l,k){S.cachedScript=S.cachedScript||function(e,t){return S.ajax(S.extend(t||{},{dataType:"script",cache:!0,url:e}))};let a,c,w,q=[],i,d,u,s,r,o;const p="findsvoc-idb",b=1;let h,m,f,N=[];function t(){var e=c?"/"+ntoa(c):"",e=`/craft/battle/${a}${e}/next`;S.getJSON(e,function(s){0==(q=s).length?alert("조회된 문제가 없습니다."):0==i?(h=l.indexedDB.open(p,b)).onsuccess=function(){const e=(m=this.result).transaction(["StepBattle"],"readwrite");f=e.objectStore("StepBattle");let n=0;!function e(){if(n<s.length){const t=s[n++];f.add({bid:t.bid,data:t,solve:""},t.bid).onsuccess=e}else g()}()}:g()}).fail(()=>alert("새로운 문제를 조회할 수 없습니다."))}function g(){w=q.shift(),N=[];const c=k.getElementById("battle-"+w.battleType),e=(c.querySelector(".battle-type").textContent=w.battleType,S(c).show().siblings(".battle-section").hide(),anime({targets:c,easing:"linear",duration:1e3,left:["100vw",0]}),S(c).find(".js-solve-btn").prop("disabled",!0),S(c).find(".explain-section").hide().find(".collapse").collapse("hide"),c.querySelector(".ask")),r=c.querySelector(".sentence"),o=w.eng;var t=JSON.parse(w.answer||"[]");const n=JSON.parse(w.example||"[]");let l=0,i,d=[];const u=[];switch(w.battleType){case"1":e.textContent=`다음 문장의 ${w.ask}를 선택하세요.`,n.forEach(([e,t],n,s)=>{(i=o.substring(l,e))&&u.push(i),u.push({el:"span",role:"button",className:"option",textContent:o.substring(e,t),onclick:function(){S(this).toggleClass("selected"),S(c).find(".js-solve-btn").prop("disabled",0==r.querySelectorAll(".selected").length)}}),n==s.length-1&&t<o.length&&u.push(o.substring(t)),l=t}),r.replaceChildren(createElement(u));break;case"2":w.ask.includes("모든")?e.textContent=`${w.ask.includes("피수식")?"피수식어":"수식어"}를 모두 선택하세요.`:e.textContent=`[${w.ask}] 수식어와 피수식어를 선택하세요.`;var[s,a]=t;const p={el:"span",role:"button",onclick:function(){var e;this.matches(".selected")?(e=N.indexOf(this),N.splice(e,1)[0].classList.remove("selected"),w.includes("모든")||(e=e<2*Math.floor(e/2)+(1-e%2)?e:e-1,N[e]&&N.splice(e,1)[0].classList.remove("selected"))):(this.classList.add("selected"),N.push(this)),c.querySelector(".js-solve-btn").disabled=0==N.length}},b=Array.from(s,e=>e.concat("modifier")).concat(Array.from(a,e=>e.concat("modificand")));b.sort(([e],[t])=>e-t).forEach(([e,t,n],s,r)=>{(i=o.substring(l,e))&&(i.includes(" ")?Array.from(i.split(" ").filter(e=>0<e.length),e=>Object.assign({className:"option d-inline-block",textContent:e},p)).forEach(e=>u.push(e," ")):u.push(i," ")),u.push(Object.assign({className:n+" d-inline-block",textContent:o.substring(e,t)},p)),t<o.length&&u.push(" "),s==r.length-1&&t<o.length&&(-1<o.indexOf(" ",t)?Array.from(o.substring(t).split(" ").filter(e=>0<e.length),e=>Object.assign({className:"option d-inline-block",textContent:e},p)).forEach(e=>u.push(e," ")):u.push(o.substring(t))),l=t}),r.replaceChildren(createElement(u));break;case"3":const[[h,m],f,g]=n;(i=o.substring(l,h))&&u.push(i),d=[f,g].sort(()=>Math.random()-.5),u.push({el:"span",className:"pick-right","data-answer":f,textContent:`[ ${d.join(" / ")} ]`}),m<o.length&&u.push(o.substring(m)),r.replaceChildren(createElement(u)),c.querySelector(".example-btn-section").replaceChildren(createElement(Array.from(d,e=>({el:"button",className:"btn btn-outline-fico w-100",textContent:e,onclick:function(){S(this).addClass("active").siblings().removeClass("active"),c.querySelector(".js-solve-btn").disabled=!1}}))));break;case"4":const[[x,y],v,C]=t;n.sort(([e],[t])=>e-t).forEach(([e,t],n,s)=>{(i=o.substring(l,e))&&u.push(i);let r=o.substring(e,t);const a={el:"span",className:"option text-decoration-underline",textContent:r};x==e&&y==t&&(a.className="answer-wrong text-decoration-underline",a.textContent=C,r=C,a["data-answer"]=v),u.push(a),d.push({el:"button",className:"btn btn-outline-fico w-100",textContent:r,onclick:function(){S(this).addClass("active").siblings().removeClass("active"),c.querySelector(".js-solve-btn").disabled=!1}}),n==s.length-1&&t<o.length&&u.push(o.substring(t)),l=t}),r.replaceChildren(createElement(u)),c.querySelector(".example-btn-section").replaceChildren(createElement(d));break;case"5":r.replaceChildren(w.kor),n.sort(()=>Math.random()-.5).forEach(([e,t])=>{d.push({el:"span",className:"btn btn-outline-fico mb-1",textContent:o.substring(e,t),onclick:function(){if(!this.closest(".arranged-examples")&&!this.matches(".text-secondary.bg-secondary")){const e=this.cloneNode(!0);c.querySelector(".arranged-examples").appendChild(e),e.onclick=()=>{e.remove(),S(this).removeClass("text-secondary bg-secondary"),c.querySelector(".js-solve-btn").disabled=0==c.querySelector(".arranged-examples").childElementCount},S(this).addClass("text-secondary bg-secondary")}c.querySelector(".js-solve-btn").disabled=0==c.querySelector(".arranged-examples").childElementCount}})}),c.querySelector(".example-btn-section").replaceChildren(createElement(d)),c.querySelector(".arranged-examples").replaceChildren(),S(c).find(".arranged-examples").sortable(),c.querySelector(".arranged-examples").style.height=.5*c.querySelector(".example-btn-section").clientHeight+"px"}}function x(e){d=e<13?"E":e<16?"M":e<19?"H":"C",(0==q.length?t:g)(),v()}function y(e,n){let s=0,r=[];return e.childNodes.forEach(e=>{var t=e.textContent.replaceAll(/[\n\u200b]/gm,"").length;e.className&&("string"==typeof n?e.matches(n):e==n)&&r.push([s,s+t]),s+=t}),r}function v(){var e=r;if(o=3500<u.correct?(s="대장",r=3501):2500<u.correct?(s="중장",r=2501,3501):2e3<u.correct?(s="소장",r=2001,2501):1600<u.correct?(s="준장",r=1601,2001):1300<u.correct?(s="대령",r=1301,1601):1100<u.correct?(s="중령",r=1101,1301):900<u.correct?(s="소령",r=901,1101):700<u.correct?(s="대위",r=701,901):600<u.correct?(s="중위",r=601,701):500<u.correct?(s="소위",r=501,601):400<u.correct?(s="상사",r=401,501):300<u.correct?(s="중사",r=301,401):200<u.correct?(s="하사",r=201,301):150<u.correct?(s="병장",r=151,201):100<u.correct?(s="상병",r=101,151):50<u.correct?(s="일병",r=51,101):20<u.correct?(s="이병",r=21,51):(s="훈련병",r=0,21),e<r){showFireworks({target:S(".battle-section:visible")[0],distance:100,size:10});const n=createElement({el:"img",src:`https://static.findsvoc.com/images/app/craft/${s}.png`,class:"position-absolute start-50 top-50 w-50",style:"transform: translate(-50%, -50%)"});k.body.appendChild(n),anime({targets:n,scale:[0,1],easing:"cubicBezier(0,2,1,2)",duration:1e3,complete:()=>setTimeout(()=>n.remove(),3e3)})}const t=k.querySelector(".progress-bar");e=(100*(u.correct-r)/o).toFixed(1);t.ariaValueNow=e,t.textContent=e+"%",t.style.width=e+"%"}S(k).on("click",".js-solve-btn",function(){const r=this.closest(".battle-section"),a=JSON.parse(w.answer||"[]"),e=JSON.parse(w.example||"[]");let c=!0;switch(S(this).toggleClass("js-solve-btn js-next-btn").text("다음").prop("disabled",!0),S(r).find(".battle-type-block").slideUp(),S(r).find(".sub-block,.example-btn-section,.arranged-examples").addClass("pe-none"),w.battleType){case"1":const o=[];e.sort(([e],[t])=>e-t).forEach(([n,s],e)=>{null!=a.find(([e,t])=>n==e&&s==t)&&o.push(e)}),r.querySelectorAll(".option").forEach((e,t)=>{o.includes(t)?e.className="text-primary":e.matches(".selected")&&(c=!1,e.className="text-danger")});break;case"2":let[t,n]=Array.from(a,e=>Array.from(e,e=>JSON.stringify(e)));r.querySelectorAll(".option").forEach(e=>{t.includes(JSON.stringify(y(r,e)[0]))||n.includes(JSON.stringify(y(r,e)[0]))?e.className="text-primary":e.matches(".selected")&&(c=!1,e.className="text-danger")});break;case"3":var s=r.querySelector(".example-btn-section .active").textContent;c=!!a.includes(s);break;case"4":s=S(r).find(".example-btn-section .active").index();c=s==Array.from(e,e=>JSON.stringify(e)).indexOf(JSON.stringify(a[0]));break;case"5":c=r.querySelector(".arranged-examples").textContent.replace(/\W/g,"").trim()==w.eng.replace(/\W/g,"").trim(),r.querySelector(".example-btn-section").replaceChildren(w.eng)}const t=r.querySelector(".sub-block");var n=createElement({el:"div",class:`toast align-items-center position-absolute top-0 start-50 w-50 text-white text-center ${c?"bg-success":"bg-danger"} border-0 translate-middle`,role:"alert","aria-live":"assertive","aria-atomic":"true","data-bs-autohide":"false",textContent:c?"정답입니다!":"틀렸어요.."}),n=(t.prepend(n),bootstrap.Toast.getOrCreateInstance(n).show(),{memberId:i,ageGroup:d,battleId:w.bid,correct:c,save:!1});S(r).find(".explain-section").show().find(".comment-section").text(w.comment),S.getJSON("/craft/battle/"+w.sentenceId,e=>{var t=w.eng,n=r.querySelector(".explain-section");S(n).find(".comment-section").collapse("show"),tandem.showSemanticAnalysis(t,e.svocTag.svocBytes,S(n).find(".svoc-section").empty()),n.querySelector(".trans-section").replaceChildren(createElement(Array.from(e.korList,e=>({el:"span",className:"text-fc-red ms-3",style:"display: list-item",textContent:e.kor})))),n.querySelector(".words-section").replaceChildren(createElement(Array.from(e.wordList,(e,t)=>({el:"span",class:"one-word-unit-section"+(0<t?" ms-3":""),children:[{el:"span",class:"title fw-bold text-blue-700",textContent:e.title}].concat(Array.from(e.senseList,e=>({el:"span",class:"one-part-unit-section ms-2",children:[{el:"span",class:"part text-palegreen",textContent:e.partType},{el:"span",class:"meaning ms-1",textContent:e.meaning}]})))}))))}),S.ajax({url:"/craft/battle/evaluation/add",type:"GET",contentType:"application/json",data:n,success:()=>{c&&u.correct++,0==i&&((h=l.indexedDB.open(p,b)).onsuccess=function(){const e=(m=this.result).transaction(["StepBattle"],"readwrite");(f=e.objectStore("StepBattle")).index("bid").openCursor().onsuccess=function(){let e=this.result;if(e)if(e.key==w.bid){const t=e.value;t.solve=c?"O":"X",void e.update(t)}else e.continue()}});const e=createElement({el:"span",textContent:"4초 뒤에 눌러주세요."}),t=r.querySelector(".js-next-btn");t.parentElement.prepend(e);let n=4;const s=setInterval(()=>{0<--n?e.textContent=n+"초 뒤에 눌러주세요.":(e.remove(),t.disabled=!1,clearInterval(s))},1e3);v()},error:()=>alert("채점 전송에 실패했습니다. 재로그인 후 다시 시도해 주세요.")})}).on("click",".js-next-btn",function(){this.disabled=!0;const e=S(this).toggleClass("js-solve-btn js-next-btn").text("확인").closest(".battle-section");e.find(".toast").remove(),e.find(".battle-type-block").slideDown(),e.find(".sub-block,.example-btn-section,.arranged-examples").removeClass("pe-none"),(0<q.length?g:t)()}).on("shown.bs.collapse",".svoc-section",function(){tandem.correctMarkLine(this.querySelector(".semantics-result"))}),l.craft=Object.assign({},l.craft,{initPlayer:function(e,t,n,s,r){i=e,c=s,a=n,u=r,0==i?(u={numOfTest:0,correct:0,incorrect:0},(h=l.indexedDB.open(p,b)).onsuccess=function(){const e=(m=this.result).transaction(["StepBattle"],"readonly");f=e.objectStore("StepBattle"),(h=f.openCursor()).onsuccess=function(){const e=this.result;if(e){switch(e.value.solve){case"O":u.correct++;break;case"X":u.incorrect++;break;default:q.push(e.value.data)}e.continue()}else x(t)}},h.onupgradeneeded=function(){m=this.result,(f=m.createObjectStore("StepBattle")).createIndex("bid","bid",{unique:!0}),f.createIndex("data","data"),f.createIndex("solve","solve",{unique:!1})}):x(t)}})}(jQuery,window,document);
!function(h,g,f){h.cachedScript=h.cachedScript||function(e,t){return h.ajax(h.extend(t||{},{dataType:"script",cache:!0,url:e}))};let D=new URLSearchParams(location.search),W="https://static.findsvoc.com/sound/popdrop.mp3",$="https://static.findsvoc.com/sound/page-flip.mp3",F="https://static.findsvoc.com/sound/coin.mp3",P="https://static.findsvoc.com/sound/egg_crack.mp3",H={el:"div",id:"newRankModal",className:"modal",tabIndex:"-1","data-bs-backdrop":"static",style:{zIndex:1071,background:"radial-gradient(circle, white 25%, #fff4)"},children:[{el:"div",className:"modal-dialog modal-dialog-centered overflow-hidden m-0",style:"max-width: 100%",children:[{el:"div",className:"modal-content bg-transparent border-0",children:[{el:"div",className:"modal-header border-0 d-block text-center"},{el:"div",className:"modal-body w-100 text-center",style:"min-height: 77vmin",children:[{el:"span",className:"circle-dark",style:{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)",width:"70vmin",height:"70vmin",backgroundColor:"var(--fc-purple)",borderRadius:"37vmin",zIndex:1},children:[{el:"object",data:"https://static.findsvoc.com/images/app/egg/new-title.svg",style:{position:"absolute",top:"3vmin",left:"37.5%",width:"25%",height:"20%",zIndex:2,overflow:"visible"}}]},{el:"span",className:"circle-dark-dashed",style:{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%,-50%) translateZ(0)",borderRadius:"37vmin",backgroundColor:"transparent",border:"2vmin dashed var(--fc-purple)",width:"76vmin",height:"76vmin"}}]},{el:"div",className:"modal-footer d-block border-0 text-center",children:[{el:"button",className:"btn btn-outline-fico rounded-5 col-md-2 col-4 fs-5 fw-bold","data-bs-dismiss":"modal",textContent:"닫기"}]}]}]}]},c=new FicoTTS,_=(h(function(){let e=f.querySelector(".craft-header-section"),t=f.querySelector(".scrolling-section"),a=scrollY,n=(h(g).on("scroll",function(){requestAnimationFrame(()=>{scrollY>a?40<scrollY&&(t.style.marginTop="75px",e.classList.add("min")):scrollY<40&&(t.style.marginTop="0",e.classList.remove("min")),a=scrollY})}),new NoSleep);f.addEventListener("click",function e(){f.removeEventListener("click",e,!1),n.enable()},!1),WebAudioJS.load(W),WebAudioJS.load($),WebAudioJS.load(F),WebAudioJS.load(P)}),new IntersectionObserver(e=>{J(!e[0].isIntersecting)},{threshold:1}));let l=[],d,s={},y={},p,n=!1,m,u,z=50,V=25,x,v=[],o=[],k,b,C,w,S,r,i,Y,E,q,N="findsvoc-idb",I=2,L,Z={step:"StepBattle",theme:"ThemeBattle",grammar:"GrammarBattle"},G={"Ѐ":'"bid":',"Ё":'"rnum":',"Ђ":'"categoryId":',"Ѓ":'"sentenceId":',"Є":'"memberId":',"Ѕ":'"diffLevel":',"І":'"engLength":',"Ї":'"engLevel":',"Ј":'"battleType":',"Љ":'"eng":',"Њ":'"grammarTitle":',"Ћ":'"askTag":',"Ќ":'"ask":',"Ѝ":'"source":',"Ў":'"comment":',"Џ":'"example":',"А":'"answer":',"Б":'"regDate":',"В":'"updateDate":',"Г":'"[[',"Д":']]"',"Е":"],["};function X(e){return JSON.parse((e=pako.inflateRaw(e,{to:"string"}),t=new RegExp(Array.from(Object.keys(G)).join("|"),"g"),e.replace(t,e=>G[e])));var t}function Q(e){return pako.deflateRaw(function(e){let t=new Map(Object.entries(G).map(([e,t])=>[t,e]));var a=new RegExp(Array.from(t.keys()).join("|").replace(/\[/g,"\\["),"g");return e.replace(a,e=>t.get(e))}(JSON.stringify(e)))}let j=[],a=[];function T(){var e,t;o[E]?(e=o.slice(E).findIndex(e=>void 0===e),v=-1===e?o.slice(E):o.slice(E,E+e),n=E+v.length>=q,A()):(e="/craft/battlebook/"+d,t="step"===d&&"b"===y.markType?{...s,...y,lastBattleId:p,rankLevel:r.battleLevel}:{...y,lastBattleId:p},h.getJSON(e,t,function(a){v=a,n="step"==d&&a.length<V||E+a.length>=q,0==a.length?(b||w)&&((null!=x||0!=p)&&null==x&&-1!=p?(p=-1,E=0,B(),T):O)():(a.forEach((e,t)=>{o[t+E]=e}),0==b&&Cookies.get("FMID")?idb.openDB(N,I).then(async e=>{let t=e.transaction(L,"readwrite");await Promise.all(Array.from(a,e=>t.store.add({bid:ntoa(e.bid),data:Q(e),solve:""})).concat([t.done])),A()}):A())}).fail(()=>{(null==x&&-1!=p?(p=-1,T):O)()}))}function A(){x=v.shift(),"s"==y.markType&&(x.saved=!0),j=[];var e=(k=f.getElementById("battle-"+x.battleType)).querySelector(".ask-block .ask"),a=k.querySelector(".simple-ask-block .ask");let l=k.querySelector(".sentence"),d=x.eng;var n=JSON.parse(x.answer||"[]"),t=JSON.parse(x.example||"[]");let p=0,m,u=[],b=[];switch(scrollTo(0,0),f.querySelector(".craft-header-section").classList.remove("min"),f.querySelector(".scrolling-section").style.marginTop="0",h(k).find(".battle-type-block, .ask-block").show(),h(k).find(".simple-ask-block").hide(),k.querySelector(".battle-type").textContent=x.battleType,h("#save-btn").toggleClass("reverse",Boolean(x.saved)),k.querySelector(".example-btn-section")&&(k.querySelector(".example-btn-section").style.display=""),h(k).show().siblings(".battle-section").hide(),anime({targets:k,duration:1e3,delay:300,left:["100vw",0]}),J(!0),h(k).find(".explain-section").hide().find(".collapse").collapse("hide"),x.battleType){case"1":e.textContent=`다음 문장의 ${x.ask}를 선택하세요.`,a.textContent=e.textContent,t.forEach(([e,t],a,n)=>{(m=d.substring(p,e))&&b.push(m),b.push({el:"span",role:"button",className:"option haptic-btn shadow-none",textContent:d.substring(e,t),onclick:function(){h(this).toggleClass("selected"),J(0==l.querySelectorAll(".selected").length)}}),a==n.length-1&&t<d.length&&b.push(d.substring(t)),p=t}),l.replaceChildren(createElement(b));break;case"2":{let t=createElement({el:"span",class:"mod-guide-text"});x.ask.includes("모든")?(e.textContent=`${x.ask.includes("피수식")?"피수식어":"수식어"}를 모두 선택하세요.`,t.textContent=`${x.ask.includes("피수식")?"피수식어":"수식어"} 선택`,h(t).addClass(x.ask.includes("피수식")?"text-modificand":"text-modifier")):x.ask.match(/의 수식|의 피수식/)?(e.textContent=x.ask+"어를 선택하세요.",t.textContent=`${x.ask.includes("피수식")?"피수식어":"수식어"} 선택`,h(t).addClass(x.ask.includes("피수식")?"text-modificand":"text-modifier")):(e.textContent=`[${x.ask}] 수식어와 피수식어를 선택하세요.`,t.textContent="수식어 선택",h(t).addClass("text-modifier")),k.querySelector(".ask-section").appendChild(t),a.textContent=e.textContent;var[o,r]=n;let s={el:"span",role:"button",onclick:function(){var e;this.matches(".selected")?(e=j.indexOf(this),j.splice(e,1)[0].classList.remove("selected","text-modifier","text-modificand"),null==x.ask.match(/모든|의 수식|의 피수식/)?(e=e<2*Math.floor(e/2)+(1-e%2)?e:e-1,j[e]&&j.splice(e,1)[0].classList.remove("selected"),t.textContent=j.length%2?"피수식어 선택":"수식어 선택",h(t).addClass("text-modifier").removeClass("text-modificand")):0==j.length&&(e=x.ask.includes("피수식"),h(t).toggleClass("text-modifier",!e),h(t).toggleClass("text-modificand",e))):(this.classList.add("selected"),j.push(this),null==x.ask.match(/모든|의 수식|의 피수식/)?(t.textContent=["수식어","피수식어"][j.length%2]+" 선택",e=j.length%2==1,this.classList.add(e?"text-modifier":"text-modificand"),h(t).toggleClass("text-modifier",!e),h(t).toggleClass("text-modificand",e)):(e=x.ask.includes("피수식"),this.classList.add(e?"text-modificand":"text-modifier"))),J(0==j.length)}};Array.from(o,e=>e.concat("modifier")).concat(Array.from(r,e=>e.concat("modificand"))).sort(([e],[t])=>e-t).forEach(([e,t,a],n,l)=>{(m=d.substring(p,e))&&(m.includes(" ")?Array.from(m.split(" ").filter(e=>0<e.length),e=>Object.assign({className:"option d-inline-block haptic-btn shadow-none",textContent:e},s)).forEach(e=>b.push(e," ")):b.push(m," ")),b.push(Object.assign({className:a+" d-inline-block haptic-btn shadow-none",textContent:d.substring(e,t)},s)),t<d.length&&b.push(" "),n==l.length-1&&t<d.length&&(-1<d.indexOf(" ",t)?Array.from(d.substring(t).split(" ").filter(e=>0<e.length),e=>Object.assign({className:"option d-inline-block haptic-btn shadow-none",textContent:e},s)).forEach(e=>b.push(e," ")):b.push(d.substring(t))),p=t}),l.replaceChildren(createElement(b));break}case"3":var[[o,r],s,i]=t;(m=d.substring(p,o))&&b.push(m),u=[s,i].sort(()=>Math.random()-.5),b.push({el:"span",className:"pick-right","data-answer":s,children:["[ ",{el:"span",class:"pick-option",textContent:u[0]}," / ",{el:"span",class:"pick-option",textContent:u[1]}," ]"]}),r<d.length&&b.push(d.substring(r)),l.replaceChildren(createElement(b)),k.querySelector(".example-btn-section").replaceChildren(createElement(Array.from(u,e=>({el:"button",className:"btn btn-outline-fico haptic-btn shadow-none",textContent:e,onclick:function(){h(this).addClass("active").siblings().removeClass("active"),J(!1)}}))));break;case"4":{let[[o,r],i,c]=n;t.sort(([e],[t])=>e-t).forEach(([e,t],a,n)=>{(m=d.substring(p,e))&&b.push(m);let l=d.substring(e,t);var s={el:"span",className:"option text-decoration-underline",textContent:l};o==e&&r==t&&(s.className="answer-wrong text-decoration-underline",s.textContent=c,l=c,s["data-answer"]=i),b.push(s),u.push({el:"button",className:"btn btn-outline-fico haptic-btn shadow-none",textContent:l,onclick:function(){h(this).addClass("active").siblings().removeClass("active"),J(!1)}}),a==n.length-1&&t<d.length&&b.push(d.substring(t)),p=t}),l.replaceChildren(createElement(b)),k.querySelector(".example-btn-section").replaceChildren(createElement(u));break}case"5":l.replaceChildren(x.kor);o=k.querySelector(".arranged-example-section");Array.from(t,([e,t])=>d.substring(e,t)).join("").replace(/\W/g,"").length!=d.replace(/\W/g,"").length?t.forEach(([e,t],a,n)=>{var l=t+(t<d.length-1&&/[,.]/.test(d.charAt(t))?1:0);(m=d.substring(p,e))&&b.push(m),0==e||null!=m&&null!=m.match(/\w/g)?b.push({el:"div",className:"arranged-example d-inline-block","data-full":1}):"object"==typeof b[b.length-1]?b[b.length-1]["data-full"]++:b[b.length-2]["data-full"]++,a==n.length-1&&t<d.length&&b.push(d.substring(t)),p=l}):b.push({el:"div",className:"arranged-example d-inline-block"}),t.sort(()=>Math.random()-.5).forEach(([e,t],a)=>{t+=t<d.length-1&&/[,.]/.test(d.charAt(t))?1:0;u.push({el:"span",className:"btn btn-outline-fico haptic-btn shadow-none","data-opt":a,textContent:d.substring(e,t),onclick:U})}),k.querySelector(".example-btn-section").replaceChildren(createElement(u)),o.replaceChildren(createElement(b)),h(k).find(".arranged-example,.example-btn-section").sortable({items:".haptic-btn",connectWith:".arranged-example:not(.full),.example-btn-section"}).on("sortreceive",(e,t)=>{var a;e.target.matches(".example-btn-section")?(a=t.item[0].dataset.opt,null!=t.sender[0].dataset.full&&t.sender[0].classList.remove("full"),h(k).find(`arranged-example [data-opt="${a}"]`).remove(),h(k).find(`.example-btn-section [data-opt="${a}"]`).not(t.item[0]).show().removeClass("selected pe-none")):null!=e.target.dataset.full&&e.target.childElementCount>=parseInt(e.target.dataset.full)&&e.target.classList.add("full"),J(k.querySelectorAll(".arranged-example .haptic-btn").length!=JSON.parse(x.example).length),h(k).find(".example-btn-section")}).on("sortover",(e,t)=>{var a=t.item[0].dataset.opt;h(k).find(`.example-btn-section [data-opt="${a}"]`).not(t.item[0]).hide()}).on("sortout",(e,t)=>{var a=t.item[0].dataset.opt;t.sender[0]?.matches(".arranged-example")&&h(k).find(`.example-btn-section [data-opt="${a}"]`).not(t.item[0]).show()});break;case"6":t.sort(([[e]],[[t]])=>e-t).forEach(([[e,t],a],n,l)=>{(m=d.substring(p,e))&&b.push(m),a.split(/\s+/).forEach((e,t)=>{0<t&&b.push(" "),0<e.length&&b.push({el:"input",type:"text",style:{width:e.length+"em"},pattern:"[0-9A-z!?.,]",placeholder:1<e.length?e.substring(0,1):"",autocapitalize:"off",autocomplete:"off",autocorrect:"off",spellcheck:"false",onfocus:function(){this.placeholder="";var e=this.getBoundingClientRect().top,t=f.querySelector(".js-next-btn, .js-solve-btn").getBoundingClientRect().top,t=Math.abs(t-e);t<76.5&&scrollTo(scrollX,scrollY+76.5-t)},onblur:function(){this.placeholder=1<e.length?e.substring(0,1):""}})}),n==l.length-1&&t<d.length&&b.push(d.substring(t)),p=t}),k.querySelector(".arranged-example-section").replaceChildren(),k.querySelector(".ask-section .sentence.kor").textContent=x.kor,k.querySelector(".example-btn-section").replaceChildren(createElement(b)),h(k).on("input",".example-btn-section input",function(){J(!Array.from(k.querySelectorAll(".example-btn-section input")).every(e=>0<e.value.length))});break;case"7":{let e=[...t,...n];k.querySelector(".ask-section .sentence.eng").textContent=d,x.ask.match(/\[.*]/)&&(i=new Range,s=JSON.parse(x.ask)[0],i.selectNode(l.firstChild),i.setStart(l.firstChild,s[0]),i.setEnd(l.firstChild,s[1]),i.insertNode(createElement({el:"span",className:"text-decoration-underline",textContent:i.extractContents().textContent})));r=k.querySelector(".arranged-example-section");(e=e.sort(()=>Math.random()-.5)).forEach(e=>{b.push({el:"span",className:"btn btn-outline-fico haptic-btn shadow-none",textContent:e.replace(/[,.!?]$/,""),onclick:U})}),r.replaceChildren(createElement({el:"div",className:"arranged-example d-inline-block"})),h(r).sortable({items:"> .haptic-btn"}),h(k).find(".arranged-example,.example-btn-section").sortable({items:".haptic-btn",connectWith:".arranged-example:not(.full),.example-btn-section"}).on("sortreceive",(e,t)=>{e.target.matches(".example-btn-section")&&(e=t.item[0].dataset.opt,h(k).find(`arranged-example [data-opt="${e}"]`).remove(),h(k).find(`.example-btn-section [data-opt="${e}"]`).not(t.item[0]).show().removeClass("selected pe-none")),J(k.querySelectorAll(".arranged-example .haptic-btn").length!=JSON.parse(x.example).length),h(k).find(".example-btn-section")}).on("sortover",(e,t)=>{var a=t.item[0].dataset.opt;h(k).find(`.example-btn-section [data-opt="${a}"]`).not(t.item[0]).hide()}).on("sortout",(e,t)=>{var a=t.item[0].dataset.opt;t.sender[0]?.matches(".arranged-example")&&h(k).find(`.example-btn-section [data-opt="${a}"]`).not(t.item[0]).show()}),k.querySelector(".example-btn-section").replaceChildren(createElement(b));break}case"8":var[[o,s],i,r]=t;(m=d.substring(p,o))&&b.push(m),r.push(i),u=r.sort(()=>Math.random()-.5),b.push({el:"span",className:"pick-right","data-answer":i,textContent:"-------"}),s<d.length&&b.push(d.substring(s)),l.replaceChildren(createElement(b)),k.querySelector(".example-btn-section").replaceChildren(createElement(Array.from(u,e=>({el:"button",className:"btn btn-outline-fico haptic-btn shadow-none",textContent:e,onclick:function(){h(this).addClass("active").siblings().removeClass("active"),J(!1)}}))))}var c=f.querySelector(".craft-layout-content-section");c.style.backgroundPositionY=k.querySelector(".ask-section").getBoundingClientRect().top-(992<=g.innerWidth?c.clientHeight/c.clientWidth>334/355?142*c.clientWidth/355:151*c.clientHeight/355:285*g.innerWidth/355)+"px"}function U(e){let t=e.target;e=k.querySelector(t.closest(".example-btn-section")?".arranged-example-section":".example-btn-section");let a=t.cloneNode(!0),n=t.cloneNode(!0);a.style.visibility="hidden",n.style.display="block",n.style.position="fixed",n.style.transform="translateZ(0)",e.matches(".arranged-example-section")&&!e.querySelector(".arranged-example")&&e.appendChild(createElement({el:"span",className:"arranged-example"})),e.matches(".arranged-example-section")&&!e.querySelector(".arranged-example:not(.full)")||((e.querySelector(".arranged-example:not(.full)")||e).appendChild(a),t.parentElement.appendChild(n),anime({targets:n,begin:()=>{var e=a.parentElement;null!=e.dataset.full?e.childElementCount==parseInt(e.dataset.full)&&e.classList.add("full"):t.parentElement.classList.remove("full"),t.remove()},top:[h(t).offset().top,h(a).offset().top],left:[h(t).offset().left,h(a).offset().left],easing:"linear",complete:()=>{n.remove(),a.style.visibility="visible",a.onclick=U},duration:100}),h(t).toggleClass("selected pe-none",e.matches(".arranged-example-section")),k.matches("#battle-5")?J(k.querySelectorAll(".arranged-example .haptic-btn").length!=JSON.parse(x.example).length):k.matches("#battle-7")&&J(0==k.querySelectorAll(".arranged-example .haptic-btn").length))}function M(e){switch(!0){case(s.age=e)<13:C="E";break;case e<16:C="M";break;case e<19:C="H";break;default:C="C"}q&&q==E&&(E=0,p=-1,"b"===y.markType)&&(h.getJSON("/craft/battlebook/"+d,{...y,lastBattleId:-1}),O()),B().then(()=>{(0==v.length?T:A)()})}function K(){f.getElementById("loginExpiredModal")||f.querySelector(".craft-layout-content-section").appendChild(createElement({el:"div",id:"loginExpiredModal",class:"modal fade","data-bs-backdrop":"static","data-bs-keyboard":"false",tabIndex:-1,children:[{el:"div",class:"modal-dialog modal-md modal-dialog-centered",children:[{el:"div",class:"modal-content",children:[{el:"div",class:"modal-body row g-0",children:[{el:"div",class:"text-section my-3 text-center text-dark",innerHTML:"이용 시간이 만료되었습니다."},{el:"div",class:"button-section row g-1",children:[{el:"button",class:"btn btn-fico",onclick:()=>{location.replace(0==b?"/craft/main":"/auth/login")},textContent:0==b?"시작 화면으로":"로그인"}]}]}]}]}]})),bootstrap.Modal.getOrCreateInstance(f.getElementById("loginExpiredModal")).show()}function O(){var e;"step"===d&&"b"===y.markType?"대장"==r.rankTitle?(f.getElementById("newRankModal")||f.body.prepend(createElement(H)),h("#newRankModal .modal-body .new-obj").remove(),e=createElement({el:"div",className:"new-obj",children:[{el:"p",className:"fs-3",textContent:"단계별 배틀을 정복하셨습니다."},{el:"p",className:"fs-6",textContent:"다른 배틀북도 정복하는 건 어떨까요?"}],style:{position:"absolute",left:"50%",top:"calc(50% + 4vmin)",zIndex:1071,transformOrigin:"center",opacity:0,transform:"translate(-50%,-50%) translateZ(0)"}}),h("#newRankModal .modal-body").append(e),h("#newRankModal button").text("시작화면으로").on("click",function(){location.replace("/craft/main")}),h("#newRankModal").modal("show"),anime({targets:"#newRankModal .circle-dark object",scale:[0,1],duration:1200}),anime({targets:"#newRankModal .circle-dark-dashed",rotateZ:360,duration:8e3,loop:!0,easing:"linear"}),showFireworks({target:h("#newRankModal .modal-body")[0],particles:20,distance:100,interval:200,size:15}),anime({targets:e,duration:1e3,scale:[0,1],opacity:[0,1]})):(0==h("#lowVictoryModal").length&&f.querySelector(".craft-layout-content-section").appendChild(createElement({el:"div",id:"lowVictoryModal",class:"modal fade","data-bs-backdrop":"static","data-bs-keyboard":"false",tabIndex:-1,children:[{el:"div",class:"modal-dialog modal-md modal-dialog-centered",children:[{el:"div",class:"modal-content",children:[{el:"div",class:"modal-body row g-0",children:[{el:"div",class:"text-section my-3 text-center text-dark",innerHTML:"We are sorry to inform you that You perished in battle."},{el:"lottie-player",src:"https://assets1.lottiefiles.com/packages/lf20_k8p8cymw.json",background:"transparent",autoplay:!0,speed:"1",loop:!0},{el:"div",class:"button-section row g-1",children:[{el:"button",class:"btn btn-fico",onclick:()=>location.replace("/craft/main"),textContent:"BattleCraft 학습목록으로 가기"}]}]}]}]}]})),h("#lowVictoryModal").modal("show")):f.getElementById("lastBattleModal")||(e=[],0==p&&0==q?e.push({el:"div",class:"text-section my-3 text-center text-dark",innerHTML:"w"==y.markType?"<b>틀린 배틀</b>이 없습니다😎":"<b>보관한 배틀</b>이 없습니다.📁"}):0==p&&q<10&&"true"!=D.get("completed")?e.push({el:"div",class:"text-section my-3 text-center text-dark",innerHTML:`배틀북을 끝까지 풀었거나<br><b>${"w"==y.markType?"틀린":"보관한"} 배틀</b>이 10개 이상 쌓였을 때 플레이 할 수 있습니다.`}):"b"===y.markType?e.push({el:"div",class:"text-section my-3 text-center text-dark",innerHTML:`축하합니다.<br>이 배틀북을 모두 ${0==b?"풀었으니 다른 배틀북도 플레이":'풀어 리뷰 버튼이 활성화 되었습니다.<br><i class="icon fas fa-history"></i> 버튼을 눌러 복습'} 해 보세요.`}):e.push({el:"div",class:"text-section my-3 text-center text-dark",innerHTML:"주어진 배틀을 모두 풀었습니다."}),e.push({el:"div",class:"button-section row g-1",children:[{el:"button",class:"btn btn-fico",onclick:()=>location.replace("/craft/main"),textContent:"BattleCraft 학습목록으로 가기"}]}),"b"!==y.markType&&("true"==D.get("completed")||10<q)&&e[1].children.push({el:"button",class:"btn btn-outline-fico","data-bs-dismiss":"modal",textContent:"첫 배틀부터 다시 플레이",onclick:async()=>{n=!1,p=-1,E=0,v=[],B(),T()}}),f.querySelector(".craft-layout-content-section").appendChild(createElement({el:"div",id:"lastBattleModal",class:"modal fade","data-bs-backdrop":"static","data-bs-keyboard":"false",tabIndex:-1,children:[{el:"div",class:"modal-dialog modal-md modal-dialog-centered",children:[{el:"div",class:"modal-content",children:[{el:"div",class:"modal-body row g-0",children:e}]}]}]})),"b"==y.markType&&h("#lastBattleModal").on("shown.bs.modal",function(){showFireworks(this)})),h("#lastBattleModal").modal("show")}function ee(){f.getElementById("battleExceedModal")||f.querySelector(".craft-layout-content-section").appendChild(createElement({el:"div",id:"battleExceedModal",class:"modal fade","data-bs-backdrop":"static","data-bs-keyboard":"false",tabIndex:-1,children:[{el:"div",class:"modal-dialog modal-md modal-dialog-centered",children:[{el:"div",class:"modal-content",children:[{el:"div",class:"modal-body row g-0",children:[{el:"div",class:"text-section my-3 text-center text-dark",innerHTML:"일일 최대 플레이 횟수에 도달하였습니다.<br>내일 다시 찾아와 주세요."},{el:"div",class:"button-section row g-1",children:[{el:"button",class:"btn btn-fico",onclick:()=>location.replace("/craft/main"),textContent:"BattleCraft 학습목록으로 가기"}]}]}]}]}]})),bootstrap.Modal.getOrCreateInstance(f.getElementById("battleExceedModal")).show()}async function B(){if("step"!==d||"b"!==y.markType)return new Promise(e=>{var t,a=f.querySelector(".progress-bar");b||w?(t=q?(100*E/q).toFixed(1):"0.0",a.ariaValueNow=t,a.textContent=t+"%",a.style.width=t+"%"):(a.textContent="비회원의 플레이는 기록되지 않습니다",a.style.width="100%"),e()});{let a=i;return new Promise((t,e)=>{0==l.length?h.getJSON("https://static.findsvoc.com/data/craft/rank-list.json",e=>{l=e.reverse(),n(),t()}).fail(()=>{alert("계급도를 가져오는데 실패했습니다."),e()}):(n(),t())});function n(){for(let e=0,t=l.length;e<t;e++)if(S.correct>l[e].startValue){r=l[e],i=r.startValue+1,Y=0<e?l[e-1].startValue+1:9999;break}a<i&&(f.getElementById("newRankModal")||f.body.prepend(createElement(H)),h("#newRankModal .modal-body .new-obj").remove(),e=createElement({el:"div",className:"new-obj",style:{position:"absolute",left:"50%",top:"calc(50% + 4vmin)",width:"37.5vmin",height:"50vmin",maxWidth:"50vmin",zIndex:1071,maxHeight:"50vmin",transformOrigin:"center",opacity:0,transform:"translate(-50%,-50%) translateZ(0)",background:`center/ cover url(https://static.findsvoc.com/images/app/craft/${r.rankTitle}.svg) no-repeat`}}),h("#newRankModal .modal-body").append(e),h("#newRankModal").modal("show"),anime({targets:"#newRankModal .circle-dark object",scale:[0,1],duration:1200}),anime({targets:"#newRankModal .circle-dark-dashed",rotateZ:360,duration:8e3,loop:!0,easing:"linear"}),showFireworks({target:h("#newRankModal .modal-body")[0],particles:20,distance:100,interval:200,size:15}),anime({targets:e,duration:1e3,scale:[0,1],opacity:[0,1]}));var e=f.querySelector(".progress-bar"),t=(100*(S.correct-i)/(Y-i)).toFixed(1);e.ariaValueNow=t,e.textContent=t+"%",e.style.width=t+"%"}}}function R(t){c.stop(),f.querySelectorAll("#ttsPlay,.tts-playing").forEach(e=>{t!=e&&(e.matches("#ttsPlay")?e.textContent="play_circle":e.matches(".tts-playing")&&e.classList.remove("tts-playing","blink-2"),e.dataset.playing="false")})}function J(e){anime({targets:".js-solve-btn,.js-next-btn",duration:500,easing:"easeOutQuart",left:e?"110%":"45%"})}h(f).on("click",".js-history",async function(){if(0==a.length&&await h.getJSON("/craft/battlebook/evaluation/list",{...y},e=>{a=e,h(".list-battle-section").empty().append(createElement(Array.from(a,({battleId:e,eng:t,regDate:a},n)=>({el:"div",className:"battle-block js-navigate-to","data-bid":e,children:[{el:"span",className:"number",textContent:n+1},{el:"span",className:"eng",textContent:t},{el:"span",className:"date",textContent:new Date(a).format("yyyy.MM.dd")}]}))))}),this.classList.contains("opened"))this.classList.remove("opened"),anime({targets:".battle-menu-section",bottom:["50vh",0],easing:"linear",duration:150});else{this.classList.add("opened");var t=a.findIndex(({battleId:e})=>e==x.bid);let e=h(".list-battle-section").find(".battle-block").eq(t).addClass("active");e.siblings(".battle-block").removeClass("active"),anime({targets:".battle-menu-section",bottom:[0,"50vh"],easing:"linear",duration:150,changeComplete:()=>{e[0].scrollIntoView()}})}}).on("click",".js-navigate-to",function(){R(),k.querySelector(".tts-block")?.remove(),WebAudioJS.play($),h(".js-next-btn").toggleClass("js-solve-btn js-next-btn").text("확인"),f.querySelector(".craft-layout-content-section").classList.remove("bg-fc-transparent"),anime({targets:".js-result-msg",bottom:0,height:0,duration:500,easing:"easeInOutExpo",complete:e=>e.animatables.forEach(e=>e.target.remove())}),_.disconnect();var e=h(this).index(".battle-block");p=0<e?a[e-1]:0,E=e,B(),T(),h(".js-history").removeClass("opened"),anime({targets:".battle-menu-section",bottom:["50vh",0],easing:"linear",duration:150})}).on("click","#save-btn",function(){WebAudioJS.play(W),h.getJSON("/craft/battle/save",{memberId:b,battleBookId:m,battleId:x.bid,save:!x.saved},t=>{x.saved=t,h(this).addClass("pe-none"),anime({targets:this.closest(".save-button-section"),begin:function(e){e.animatables[0].target.style.transformOrigin="right bottom"},scale:[1,1.7,1],rotate:["0deg","3deg","-3deg","3deg","0deg"],changeComplete:()=>{h(this).removeClass("pe-none").toggleClass("reverse",t);let e=createElement({el:"div",class:"toast battle-save-result-msg fade show",role:"alert","aria-live":"assertive","aria-atomic":"true","data-bs-autohide":"true","data-bs-delay":2e3,textContent:x.saved?"저장되었습니다.":"저장이 취소되었습니다."});this.parentElement.appendChild(e),bootstrap.Toast.getOrCreateInstance(e).show(),e.addEventListener("hidden.bs.toast",()=>e.remove())}})}).always((e,t)=>{"parsererror"==t&&K()})}).on("click",".js-solve-btn",function(){let s=k,o=JSON.parse(x.answer||"[]");var e=JSON.parse(x.example||"[]");let r=!0;switch(h(this).toggleClass("js-solve-btn js-next-btn").text("다음"),h(s).find(".haptic-btn").addClass("pe-none"),h(s).find(".battle-type-block, .ask-block, .simple-ask-block").fadeToggle(),x.battleType){case"1":{let l=[];e.sort(([e],[t])=>e-t).forEach(([a,n],e)=>{o.some(([e,t])=>a===e&&n===t)&&l.push(e)}),s.querySelectorAll(".option").forEach((e,t)=>{l.includes(t)?e.classList.add("right"):e.matches(".selected")&&(r=!1,e.classList.add("wrong"))}),i(s.querySelector(".ask-section .sentence"));break}case"2":s.querySelectorAll(".option,.modifier,.modificand").forEach(e=>{e.matches(".selected")||e.classList.add("unselected"),x.ask.includes("모든")?j.includes(e)&&e.matches(".modifier, .modificand")?e.classList.add("right"):j.includes(e)^e.matches(".modifier, .modificand")&&(r=!1,j.includes(e))&&e.classList.add("wrong"):j.includes(e)&&e.matches(j.indexOf(e)%2?".modificand":".modifier")?e.classList.add("right"):j.includes(e)?(e.classList.add("wrong"),r=!1):e.matches(".modificand.unselected,.modifier.unselected")&&(r=!1)}),s.querySelector(".mod-guide-text").remove(),i(s.querySelector(".ask-section .sentence"));break;case"3":{var t=s.querySelector(".example-btn-section .active"),n=t.textContent;let a=Array.from(s.querySelectorAll(".example-btn-section button")).indexOf(t);r=o.includes(n),s.querySelectorAll(".pick-right .pick-option").forEach((e,t)=>{t===a?(t=r?"right":"wrong",e.classList.add(t)):r||e.classList.add("right")}),s.querySelector(".example-btn-section").style.display="none",i(s.querySelector(".ask-section .sentence"));break}case"4":{let n=h(s).find(".example-btn-section .active").index(),l=[];e.sort(([e],[t])=>e-t).forEach(([a,n],e)=>{null!=o.find(([e,t])=>a==e&&n==t)&&l.push(e)}),i(s.querySelector(".ask-section .sentence")),s.querySelector(".example-btn-section").style.display="none",s.querySelectorAll(".sentence .option,.sentence .answer-wrong").forEach((e,t)=>{var a;l.includes(t)?(e.classList.add("right"),a=createElement({el:"span",className:"original-text",style:{opacity:0,position:"absolute",left:e.offsetLeft-14+"px",top:e.offsetTop+"px"},children:[{el:"span",className:"label-text",textContent:"정답 : "},{el:"span",textContent:e.dataset.answer}]}),e.parentElement.appendChild(a),anime({targets:a,top:"-=30",opacity:1,delay:600})):t==n&&(r=!1,e.classList.add("wrong"))});break}case"5":r=s.querySelector(".arranged-example-section").textContent.replace(/\W/g,"").trim()==x.eng.replace(/\W/g,"").trim(),s.querySelector(".arranged-example-section").prepend(createElement({el:"div",className:"full-sentence",textContent:x.eng})),s.querySelector(".example-btn-section").style.display="none",i(s.querySelector(".arranged-example-section .full-sentence"));break;case"6":let a=Array.from(e,([[],e])=>e.split(/\s+/)).reduce((e,t)=>e.concat(t),[]);s.querySelectorAll(".example-btn-section input").forEach((e,t)=>{e.value.trim().toLowerCase()==a[t].toLowerCase()?e.className="right":(e.className="wrong",r=!1)}),s.querySelector(".arranged-example-section").prepend(createElement({el:"div",className:"full-sentence",textContent:x.eng})),i(s.querySelector(".arranged-example-section .full-sentence"));break;case"7":{let t=Array.from(o,e=>e.replace(/[,.!?]$/,""));s.querySelectorAll(".arranged-example-section .btn").length!=o.length?(s.querySelectorAll(".arranged-example-section .btn").forEach(e=>{t.includes(e.textContent)?e.classList.add("right"):e.classList.add("wrong")}),r=!1):s.querySelectorAll(".arranged-example-section .btn").forEach(e=>{t.includes(e.textContent)?e.classList.add("right"):(e.classList.add("wrong"),r=!1)}),s.querySelector(".arranged-example-section").prepend(createElement({el:"div",className:"full-sentence",textContent:o.join(" ")})),s.querySelector(".example-btn-section").style.display="none",i(s.querySelector(".ask-section .sentence"));break}case"8":var t=s.querySelector(".example-btn-section .active"),n=(i(s.querySelector(".ask-section .sentence")),s.querySelector(".example-btn-section").style.display="none",r=o.includes(t.textContent),s.querySelector(".sentence .pick-right"));n.textContent=r?o[0]:t.textContent,n.classList.add(r?"right":"wrong"),r||(t=createElement({el:"span",className:"original-text",style:{opacity:0,position:"absolute",left:n.offsetLeft-14+"px",top:n.offsetTop+"px"},children:[{el:"span",className:"label-text",textContent:"정답 : "},{el:"span",textContent:o[0]}]}),n.parentElement.appendChild(t),anime({targets:t,top:"-=30",opacity:1,delay:600}))}function i(e){e.appendChild(createElement({el:"div",className:"tts-block text-end",style:{transform:"scale(0)"},children:[{el:"button",id:"ttsPlay",class:"btn d-inline w-auto text-info ms-2 p-0 material-icons-outlined fs-2 border-0 shadow-none bg-transparent","data-bs-toggle":"tooltip",title:"문장 듣기/중지","data-playing":"false",textContent:"play_circle",onclick:function(){"true"==this.dataset.playing?R():(R(this),this.dataset.playing="true",this.textContent="stop_circle",c.speakRepeat(x.eng,2,1e3,()=>{this.dataset.playing="false",this.textContent="play_circle"}))}},{el:"button",id:"ttsSetting",class:"btn d-inline w-auto text-info ms-2 p-0 material-icons-outlined fs-2 border-0 shadow-none bg-transparent","data-bs-toggle":"tooltip",title:"음성 설정",textContent:"tune",onclick:function(){R(),c.openSettings()}}]})),anime({targets:s.querySelector(".tts-block"),scale:1,delay:600,complete:()=>{c.autoEnabled()&&s.querySelector("#ttsPlay")?.dispatchEvent(new Event("click"))}})}"b"===y.markType&&(u.count++,g.localStorage.setItem("TCBSC_"+ntoa(b),JSON.stringify(u))),WebAudioJS.play(r?F:P);var a=createElement({el:"div",class:"js-result-msg result-toast",style:{transformOrigin:"top"}});f.querySelector(".craft-header-section").append(a),anime.timeline({targets:a}).add({begin:function(e){e=e.animatables[0].target;e.textContent=r?"정답입니다.":"오답입니다.",e.style.visibility="visible",e.style.color="#00000000",e.style.backgroundColor=r?"#00bcd4":"#f44336"},bottom:"-2em",width:["2rem","50%"],height:["0rem","2rem"],duration:1e3,easing:"easeInOutExpo"}).add({color:"#FFF",easing:"linear"}),r||(g.ANI&&g.ANI?.vibrate?g.ANI.vibrate([200,50,100,50,100]):navigator?.vibrate&&navigator.vibrate([200,50,100,50,100])),p=x.bid;let l={memberId:b,ageGroup:C,battleBookId:m,battleBookMarkId:y.markId,battleId:x.bid,correct:r,save:Boolean(x.saved)};0==b&&null!=w&&(l.memberId56=w),null!=y&&null!=y.markType&&(l.markType=y.markType),h(s).find(".explain-section").slideDown(500).find(".comment-section").html(x.comment||"작성된 코멘트가 없습니다."),h.getJSON("/craft/battle/"+x.sentenceId,e=>{return t=x.eng,a=s.querySelector(".explain-section"),n=e,a.querySelector(".trans-section").replaceChildren(createElement(Array.from(n.korList,(e,t)=>({el:"div",className:"row",children:[{el:"div",className:"col-auto ps-2 pe-0",children:[{el:"span",className:"material-icons "+(t>=n.korList.length-3?"ai-trans":"user-trans")}]},{el:"div",className:"trans-text col",textContent:e.kor}]})))),a.querySelector(".words-section").replaceChildren(0<n.wordList.length?createElement(Array.from(n.wordList,t=>({el:"span",class:"one-word-unit-section","data-sentence-id":n.svocTag.sentenceId,children:[{el:"span",class:"title",textContent:t.title,"data-playing":"false",onclick:function(e){e.stopPropagation(),"true"==this.dataset.playing?R():(R(this),this.dataset.playing="true",this.classList.add("tts-playing","blink-2"),c.speakRepeat(t.title,2,500,()=>{this.classList.remove("tts-playing","blink-2"),this.dataset.playing="false"}))}}].concat(Array.from(t.senseList,(e,t)=>({el:"span",class:"one-part-unit-section"+(0<t?" ms-2":""),children:[{el:"span",class:"part",textContent:e.partType},{el:"span",class:"meaning",textContent:e.meaning}]})))}))):"해당 문장에서 fico AI가 설정한 난이도 이상의 단어를 찾지 못했습니다."),h(a).find(".collapse").collapse("show"),tandem.showSemanticAnalysis(t,n.svocTag.svocBytes,h(a).find(".svoc-section").empty()).then(()=>_.observe(a.lastElementChild)),f.querySelector(".craft-header-section").classList.remove("min"),f.querySelector(".scrolling-section").style.marginTop="0",void scrollTo(0,75);var t,a,n}).always((e,t)=>{"parsererror"==t?K():h.ajax({url:"/craft/battle/evaluation/add",type:"GET",contentType:"application/json",data:l,success:async()=>{if(b||w){if(r&&S.correct++,0==b){var e,t=(await idb.openDB(N,I)).transaction(L,"readwrite");for await(e of t.objectStore(L).index("bid").iterate(ntoa(x.bid))){var a={...e.value,solve:r?"O":"X"};e.update(a)}await t.done}J(!0),null!=E&&E++,B(),"b"===y.markType&&E>=q&&h.getJSON("/craft/battlebook/"+d,{...y,lastBattleId:-1})}else J(!0),null!=E&&E++},error:()=>alert("채점 전송에 실패했습니다. 재로그인 후 다시 시도해 주세요."),complete:(e,t)=>{"parsererror"==t&&K()}})})}).on("click",".js-next-btn",function(e){R(),"b"===y.markType&&u.count>=z?(ee(),e.preventDefault(),e.stopPropagation()):(k.querySelector(".tts-block")?.remove(),WebAudioJS.play($),h(this).toggleClass("js-solve-btn js-next-btn").text("확인"),f.querySelector(".craft-layout-content-section").classList.remove("bg-fc-transparent"),anime({targets:".js-result-msg",bottom:0,height:0,duration:500,easing:"easeInOutExpo",complete:e=>e.animatables.forEach(e=>e.target.remove())}),_.disconnect(),(0<v.length?A:n?O:T)())}).on("shown.bs.collapse",".svoc-section",function(){tandem.correctMarkLine(this.querySelector(".semantics-result"))}).on("click",".haptic-btn",function(){this.textContent.match(/[^\w\s,.!?'"]/)?WebAudioJS.play(W):c.speak(this.textContent)}),g.craft=Object.assign({},g.craft,{initPlayer:async function(e,t,a,n,l){if(d=location.pathname.match(/(?:\/craft\/battle\/)(\w+)/)[1],S=t,(y=a).regDate=new Date(a.regDate),(b=a?.memberId||0)||(z=25),m=a.battleBookId,p=a.lastBattleId,null!=n&&(E=n),null!=l&&(q=l),"b"===y.markType)if(g.localStorage.getItem("TCBSC_"+ntoa(b))){if((u=JSON.parse(g.localStorage.getItem("TCBSC_"+ntoa(b)))).date!=(new Date).toLocaleDateString())u.date=(new Date).toLocaleDateString(),u.count=0;else if(u.count>=z)return void ee()}else u={date:(new Date).toLocaleDateString(),count:0};["w","s"].includes(y.markType)&&(0==q||"true"!=D.get("completed")&&q<10)&&O(),b?M(e):(h("#save-btn").addClass("opacity-50"),h(f).off("click","#save-btn"),f.querySelector(".save-button-section").dataset.bsToggle="tooltip",f.querySelector(".save-button-section").title="배틀 보관 기능은 fico 회원에게 제공됩니다.",h(".save-button-section").tooltip("hide"),"undefined"==typeof Cookies&&await h.cachedScript("https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"),(w=Cookies.get("FMID"))?(await h.cachedScript("https://cdn.jsdelivr.net/npm/idb@7/build/umd-with-async-ittr.js"),await h.cachedScript("https://cdn.jsdelivr.net/npm/pako/dist/pako.min.js"),L=Z[d]+ntoa(m),s.age=parseInt(localStorage.getItem("FM_AGE")),S={correct:0,incorrect:0},(await indexedDB.databases()).forEach(({name:e,version:t})=>e==N&&t>=I&&(I=t)),idb.openDB(N,I,{async upgrade(e,t,a,n){var l=e.createObjectStore(L,{autoIncrement:!0});if(l.createIndex("bid","bid"),l.createIndex("data","data"),l.createIndex("solve","solve"),1==t){var s,t=await n.objectStore("StepBattle").getAll();t.sort((e,t)=>e.data.rnum-t.data.rnum);for(s of t)await l.add({...s,bid:ntoa(s.bid),data:Q(s.data)});e.deleteObjectStore("StepBattle")}}}).then(async a=>{if(a.objectStoreNames.contains(L)){let e=0,t=await a.transaction(L).store.openCursor();for(E=0;t;){var n=X(t.value.data);/[OX]/.test(t.value.solve)?(S["O"==t.value.solve?"correct":"incorrect"]++,"step"!==d?p=n.bid:n.rnum>e&&(e=n.rnum,p=n.bid),E++):v.push(n),t=await t.continue()}"step"==d&&v.sort((e,t)=>e.rnum-t.rnum),M(s.age)}else a.close(),await idb.openDB(N,++I,{upgrade(e){e=e.createObjectStore(L,{autoIncrement:!0});e.createIndex("bid","bid"),e.createIndex("data","data"),e.createIndex("solve","solve"),M(s.age)}})})):M(20))}})}(jQuery,window,document);
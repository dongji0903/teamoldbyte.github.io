!function(v,c,k){v.cachedScript=v.cachedScript||function(e,t){return v.ajax(v.extend(t||{},{dataType:"script",cache:!0,url:e}))};let a,l,N,q=[],o,i,d,n,s;const u="findsvoc-idb";let p,h,b,w=[];function m(){var e=l?"/"+ntoa(l):"",e=`/craft/battle/${a}${e}/next`;v.getJSON(e,function(e){0==(q=e).length?alert("조회된 문제가 없습니다."):(0==o&&((p=c.indexedDB.open(u,1)).onsuccess=function(){const e=(h=this.result).transaction(["Battle"],"readwrite");b=e.objectStore("Battle"),(p=b.openCursor()).onsuccess=function(){const e=this.result;var t,n;e&&([t,n]=atob(e.key).split("_"),_findTargetAndToggleClass(t,n,e.value.checked),e.continue())}}),t())}).fail(()=>alert("새로운 문제를 조회할 수 없습니다."))}function t(){N=q.shift(),w=[];const a=k.getElementById("battle-"+N.battleType),e=(a.querySelector(".battle-type").textContent=N.battleType,v(a).show().siblings(".battle-section").hide(),anime({targets:a,easing:"linear",duration:100,left:["100vw",0]}),v(a).find(".explain-section").hide().find(".collapse").collapse("hide"),a.querySelector(".ask")),r=a.querySelector(".sentence"),l=N.eng;var t=JSON.parse(N.answer||"[]");const n=JSON.parse(N.example||"[]");let o=0,i,d=[];const u=[];switch(N.battleType){case"1":e.textContent=`다음 문장의 ${N.ask}를 선택하세요.`,n.forEach(([e,t],n,s)=>{(i=l.substring(o,e))&&u.push(i),u.push({el:"span",role:"button",className:"option",textContent:l.substring(e,t),onclick:function(){v(this).toggleClass("selected"),v(a).find(".js-solve-btn").prop("disabled",0==r.querySelectorAll(".selected").length)}}),n==s.length-1&&t<l.length&&u.push(l.substring(t)),o=t}),r.replaceChildren(createElement(u));break;case"2":N.ask.includes("모든")?e.textContent=`${N.ask.includes("피수식")?"피수식어":"수식어"}를 모두 선택하세요.`:e.textContent=`[${N.ask}] 수식어와 피수식어를 선택하세요.`;var[s,c]=t;const p={el:"span",role:"button",onclick:function(){var e;this.matches(".selected")?(e=w.indexOf(this),w.splice(e,1)[0].classList.remove("selected"),N.includes("모든")||(e=e<2*Math.floor(e/2)+(1-e%2)?e:e-1,w[e]&&w.splice(e,1)[0].classList.remove("selected"))):(this.classList.add("selected"),w.push(this)),a.querySelector(".js-solve-btn").disabled=0==w.length}},h=Array.from(s,e=>e.concat("modifier")).concat(Array.from(c,e=>e.concat("modificand")));h.sort(([e],[t])=>e-t).forEach(([e,t,n],s,r)=>{(i=l.substring(o,e))&&(i.includes(" ")?Array.from(i.split(" ").filter(e=>0<e.length),e=>Object.assign({className:"option d-inline-block",textContent:e},p)).forEach(e=>u.push(e," ")):u.push(i," ")),u.push(Object.assign({className:n+" d-inline-block",textContent:l.substring(e,t)},p)),t<l.length&&u.push(" "),s==r.length-1&&t<l.length&&(-1<l.indexOf(" ",t)?Array.from(l.substring(t).split(" ").filter(e=>0<e.length),e=>Object.assign({className:"option d-inline-block",textContent:e},p)).forEach(e=>u.push(e," ")):u.push(l.substring(t))),o=t}),r.replaceChildren(createElement(u));break;case"3":const[[b,m],g,f]=n;(i=l.substring(o,b))&&u.push(i),d=[g,f].sort(()=>Math.random()-.5),u.push({el:"span",className:"pick-right","data-answer":g,textContent:`[ ${d.join(" / ")} ]`}),m<l.length&&u.push(l.substring(m)),r.replaceChildren(createElement(u)),a.querySelector(".example-btn-section").replaceChildren(createElement(Array.from(d,e=>({el:"button",className:"btn btn-outline-fico w-100",textContent:e,onclick:function(){v(this).addClass("active").siblings().removeClass("active"),a.querySelector(".js-solve-btn").disabled=!1}}))));break;case"4":const[[x,y],C,S]=t;n.sort(([e],[t])=>e-t).forEach(([e,t],n,s)=>{(i=l.substring(o,e))&&u.push(i);let r=l.substring(e,t);const c={el:"span",className:"option text-decoration-underline",textContent:r};x==e&&y==t&&(c.className="answer-wrong text-decoration-underline",c.textContent=S,r=S,c["data-answer"]=C),u.push(c),d.push({el:"button",className:"btn btn-outline-fico w-100",textContent:r,onclick:function(){v(this).addClass("active").siblings().removeClass("active"),a.querySelector(".js-solve-btn").disabled=!1}}),n==s.length-1&&t<l.length&&u.push(l.substring(t)),o=t}),r.replaceChildren(createElement(u)),a.querySelector(".example-btn-section").replaceChildren(createElement(d));break;case"5":r.replaceChildren(N.kor),n.sort(()=>Math.random()-.5).forEach(([e,t])=>{d.push({el:"button",className:"btn btn-outline-fico mb-1",textContent:l.substring(e,t),onclick:function(){if(!this.closest(".arranged-examples")&&!this.matches(".text-secondary.bg-secondary")){const e=this.cloneNode(!0);a.querySelector(".arranged-examples").appendChild(e),e.onclick=()=>{e.remove(),v(this).removeClass("text-secondary bg-secondary"),a.querySelector(".js-solve-btn").disabled=0==a.querySelector(".arranged-examples").childElementCount},v(this).addClass("text-secondary bg-secondary")}a.querySelector(".js-solve-btn").disabled=0==a.querySelector(".arranged-examples").childElementCount}})}),a.querySelector(".example-btn-section").replaceChildren(createElement(d)),a.querySelector(".arranged-examples").replaceChildren(),a.querySelector(".arranged-examples").style.height=.5*a.querySelector(".example-btn-section").clientHeight+"px"}}function g(e,n){let s=0,r=[];return e.childNodes.forEach(e=>{var t=e.textContent.replaceAll(/[\n\u200b]/gm,"").length;e.className&&("string"==typeof n?e.matches(n):e==n)&&r.push([s,s+t]),s+=t}),r}function f(){s=3500<d.correct?n=3501:2500<d.correct?(n=2501,3501):2e3<d.correct?(n=2001,2501):1600<d.correct?(n=1601,2001):1300<d.correct?(n=1301,1601):1100<d.correct?(n=1101,1301):900<d.correct?(n=901,1101):700<d.correct?(n=701,901):600<d.correct?(n=601,701):500<d.correct?(n=501,601):400<d.correct?(n=401,501):300<d.correct?(n=301,401):200<d.correct?(n=201,301):150<d.correct?(n=151,201):100<d.correct?(n=101,151):50<d.correct?(n=51,101):20<d.correct?(n=21,51):(n=0,21);const e=k.querySelector(".progress-bar");var t=(100*(d.correct-n)/s).toFixed(1);e.ariaValueNow=t,e.textContent=t+"%",e.style.width=t+"%"}v(k).on("click",".js-solve-btn",function(){const s=this.closest(".battle-section"),r=JSON.parse(N.answer||"[]"),e=JSON.parse(N.example||"[]");let c=!0;switch(v(this).toggleClass("js-solve-btn js-next-btn").text("다음"),v(s).find(".battle-type-block").slideUp(),v(s).find(".sub-block,.example-btn-section,.arranged-examples").addClass("pe-none"),N.battleType){case"1":const l=[];e.sort(([e],[t])=>e-t).forEach(([n,s],e)=>{null!=r.find(([e,t])=>n==e&&s==t)&&l.push(e)}),s.querySelectorAll(".option").forEach((e,t)=>{l.includes(t)?e.className="text-primary":e.matches(".selected")&&(c=!1,e.className="text-danger")});break;case"2":let[t,n]=Array.from(r,e=>Array.from(e,e=>JSON.stringify(e)));s.querySelectorAll(".option").forEach(e=>{t.includes(JSON.stringify(g(s,e)[0]))||n.includes(JSON.stringify(g(s,e)[0]))?e.className="text-primary":e.matches(".selected")&&(c=!1,e.className="text-danger")});break;case"3":var a=s.querySelector(".example-btn-section .active").textContent;c=!!r.includes(a);break;case"4":a=v(s).find(".example-btn-section .active").index();c=a==Array.from(e,e=>JSON.stringify(e)).indexOf(JSON.stringify(r[0]));break;case"5":c=s.querySelector(".arranged-examples").textContent.replace(/\W/g,"").trim()==N.eng.replace(/\W/g,"").trim()}alert(c?"맞혔습니다":"틀렸습니다");var t={memberId:o,ageGroup:i,battleId:N.bid,correct:c,save:!1};v(s).find(".explain-section").show().find(".comment-section").text(N.comment),v.getJSON("/craft/battle/"+N.sentenceId,e=>{var t=N.eng,n=s.querySelector(".explain-section");v(n).find(".comment-section").collapse("show"),tandem.showSemanticAnalysis(t,e.svocTag.svocBytes,v(n).find(".svoc-section").empty()),n.querySelector(".trans-section").replaceChildren(createElement(Array.from(e.korList,e=>({el:"span",className:"text-fc-red ms-3",style:"display: list-item",textContent:e.kor})))),n.querySelector(".words-section").replaceChildren(createElement(Array.from(e.wordList,(e,t)=>({el:"span",class:"one-word-unit-section"+(0<t?" ms-3":""),children:[{el:"span",class:"title fw-bold text-blue-700",textContent:e.title}].concat(Array.from(e.senseList,e=>({el:"span",class:"one-part-unit-section ms-2",children:[{el:"span",class:"part text-palegreen",textContent:e.partType},{el:"span",class:"meaning ms-1",textContent:e.meaning}]})))}))))}),v.ajax({url:"/craft/battle/evaluation/add",type:"GET",contentType:"application/json",data:t,success:()=>{c&&d.correct++,f()},error:()=>alert("채점 전송에 실패했습니다. 재로그인 후 다시 시도해 주세요.")})}).on("click",".js-next-btn",function(){this.disabled=!0;const e=v(this).toggleClass("js-solve-btn js-next-btn").text("확인").closest(".battle-section");e.find(".battle-type-block").slideDown(),e.find(".sub-block,.example-btn-section,.arranged-examples").removeClass("pe-none"),(0<q.length?t:m)()}).on("shown.bs.collapse",".svoc-section",function(){tandem.correctMarkLine(this.querySelector(".semantics-result"))}),c.craft=Object.assign({},c.craft,{initPlayer:function(e,t,n,s,r){o=e,l=s,a=n,d=r,i=t<13?"E":t<16?"M":t<19?"H":"C",f(),0==o&&((p=c.indexedDB.open(u,1)).onsuccess=function(){const e=(h=this.result).transaction(["FreeMembership","Battle"],"readonly");b=e.objectStore("Battle"),(p=b.openCursor()).onsuccess=function(){const e=this.result;var t,n;e&&([t,n]=atob(e.key).split("_"),_findTargetAndToggleClass(t,n,e.value.checked),e.continue())}},p.onupgradeneeded=function(){h=this.result,(b=h.createObjectStore("Battle")).createIndex("id","id",{unique:!1}),b.createIndex("checked","checked",{unique:!1})}),m()}})}(jQuery,window,document);
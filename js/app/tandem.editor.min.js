((v,b,C)=>{let u=[],a=[],g,y,s,i,c,d,m,p,h,w,x={49:'[value="s"]',50:'[value="rs"]',51:'[value="ss"]',52:'[value="v"]',53:'[value="o"]',54:'[value="io"]',55:'[value="do"]',56:'[value="ro"]',57:'[value="po"]',48:'[value="c"]',189:'[value="oc"]',187:'[value="a"]',81:'[value="tor"]',87:'[value="to"]',69:'[value="ger"]',82:'[value="go"]',84:'[value="ptc"]',89:'[value="ptco"]',85:'[value="ptcphr"]',65:'[value="phr"]',83:'[value="advphr"]',68:'[value="adjphr"]',70:'[value="conj"]',71:'[value="ccls"]',72:'[value="pcls"]',74:'[value="ncls"]',75:'[value="acls"]',76:'[value="advcls"]',186:'[value="pcl"]',90:'[value="mod"]',88:'[value="erasing"]',67:'[value="comment"]',ctrlS:'[value="save"]',ctrlZ:'[value="undo"]:not([disabled])',ctrlY:'[value="redo"]:not([disabled])'},k,E=0,R=0,N={},P={rs:"s",io:"o",do:"o",ro:"o"},S={s:"S",rs:"(진)s",v:"V",o:"O",io:"i.o.",do:"d.o.",po:"(전)o",ro:"(진)o",to:"(부)o",go:"(동)o",ptco:"(분)o",appo:"동격",c:"C",oc:"o.c.",m:"M",a:"A"},A={a:"부사적 보충어",ss:"의미상 주어",tor:"to부정사",ger:"동명사",ptc:"분사",to:"to부정사 목적어",go:"동명사 목적어",ptco:"분사 목적어",appo:"동격 =>",ncls:{s:"주어절",o:"목적어절",c:"보어절",oc:"목적보어절",m:"관계절",po:"전치사 목적어절",to:"to부정사 목적어절",go:"동명사 목적어절",ptco:"분사 목적어절",appo:"동격 =>",interr:"의문사절 접속사",nrp:"명사적 관계사",nclc:""},acls:"형용사절",advcls:"부사절",phr:"전치사구",adjphr:"형용사구",advphr:"부사구",ptcphr:"부사구(분사구문)",ccls:"등위절",pcls:"병렬절",pcl:"삽입절"};function F(e){g.find('[value="undo"], [value="redo"]').prop("disabled",!0),g.find("button").removeClass("active").each((e,t)=>{bootstrap?.Tooltip?.getInstance(t)?.hide()}),e.unwrap(),u=[],a=[],v(".svoc-editor-badge,.svoc-editor-emblem").remove(),g.detach(),y.detach(),N.cancelCallback()}function T(e){var t=e.dataset.seq;u.push([t,e.innerHTML]),a=[],v('.svoc-toolbar [value="undo"]').prop("disabled",!1)}function M(e){return e.hasChildNodes()?M(e.firstChild):e}function O(e,t,o){var a=e.getClientRects()[0];v(b.body).append({ncls:c,tor:m,ger:p,ptc:h}[t].css("top",scrollY+a.top+a.height+"px").css("left",scrollX+a.left+"px").data("range",e).data("wrapperEl",o))}function j(e){v(e).find(".sem").filter((e,t)=>0==t.textContent.length).remove(),C.checkPOSDepth(e),C.wrapWithBracket(e),C.splitInners(e),C.trimTextContent(e),C.correctMarkLine(e),v(".edit-svoc").focus()}v.fn.svoceditor=async function(e,t,o){return N={forNew:e,saveCallback:t,cancelCallback:o},"close"==e?(void 0!==g&&g.detach(),void 0!==y&&y.detach()):(void 0===g&&(await v.get("https://static.findsvoc.com/css/app/tandem.editor.min.css",e=>{var t=b.createElement("style");t.innerHTML=e,b.head.append(t)}),await v.get("https://static.findsvoc.com/fragment/tandem/editor_template.min.html",e=>{g=v(e).find("#js-edit-toolbar"),c=v(e).find(".cls-role-menu"),d=v(e).find(".cls-conj-menu"),m=v(e).find(".tor-role-menu"),p=v(e).find(".ger-role-menu"),h=v(e).find(".ptc-role-menu"),w=v(e).find(".edit-comment"),g.find('[data-bs-toggle="tooltip"]').click(function(){bootstrap?.Tooltip?.getInstance(this)?.hide()}).tooltip({trigger:"hover"});let r=parseFloat(getComputedStyle(b.body).fontSize),n=(v(b).on("keydown",function(e){v(e.target).is("input")&&0<v(e.target).closest(".edit-comment").length&&27==e.keyCode?v(e.target.form).find("button:eq(1)").trigger("click"):v(".edit-svoc")?.is(":focus")&&((e.ctrlKey||e.metaKey)&&65<=e.keyCode&&e.keyCode<=90?x["ctrl"+e.key.toUpperCase()]&&(e.preventDefault(),g.find(x["ctrl"+e.key.toUpperCase()]).trigger("click")):v(e.target).is("input")||null==x[e.keyCode]||g.find(x[e.keyCode]).trigger("click"))}),g.on("click",'[value="save"]',function(){var o,e=this.closest(".edit-svoc").querySelector(".semantics-result");for(v(e).closest(".edit-svoc").addClass("pe-none").find(".svoc-editor-badge").html('<i class="fas fa-spinner fa-spin"></i> 저장중').animate({width:"100%"});null!=e.querySelector(".brkt,.line-end,canvas.curved_arrow");)e.querySelector(".brkt,.line-end,canvas.curved_arrow").remove();o=e,requestAnimationFrame(async function(){var e=await C.getSvocBytes(o),e=(C.wrapWithBracket(o),C.correctMarkLine(o),u=[],a=[],g.find('[value="undo"], [value="redo"]').prop("disabled",!0),N.saveCallback(e));function t(e){setTimeout(()=>{y.text(""),v(o).unwrap(),g.find('[value="undo"], [value="redo"]').prop("disabled",!0),g.find("button").removeClass("active").each((e,t)=>{bootstrap?.Tooltip?.getInstance(t)?.hide()}),v(".svoc-editor-badge,.svoc-editor-emblem").remove(),g.detach(),y.detach(),e?.call()},2e3)}e&&e.then&&e.fail?e.then(function(){v(".svoc-editor-badge").html('<i class="fas fa-check"></i> 저장됨'),t()}).fail(function(){v(".svoc-editor-badge").html('<i class="fas fa-ban"></i> 저장실패'),F(v(o))}):(v(".svoc-editor-badge").html('<i class="fas fa-check"></i> 저장됨'),t())})}).on("click",'[value="close"]',function(){var e,t;confirm("수정내역은 저장되지 않습니다.\n편집모드를 종료하시겠습니까?")&&(e=v(this).closest(".edit-svoc").find(".semantics-result"),0<u.length&&(t=u.shift(),e.html(t[1]),v(".erasing-target").toggleClass("erasing-target"),v(".mod-start,.mod-indicator").remove(),C.drawConnections(e[0]),e.animate({opacity:.5},100).animate({opacity:1},100)),F(e))}).on("click","[data-mode]:not([disabled])",function(){if("undo"==this.dataset.mode)return!0;let e=getSelection(),t;if(v(".svoc-toolbar .active").add(this).toggleClass("active"),v(".erasing-target, .comment-target").removeClass("erasing-target comment-target"),v(".mod-start,.mod-indicator").remove(),v(this).is(".active")){var o=this.dataset.mode;switch(v(".edit-svoc").attr("data-mode",o),o){case"role":case"wrap":e.isCollapsed?y.text("적용 텍스트를 드래그 하세요."):(v(".edit-svoc").trigger("mouseup",this.value).attr("data-mode",null),v(this).removeClass("active"));break;case"erasing":y.html("지우려는 태그를 클릭 하세요.<br><h6>하위태그 모두 선택 : shift+클릭</h6>"),e.removeAllRanges();break;case"mod":y.text("수식어 위치를 클릭 하세요."),e.removeAllRanges();break;case"comment":y.text("문법 코멘트를 추가할 요소를 선택하세요."),e.removeAllRanges();break;case"cleft":e.isCollapsed?y.text("적용 텍스트를 드래그 하세요.(It is[was]부터 that까지 한 번에)\nthat 대신 who,where 등 가능"):(v(".edit-svoc").trigger("mouseup",this.value).attr("data-mode",null),v(this).removeClass("active"))}if(e.isCollapsed){let e;if(b.caretPositionFromPoint)t=b.caretPositionFromPoint(E,R),e=M(t.offsetNode);else{if(!b.caretRangeFromPoint)return console.error("[This browser supports neither document.caretRangeFromPoint nor document.caretPositionFromPoint.]"),!1;t=b.caretRangeFromPoint(E,R),e=t.startContainer}for(;1!=e.nodeType;)e=e.parentNode;v(e).trigger("mouseover")}}else v(".edit-svoc").attr("data-mode",null),y.empty()}).on("click",'[value="undo"], [value="redo"]',function(e){var t;e.preventDefault(),("undo"==this.value||"redo"==this.value&&0<a.length)&&(this.classList.add("active"),e=("undo"==this.value?u:a).pop(),t=v(`.edit-svoc .semantics-result[data-seq="${e[0]}"]`),("undo"==this.value?a:u).push([t.attr("data-seq"),t.html()]),t.html(e[1]),v(".erasing-target").toggleClass("erasing-target"),v(".mod-start,.mod-indicator").remove(),C.drawConnections(t[0]),t.animate({opacity:.5},100).animate({opacity:1},100),v('.svoc-toolbar [value="undo"]').prop("disabled",0==u.length),v('.svoc-toolbar [value="redo"]').prop("disabled",0==a.length),setTimeout(()=>{this.classList.remove("active")},50))}),[]),l=null,t=!1;function f(){v(b).on("mouseover",'[data-mode="comment"] .semantics-result .sem',function(e){null!=this.dataset.gc&&0!=this.dataset.gc.length||(e.stopPropagation(),this.classList.add("comment-target"))}).on("mouseout",'[data-mode="comment"] .semantics-result *',function(){v(".comment-target").removeClass("comment-target")})}v(b).on("mouseover",'[data-mode="erasing"] .semantics-result *',function(t,o){t.stopPropagation();var a=t.target;if(l=a,s(),v(a).is(".curved_arrow"))for(var e of a.classList)-1<e.indexOf("mfd")&&(v(this).siblings(".curved_arrow."+e).each(function(){n.push(this)}),n.push(v(".rcm.mfd-"+e.substring(3))[0]));function s(){if(null!=a){if(n.push(a),o||t.shiftKey)for(var e of a.getElementsByTagName("span"))n.push(e);a.textContent==a.parentElement.textContent?(a=a.parentElement,n.push(a)):0<a.children.length&&a.children[0].textContent==a.textContent&&n.push(a.children[0])}}null!=a.previousElementSibling&&v(a.previousElementSibling).is('[class*="-start"]:not([class*="cmnt-align-start"])')&&null!=a.nextElementSibling&&v(a.nextElementSibling).is('[class*="-end"]')&&(n.push(a.previousElementSibling),n.push(a.nextElementSibling)),-1<a.className.indexOf("-start")?(a=a.nextElementSibling,s(),null!=a&&null!=a.nextElementSibling&&(a=a.nextElementSibling,n.push(a))):-1<a.className.indexOf("-end")&&(a=a.previousElementSibling,s(),null!=a)&&null!=a.previousElementSibling&&(a=a.previousElementSibling,n.push(a)),n.forEach(function(e){e.classList.add("erasing-target")})}).on("mouseout",'[data-mode="erasing"] .semantics-result *',function(e){n.forEach(function(e){v(e).removeClass("erasing-target")}),n=[],l=null,e.stopPropagation()}).on("keydown keyup",function(e){("keydown"==e.type&&!t&&e.shiftKey||"keyup"==e.type&&t&&!e.shiftKey)&&(t=!t,v(b.body).toggleClass("shift",t),null!=l)&&v(l).trigger("mouseout").trigger("mouseover",[t])}).on("click",".erasing-target",function(e){var t=e.target.closest(".semantics-result")||e.target;t.closest('[data-mode="erasing"]')&&(T(t),n.forEach(function(e){0==e.textContent.length||e.matches(".brkt")?v(e).remove():v(e).contents().unwrap()})),v(t).find(".rcm").each(function(){for(var e of this.classList)-1<e.indexOf("mfd")&&0==v(`[data-mfd="${e.substring(4)}"]`).length&&v(this).contents().unwrap()}),v(t).find("[data-mfd]").each(function(){0==v(".rcm.mfd-"+this.dataset.mfd).length&&delete this.dataset.mfd}),e.shiftKey&&getSelection().removeAllRanges(),j(t)}).on("mouseup",'.edit-svoc[data-mode="role"], .edit-svoc[data-mode="wrap"]',function(e,a){e.stopPropagation();var e=g.find(".active").val(),s=getSelection(),n=s?.anchorNode?.parentElement?.closest(".semantics-result");if(!s.isCollapsed){if(T(n),"role"==this.dataset.mode){n=s;var r=a||e;let t=n.getRangeAt(0),o=b.createElement("span");o.className="sem "+(P[r]??r),null!=S[r]&&(o.dataset.rc=S[r],o.dataset.rcMin=S[r]),"string"==typeof A[r]&&(o.dataset.gc=A[r]);try{t.surroundContents(o)}catch(e){o.appendChild(t.extractContents()),t.insertNode(o)}t.detach(),n.removeAllRanges(),["tor","ptc"].includes(r)&&1==o.childElementCount&&[".adjphr",".advphr"].find(e=>o.firstElementChild.matches(e))&&C.swapParentAndChild(o,o.firstElementChild),j(n=v(o).closest(".semantics-result")[0])}else if("wrap"==this.dataset.mode){var o=s,l=a||e,i=o.getRangeAt(0),r=i.startContainer.nodeType===Node.TEXT_NODE?i.startContainer.parentNode:i.startContainer,c=r.closest(".sem"),d=r.closest(".semantics-result"),m=c?.matches(".sem."+("pcl"==l?"advcls":l));switch(l){case"tor":case"ger":case"ptc":case"ncls":if(i.toString().length==c?.textContent?.length){var u=createElement({el:"span",class:"sem "+l,dataset:{gc:A[l]}});c.matches(".s,.o,.po,.to,.go,.ptco,.c,.oc,.appo,.adjphr,.advphr")?"ncls"==l?(c?.dataset?.gc&&delete c.dataset.gc,u.dataset.gc=A.ncls[Array.from(c.classList).filter(e=>["s","o","po","to","go","ptco","c","oc","appo"].includes(e))[0]],v(c).wrap(u)):v(c).wrapInner(u):m?(p=v(c).wrapInner(u).children().eq(0).unwrap(),i.selectNode(p[0]),O(i,l,p[0])):v(c).wrap(u),j(d)}else{let t;if(["tor","ger","ptc"].includes(l)){t=createElement({el:"span",class:"sem "+l,dataset:{gc:A[l]}});try{i.surroundContents(t)}catch(e){t.appendChild(i.extractContents()),i.insertNode(t)}}j(d),O(i,l,t)}break;case"acls":case"advcls":case"pcl":var p=b.createElement("span");p.className="sem m",p.dataset.rc=S.m;try{i.surroundContents(p)}catch(e){p.appendChild(i.extractContents()),i.insertNode(p)}C.trimTextContent(d),i.selectNode(p);default:let t=b.createElement("span");t.classList.add("sem","pcl"==l?"advcls":l),A[l]&&(t.dataset.gc=A[l]);try{i.surroundContents(t)}catch(e){t.appendChild(i.extractContents()),i.insertNode(t)}i.detach(),o.removeAllRanges(),["adjphr","advphr"].includes(l)&&[".tor",".ptc"].some(e=>t.parentElement.matches(e))&&1===Array.from(t.parentElement.childNodes).filter(e=>0<e.textContent.length).length&&C.swapParentAndChild(t.parentElement,t),j(d)}}v(".edit-svoc").attr("data-mode",null),g.find(".active").removeClass("active"),y.empty()}}).on("mouseup",'.edit-svoc[data-mode="cleft"]',function(n){n.stopPropagation();var r=this.querySelector(".semantics-result"),l=(r.normalize(),getSelection());if(!l.isCollapsed){var i=l.anchorNode.compareDocumentPosition(l.focusNode);let e=!1,{anchorNode:t,anchorOffset:o,focusNode:a,focusOffset:s}=((e=!i&&l.anchorOffset>l.focusOffset||i===Node.DOCUMENT_POSITION_PRECEDING?!0:e)&&l.setBaseAndExtent(l.focusNode,l.focusOffset,l.anchorNode,l.anchorOffset),l);for(;/^(\s|[.,?!'"])/.test(t.textContent.substring(o));)o++;for(;/(\s|'s|[.,?!'"])$/.test(a.textContent.substring(0,s));)s--;for(;0<o&&/\w/.test(t.textContent[o-1]);)o--;for(;s<a.textContent.length&&/\w/.test(a.textContent[s]);)s++;l.setBaseAndExtent(a,s,t,o);i=l.toString().trim().match(/^[iI]t( is| was|'s| had been| has been|'s been|'ll be|'ll have been| will be| will have been| can be| could be| could have been| would be| would have been)[ ,].+\S$/);if(i){T(r);var c,d="It"+i[1],i=i[0].match(/(that|wh(o(se|m)?|e(n|re)|y|at|ich)|how)$/i);i&&((c=new Range).setStart(a,s-i[0].length),c.setEnd(a,s),c.surroundContents(createElement({el:"span",class:"sem cleft"})));try{var m=new Range;m.setStart(t,o),m.setEnd(t,o+d.length),m.surroundContents(createElement({el:"span",class:"sem cleft",dataset:{gc:"강조구문"}}))}catch(n){return alertModal("선택 범위 내의 다른 마킹을 지워주세요."),void v(r).html(u.pop())}l.removeAllRanges()}else alertModal('"It + be동사 + 강조대상 + that(생략 가능. that 대신 who,where 등 가능)"까지 선택하세요.')}}).on("click",".cls-role-menu button",function(){var e=this.value,t=createElement({el:"span",class:"sem "+(P[e]??e)}),o=(S[e]&&(t.dataset.rc=S[e]),c.data("range"));try{o.surroundContents(t)}catch(e){t.appendChild(o.extractContents()),o.insertNode(t)}var a=createElement({el:"span",class:"sem ncls"});A.ncls[e]&&(a.dataset.gc=A.ncls[e]),v(t).wrap(a),c.data("range",null).detach(),j(t.closest(".semantics-result")),"appo"==e?(o.detach(),getSelection().removeAllRanges(),v(t).parent().addClass("comment-target").trigger("click"),v(".edit-comment :text").val("동격 => ")):(a=o.getClientRects()[0],v(b.body).append(d.css("top",scrollY+a.top+a.height+"px").css("left",scrollX+a.left+"px").data("range",v(t).parent(".ncls"))),d.find('button[value="nclc"]').prop("checked",!0))}).on("click",".cls-conj-menu button",function(){var e=this.value,t=d.data("range");t.attr("data-gc",A.ncls[e]||t.attr("data-gc")),getSelection().removeAllRanges(),d.data("range",null).detach(),j(t.closest(".semantics-result")[0])}).on("click",".tor-role-menu button,.ger-role-menu button,.ptc-role-menu button",function(){var e=this.value,t=this.closest(".tor-role-menu,.ger-role-menu,.ptc-role-menu").className.match(/(\w+)-role-menu/)[1],t={tor:m,ger:p,ptc:h}[t],o=createElement({el:"span",class:"sem "+(P[e]??e)}),a=(S[e]&&(o.dataset.rc=S[e]),["adjphr","advphr"].includes(e)&&A[e]&&(o.dataset.gc=A[e]),t.data("wrapperEl"));["adjphr","advphr"].includes(e)?v(a).wrap(o):v(a).wrapInner(o),t.data("range").detach(),getSelection().removeAllRanges(),t.data("range",null).data("wrapperEl",null).detach(),j(a.closest(".semantics-result"))}).on("mouseup",function(e){(c.is(":visible")&&!e.target.closest(".cls-role-menu")||d.is(":visible")&&!e.target.closest(".cls-conj-menu")||m.is(":visible")&&!e.target.closest(".tor-role-menu")||p.is(":visible")&&!e.target.closest(".ger-role-menu")||h.is(":visible")&&!e.target.closest(".ptc-role-menu"))&&(getSelection().removeAllRanges(),c.data("range",null).detach(),d.data("range",null).detach(),m.data("range",null).detach(),p.data("range",null).detach(),h.data("range",null).detach())}).on("click",'.edit-svoc:not([data-mode="erasing"]):not([data-mode="mod"]):not([data-mode="comment"]) .sem',function(e){v(".edit-comment").remove();var a=this,t=("touchstart"==e.type?e.touches[0]:e).clientX,s=("touchstart"==e.type?e.touches[0]:e).clientY,n=this.getClientRects(),r=v(this).is(".odd")?1:0,l=v(this).is(".rcm")?1:0,i=r?-1:1,c=l?-1:1,d=["top","bottom"][r],m=["left","right"][l];for(let o of[{data:"rc",pseudo:"::before"},{data:"gc",pseudo:"::after"}]){var u=getComputedStyle(a,o.pseudo),p=parseFloat(u[d]),h=parseFloat(u[m]),f=parseFloat(u.width),u=parseFloat(u.height);if(null!=a.dataset[o.data]&&!isNaN(f)&&!isNaN(u)){p=n[r][d]+i*p,u=p+i*u,h=n[l?n.length-1:0][m]+c*h,f=h+c*f;if(Math.min(p,u,s)!=s&&Math.max(p,u,s)!=s&&Math.min(h,f,t)!=t&&Math.max(h,f,t)!=t){e.stopPropagation();let t=w.clone(!1);function g(e){16!=(16&t[0].compareDocumentPosition(e.target))&&(v(b).off("mousedown",g),t.remove(),v(".edit-svoc").focus())}t.find("input:text").val(a.dataset[o.data]),b.body.appendChild(t[0]),t.css("top","gc"==o.data?scrollY+Math.max(p,u)+"px":scrollY+Math.min(p,u)-t.height()-10+"px").css("left",scrollX+Math.min(h,f)+"px").find("input:text")[0].focus(),v(b).on("mousedown",g),t.find("form").on("submit",function(e){e.preventDefault(),T(a.closest(".semantics-result"));e=v(this).find("input").val().trim();0==e.length?delete a.dataset[o.data]:a.dataset[o.data]=e,v(b).off("mousedown",g),t.remove(),C.checkGCDepth(a.closest(".semantics-result")),v(".edit-svoc").focus()}),t.find("button:eq(1)").on("click",function(){v(b).off("mousedown",g),t.remove(),v(".edit-svoc").focus()});break}}}}).on("mouseover",'[data-mode="mod"] .semantics-result *',function(e){v(".mod-indicator").remove();var t=".cls,.acls,.ncls,.advcls,.phr,.tor,.ger,.adjphr,.ptc",t=v(this).is(t)?this:0==v(this).closest(t).length?null!=this.dataset.lv?this:null:v(this).closest(t)[0];if(null==t||t.textContent.trim().length<2||null!=t.dataset.mfd)return k=null,!1;e.stopPropagation(),k=t;e=b.createElement("div");e.className="mod-indicator",e.style.position="absolute",e.style.top=scrollY+t.getClientRects()[0].top-3*r+"px",e.style.left=scrollX+t.getClientRects()[0].left-.8*r+"px",e.textContent="↑",b.body.appendChild(e)}).on("mousemove",".edit-svoc .semantics-result",function(e){E=("touchstart"==e.type?e.touches[0]:e).clientX,R=("touchstart"==e.type?e.touches[0]:e).clientY;let t,o,a;if(0<v(e.target).closest('[data-mode="mod-end"] .semantics-result').length){v(".mod-indicator").remove();var s=b.createElement("div");if(s.className="mod-indicator",s.style.position="absolute",b.caretPositionFromPoint){o=b.createRange();var n=b.caretPositionFromPoint(E,R).offsetNode;o.selectNode(M(n))}else{if(!b.caretRangeFromPoint)return console.error("[This browser supports neither document.caretRangeFromPoint nor document.caretPositionFromPoint.]"),!1;o=b.caretRangeFromPoint(E,R)}if("function"==typeof Selection.prototype.modify){if((t=getSelection()).removeAllRanges(),t.addRange(o),t.modify("move","backward","word"),t.modify("extend","forward","word"),0==t.rangeCount||null==t.toString().trim().match(/\w/))return t.removeAllRanges(),!1;if(a=t.getRangeAt(0).getClientRects()[0],t.removeAllRanges(),a.y>R||R>a.y+a.height)return!1}else if("function"==typeof Range.prototype.expand){if(o.expand("word"),null==o.toString().trim().match(/\w/))return!1;if(a=o.getClientRects()[0],o.detach(),a.y>R||R>a.y+a.height)return!1}else console.error("[This browser supports neither Selection.modify nor Range.expand.]");e.stopPropagation(),s.style.top=scrollY+a.top-3*r+"px",s.style.left=scrollX+a.right-r+"px",s.textContent="↓",b.body.appendChild(s)}}).on("click",'[data-mode="mod"] .semantics-result *',function(e){if(null==k)return!1;e.stopPropagation(),v(".mod-indicator").toggleClass("mod-indicator mod-start"),this.closest(".edit-svoc").dataset.mode="mod-end",v(".semantic-edit-guide-msg").text("피수식어 위치를 클릭 하세요.")}).on("click",'[data-mode="mod-end"] .semantics-result',function(e){if(0==v(".mod-indicator").length)return!1;e.stopPropagation(),v(".mod-start").remove(),T(this);var t=this.dataset.seq,o=0,a=(v(this).find(".rcm").each(function(){for(var e of this.classList)-1<e.indexOf("mfd")&&(o=Math.max(o,parseFloat(e.split("-")[2])))}),k.dataset.mfd=t+"-"+(o+1),b.createElement("span")),t=(a.className=`sem rcm mfd-${t}-`+(o+1),a.dataset.gc="수식",("touchstart"==e.type?e.touches[0]:e).clientX),e=("touchstart"==e.type?e.touches[0]:e).clientY;if(b.caretPositionFromPoint){var s=b.createRange(),n=b.caretPositionFromPoint(E,R).offsetNode;s.selectNode(M(n))}else{if(!b.caretRangeFromPoint)return console.error("[This browser supports neither document.caretRangeFromPoint nor document.caretPositionFromPoint.]"),!1;s=b.caretRangeFromPoint(t,e)}for((n=getSelection()).removeAllRanges(),n.addRange(s),n.modify("move","backward","word"),n.modify("extend","forward","word"),s=n.getRangeAt(0);s.toString().endsWith(" ");)s.setEnd(s.endContainer,s.endOffset-1);0==s.endOffset&&s.setEnd(s.startContainer,s.startContainer.data.length);try{s.surroundContents(a)}catch(e){a.appendChild(s.extractContents()),s.insertNode(a)}n.removeAllRanges(),k=null,v(".mod-indicator").remove(),v(".edit-svoc").attr("data-mode",null),g.find('[data-mode="mod"].active').removeClass("active"),y.empty(),C.checkGCDepth(this)}).on("click",".comment-target",function(e){let t=e.target.closest(".semantics-result")||e.target,o=this;v(b).off("mouseover",'[data-mode="comment"] .semantics-result .sem').off("mouseout",'[data-mode="comment"] .semantics-result *'),v(".edit-comment").remove();var e=o.getClientRects(),a=o.matches(".odd")?1:0,s=o.matches(".rcm")?1:0,n=a?-1:1,r=s?-1:1,l=["top","bottom"][a],i=["left","right"][s],c=getComputedStyle(o,"::after"),d=parseFloat(c[l]),m=parseFloat(c[i]),u=parseFloat(c.width),c=parseFloat(c.height),a=e[a][l]+n*d,l=a+n*c,d=e[s?e.length-1:0][i]+r*m,n=d+r*u;let p=w.clone(!1);function h(e){16!=(16&p[0].compareDocumentPosition(e.target))&&(v(b).off("mousedown",h),p.remove(),v(".edit-svoc").focus(),f())}b.body.appendChild(p[0]),p.find("input:text").val(o.dataset.gc??""),p.css("top",scrollY+Math.max(a,l)+"px").css("left",scrollX+Math.min(d,n)+"px").find("input:text")[0].focus(),v(b).on("mousedown",h),p.find("form").on("submit",function(e){e.preventDefault(),o.classList.remove("comment-target"),t.closest('[data-mode="comment"]')&&T(t),f();e=v(this).find("input").val().trim();0==e.length?delete o.dataset.gc:o.dataset.gc=e,v(b).off("mousedown",h),p.remove(),C.checkGCDepth(o.closest(".semantics-result")),v(".edit-svoc").focus(),t.closest(".edit-svoc").removeAttribute("data-mode"),g.find('[data-mode="comment"].active').removeClass("active"),y.empty()}),p.find("button:eq(1)").on("click",function(){v(b).off("mousedown",h),p.remove(),f(),v(".edit-svoc").focus()})}),f(),y=v(e).find(".semantic-edit-guide-msg"),s=v(e).find(".svoc-editor-badge"),i=v(e).find(".svoc-editor-emblem")},"html")),(t=s.clone()).text(e?"New":"Edit"),this.wrap(v('<div class="edit-svoc" tabindex="0"></div>')).before(t).before(i).before(g).after(y),v(".edit-svoc").focus()),this}})(jQuery,document,tandem);
!function(b){var y,C,n=[],s=[];const r={49:'[value="s"]',50:'[value="v"]',51:'[value="o"]',52:'[value="c"]',53:'[value="oc"]',54:'[value="a"]',81:'[value="tor"]',87:'[value="ptc"]',69:'[value="ger"]',82:'[value="conj"]',65:'[value="phr"]',83:'[value="adjphr"]',68:'[value="advphr"]',70:'[value="ptcphr"]',84:'[value="ccls"]',89:'[value="ncls"]',71:'[value="acls"]',72:'[value="advcls"]',90:'[value="mod"]',88:'[value="erasing"]',67:'[value="comment"]',ctrlS:'[value="save"]',ctrlZ:'[value="undo"]:not([disabled])',ctrlY:'[value="redo"]:not([disabled])'};let l,d=0,m=0,u={};function x(t){var e=t.dataset.seq;n.push([e,t.innerHTML]),s=[],b('.svoc-toolbar [value="undo"]').prop("disabled",!1)}function w(t){b(t).find(".sem").filter((t,e)=>0==e.textContent.length).remove(),checkPOSDepth(t),wrapWithBracket(t),splitInners(t),trimTextContent(t),correctMarkLine(t),b(".edit-svoc").focus()}b.fn.svoceditor=async function(t,e,o){return u={forNew:t,saveCallback:e,cancelCallback:o},"close"==t?(void 0!==y&&y.detach(),void 0!==C&&C.detach()):(void 0===y&&(await b.get("https://static.findsvoc.com/css/app/tandem.editor.css",t=>{const e=document.createElement("style");e.innerHTML=t,document.head.append(e)}),await b.getJSON("https://static.findsvoc.com/data/tandem/edit-toolbar.json",o=>{y=b('<div id="js-edit-toolbar" class="svoc-toolbar row g-2 btn-toolbar" role="toolbar"></div>');for(let t=0,e=o.length;t<e;t++)!function o(n,t){let s,e;switch(n.type){case"group":e="btn-group col-auto";case"div":e=n.class||e,s=document.createElement("div");break;default:e=n.class||"btn btn-outline-dark col-auto btn-sm",(s=document.createElement("button")).dataset.toggle="tooltip",s.dataset.placement="bottom",s.dataset.mode=n.mode,s.title=n.title,s.value=n.value,s.innerHTML=n.html}s.className=e;t.append(s);if(n.children)for(let t=0,e=n.children.length;t<e;t++)o(n.children[t],b(s))}(o[t],y);y.find('[data-toggle="tooltip"]').click(function(){b(this).tooltip("hide")}).tooltip({trigger:"hover"});const a=parseFloat(getComputedStyle(document.body).fontSize);b(document).on("keydown",function(t){b(t.target).is("input")&&0<b(t.target).closest(".edit-comment").length&&27==t.keyCode?b(t.target.form).find("button:eq(1)").trigger("click"):b(".edit-svoc")?.is(":focus")&&((t.ctrlKey||t.metaKey)&&65<=t.keyCode&&t.keyCode<=90?r["ctrl"+t.key.toUpperCase()]&&(t.preventDefault(),y.find(r["ctrl"+t.key.toUpperCase()]).trigger("click")):b(t.target).is("input")||null==r[t.keyCode]||y.find(r[t.keyCode]).trigger("click"))}),y.on("click",'[value="save"]',function(){var e,t=this.closest(".edit-svoc").querySelector(".semantics-result");for(b(t).closest(".edit-svoc").addClass("pe-none").find(".svoc-editor-badge").html('<i class="fas fa-spinner fa-spin"></i> 저장중').animate({width:"100%"});null!=t.querySelector(".brkt,.line-end,canvas.curved_arrow");)t.querySelector(".brkt,.line-end,canvas.curved_arrow").remove();e=t,requestAnimationFrame(async function(){var t=await svocArr2Text(svocDom2Arr(e));wrapWithBracket(e),correctMarkLine(e),n=[],s=[],y.find('[value="undo"], [value="redo"]').prop("disabled",!0),u.saveCallback(t),b(".svoc-editor-badge").html('<i class="fas fa-check"></i> 저장됨'),setTimeout(()=>{C.text(""),b(e).unwrap(),y.find('[value="undo"], [value="redo"]').prop("disabled",!0),y.find("button").removeClass("active").tooltip("hide"),b(".js-edit-svoc,.js-del-svoc,.js-add-svoc").prop("disabled",!1),b(".svoc-editor-badge,.svoc-editor-emblem").remove(),y.detach(),C.detach()},2e3)})}).on("click",'[value="close"]',function(){if(confirm("수정내역은 저장되지 않습니다.\n편집모드를 종료하시겠습니까?")){const e=b(this).closest(".edit-svoc"),o=e.find(".semantics-result");0<n.length&&(t=n.shift(),o.html(t[1]),b(".erasing-target").toggleClass("erasing-target"),b(".mod-start,.mod-indicator").remove(),drawConnections(o[0]),o.animate({opacity:.5},100).animate({opacity:1},100)),t=o,y.find('[value="undo"], [value="redo"]').prop("disabled",!0),y.find("button").removeClass("active").tooltip("hide"),t.unwrap(),n=[],s=[],b(".svoc-editor-badge,.svoc-editor-emblem").remove(),y.detach(),C.detach(),u.cancelCallback()}var t}).on("click","[data-mode]:not([disabled])",function(){if("undo"==this.dataset.mode)return!0;let t=getSelection(),e;if(b(".svoc-toolbar .active").add(this).toggleClass("active"),b(".erasing-target, .comment-target").removeClass("erasing-target comment-target"),b(".mod-start,.mod-indicator").remove(),b(this).is(".active")){var o=this.dataset.mode;switch(b(".edit-svoc").attr("data-mode",o),o){case"role":case"wrap":t.isCollapsed?C.text("적용 텍스트를 드래그 하세요."):(b(".edit-svoc").trigger("mouseup",this.value).attr("data-mode",null),b(this).removeClass("active"));break;case"erasing":C.html("지우려는 태그를 클릭 하세요.<br><h6>하위태그 모두 선택 : shift+클릭</h6>"),t.removeAllRanges();break;case"mod":C.text("수식어 위치를 클릭 하세요."),t.removeAllRanges();break;case"comment":C.text("문법 코멘트를 추가할 요소를 선택하세요."),t.removeAllRanges()}if(t.isCollapsed){if(document.caretPositionFromPoint)e=document.caretPositionFromPoint(d,m);else{if(!document.caretRangeFromPoint)return console.error("[This browser supports neither document.caretRangeFromPoint nor document.caretPositionFromPoint.]"),!1;e=document.caretRangeFromPoint(d,m)}let t=e.startContainer;for(;1!=t.nodeType;)t=t.parentNode;b(t).trigger("mouseover")}}else b(".edit-svoc").attr("data-mode",null),C.empty()}).on("click",'[value="undo"], [value="redo"]',function(t){var e;t.preventDefault(),("undo"==this.value||"redo"==this.value&&0<s.length)&&(this.classList.add("active"),t=("undo"==this.value?n:s).pop(),e=b(`.edit-svoc .semantics-result[data-seq="${t[0]}"]`),("undo"==this.value?s:n).push([e.attr("data-seq"),e.html()]),e.html(t[1]),b(".erasing-target").toggleClass("erasing-target"),b(".mod-start,.mod-indicator").remove(),drawConnections(e[0]),e.animate({opacity:.5},100).animate({opacity:1},100),b('.svoc-toolbar [value="undo"]').prop("disabled",0==n.length),b('.svoc-toolbar [value="redo"]').prop("disabled",0==s.length),setTimeout(()=>{this.classList.remove("active")},50))});let i=[],c=null,e=!1;function v(){b(document).on("mouseover",'[data-mode="comment"] .semantics-result .sem',function(t){null!=this.dataset.gc&&0!=this.dataset.gc.length||(t.stopPropagation(),this.classList.add("comment-target"))}).on("mouseout",'[data-mode="comment"] .semantics-result *',function(){b(".comment-target").removeClass("comment-target")})}b(document).on("mouseover",'[data-mode="erasing"] .semantics-result *',function(e,o){e.stopPropagation();var n=e.target;if(c=n,s(),b(n).is(".curved_arrow"))for(var t of n.classList)-1<t.indexOf("mfd")&&(b(this).siblings(".curved_arrow."+t).each(function(){i.push(this)}),i.push(b(".rcm.mfd-"+t.substring(3))[0]));function s(){if(null!=n){if(i.push(n),o||e.shiftKey)for(var t of n.getElementsByTagName("span"))i.push(t);n.textContent==n.parentElement.textContent?(n=n.parentElement,i.push(n)):0<n.children.length&&n.children[0].textContent==n.textContent&&i.push(n.children[0])}}null!=n.previousElementSibling&&b(n.previousElementSibling).is('[class*="-start"]:not([class*="cmnt-align-start"])')&&null!=n.nextElementSibling&&b(n.nextElementSibling).is('[class*="-end"]')&&(i.push(n.previousElementSibling),i.push(n.nextElementSibling)),-1<n.className.indexOf("-start")?(n=n.nextElementSibling,s(),null!=n&&null!=n.nextElementSibling&&(n=n.nextElementSibling,i.push(n))):-1<n.className.indexOf("-end")&&(n=n.previousElementSibling,s(),null!=n&&null!=n.previousElementSibling&&(n=n.previousElementSibling,i.push(n))),i.forEach(function(t){t.classList.add("erasing-target")})}).on("mouseout",'[data-mode="erasing"] .semantics-result *',function(t){i.forEach(function(t){b(t).removeClass("erasing-target")}),i=[],c=null,t.stopPropagation()}).on("keydown keyup",function(t){("keydown"==t.type&&!e&&t.shiftKey||"keyup"==t.type&&e&&!t.shiftKey)&&(e=!e,b(document.body).toggleClass("shift",e),null!=c&&b(c).trigger("mouseout").trigger("mouseover",[e]))}).on("click",".erasing-target",function(t){const e=t.target.closest(".semantics-result")||t.target;e.closest('[data-mode="erasing"]')&&(x(e),i.forEach(function(t){0==t.textContent.length||t.matches(".brkt")?b(t).remove():b(t).contents().unwrap()})),b(e).find(".rcm").each(function(){for(var t of this.classList)-1<t.indexOf("mfd")&&0==b(`[data-mfd="${t.substring(4)}"]`).length&&b(this).contents().unwrap()}),b(e).find("[data-mfd]").each(function(){0==b(".rcm.mfd-"+this.dataset.mfd).length&&delete this.dataset.mfd}),t.shiftKey&&getSelection().removeAllRanges(),w(e)}).on("mouseup",'.edit-svoc[data-mode="role"], .edit-svoc[data-mode="wrap"]',function(t,e){t.stopPropagation();t=y.find(".active").val();const o=getSelection();var n=o?.anchorNode?.parentElement?.closest(".semantics-result");if(!o.isCollapsed){if(x(n),"role"==this.dataset.mode){n=o;var s=e||t;const c={s:"S",v:"V",o:"O",c:"C",oc:"o.c.",m:"M",a:"A"},r={a:"부사적 보충어",tor:"to부정사",ger:"동명사",ptc:"분사"},l=n.getRangeAt(0),d=document.createElement("span");d.className="sem "+s,null!=c[s]&&(d.dataset.rc=c[s],d.dataset.rcMin=c[s].substring(0,"oc"==s?4:1));null!=r[s]&&(d.dataset.gc=r[s]);try{l.surroundContents(d)}catch(t){d.appendChild(l.extractContents()),l.insertNode(d)}l.detach(),n.removeAllRanges();s=b(d).closest(".semantics-result")[0];w(s)}else if("wrap"==this.dataset.mode){var a=o;var i=e||t;const m={s:"S",o:"O",c:"C",oc:"o.c.",m:"M",a:"A"},u={ncls:{s:"주어절",o:"목적어절",c:"보어절",oc:"목적보어절",m:"관계절"},acls:"형용사절",advcls:"부사절",phr:"전치사구",adjphr:"형용사구",advphr:"부사구",ptcphr:"부사구(분사구문)",ccls:"등위절"},p=a.getRangeAt(0),f=b(p.startContainer).closest(".semantics-result")[0];switch(i){case"ncls":const v=document.createElement("div");v.className="cls-role-menu",v.style.position="absolute",v.style.top=scrollY+p.getClientRects()[0].top+p.getClientRects()[0].height+"px",v.style.left=scrollX+p.getClientRects()[0].left+"px",v.insertAdjacentHTML("afterbegin",'<button class="cls-role-btn" value="s">s</button><button class="cls-role-btn" value="o">o</button><button class="cls-role-btn" value="c">c</button><button class="cls-role-btn" value="oc">oc</button>'),document.body.appendChild(v);let n=!1;b(document).on("click",function t(e){if(n){if(16==(16&v.compareDocumentPosition(e.target))){var o=document.createElement("span");o.className="sem "+e.target.value,null!=m[e.target.value]&&(o.dataset.rc=m[e.target.value]);try{p.surroundContents(o)}catch(t){o.appendChild(p.extractContents()),p.insertNode(o)}o=document.createElement("span");o.className="sem "+i,o.dataset.gc=u[i][e.target.value];try{p.surroundContents(o)}catch(t){o.appendChild(p.extractContents()),p.insertNode(o)}p.detach(),a.removeAllRanges(),w(f)}b(document).off("click",t),b(v).remove()}else n=!0});break;case"acls":case"advcls":const h=document.createElement("span");h.className="sem m",h.dataset.rc=m.m;try{p.surroundContents(h)}catch(t){h.appendChild(p.extractContents()),p.insertNode(h)}trimTextContent(f),p.selectNode(h);default:const g=document.createElement("span");g.className="sem "+i,u[i]&&(g.dataset.gc=u[i]);try{p.surroundContents(g)}catch(t){g.appendChild(p.extractContents()),p.insertNode(g)}p.detach(),a.removeAllRanges(),w(f)}}b(".edit-svoc").attr("data-mode",null),y.find(".active").removeClass("active"),C.empty()}}).on("click",'.edit-svoc:not([data-mode="erasing"]):not([data-mode="mod"]):not([data-mode="comment"]) .sem',function(t){b(".edit-comment").remove();var o=this,n=("touchstart"==t.type?t.touches[0]:t).clientX,s=("touchstart"==t.type?t.touches[0]:t).clientY,a=this.getClientRects(),i=b(this).is(".odd")?1:0,c=b(this).is(".rcm")?1:0,r=i?-1:1,l=c?-1:1,d=["top","bottom"][i],m=["left","right"][c];for(let e of[{data:"rc",pseudo:"::before"},{data:"gc",pseudo:"::after"}]){var u=getComputedStyle(o,e.pseudo),p=parseFloat(u[d]),f=parseFloat(u[m]),v=parseFloat(u.width),u=parseFloat(u.height);if(null!=o.dataset[e.data]&&!isNaN(v)&&!isNaN(u)){p=a[i][d]+r*p,u=p+r*u,f=a[c?a.length-1:0][m]+l*f,v=f+l*v;if(Math.min(p,u,s)!=s&&Math.max(p,u,s)!=s&&Math.min(f,v,n)!=n&&Math.max(f,v,n)!=n){t.stopPropagation();var h=document.createElement("div");function g(t){16!=(16&h.compareDocumentPosition(t.target))&&(b(document).off("mousedown",g),b(h).remove(),b(".edit-svoc").focus())}h.className="edit-comment text-end",h.style.position="absolute",h.insertAdjacentHTML("afterbegin",'<form class="btn-group"><input class="form-control" type="text"'+`placeholder="↵" value="${o.dataset[e.data]}"/>`+'<div class="btn-group ms-1"><button class="btn btn-sm btn-fico" type="submit">확인</button><button class="btn btn-sm btn-outline-fico" type="button">취소</button></div></form>'),document.body.appendChild(h),h.style.top=scrollY+Math.max(p,u)+"px",h.style.left=scrollX+Math.min(f,v)+"px","gc"==e.data&&(h.style.top=scrollY+Math.min(p,u)-h.offsetHeight-10+"px"),h.firstChild.firstChild.focus(),b(document).on("mousedown",g),b(h).find("form").on("submit",function(t){t.preventDefault(),x(o.closest(".semantics-result"));t=b(this).find("input").val().trim();0==t.length?delete o.dataset[e.data]:o.dataset[e.data]=t,b(document).off("mousedown",g),b(h).remove(),checkGCDepth(o.closest(".semantics-result")),b(".edit-svoc").focus()}),b(h).find("button:eq(1)").on("click",function(){b(document).off("mousedown",g),b(h).remove(),b(".edit-svoc").focus()});break}}}}).on("mouseover",'[data-mode="mod"] .semantics-result *',function(t){b(".mod-indicator").remove();var e=".cls,.acls,.ncls,.advcls,.phr,.tor,.ger,.adjphr,.ptc";let o=b(this).is(e)?this:0==b(this).closest(e).length?null!=this.dataset.lv?this:null:b(this).closest(e)[0];if(null==o||o.textContent.trim().length<2||null!=o.dataset.mfd)return l=null,!1;t.stopPropagation(),l=o;const n=document.createElement("div");n.className="mod-indicator",n.style.position="absolute",n.style.top=scrollY+o.getClientRects()[0].top-3*a+"px",n.style.left=scrollX+o.getClientRects()[0].left-.8*a+"px",n.textContent="↑",document.body.appendChild(n)}).on("mousemove",".edit-svoc .semantics-result",function(t){d=("touchstart"==t.type?t.touches[0]:t).clientX,m=("touchstart"==t.type?t.touches[0]:t).clientY;let e,o,n;if(0<b(t.target).closest('[data-mode="mod-end"] .semantics-result').length){b(".mod-indicator").remove();const s=document.createElement("div");if(s.className="mod-indicator",s.style.position="absolute",document.caretPositionFromPoint)o=document.caretPositionFromPoint(d,m);else{if(!document.caretRangeFromPoint)return console.error("[This browser supports neither document.caretRangeFromPoint nor document.caretPositionFromPoint.]"),!1;o=document.caretRangeFromPoint(d,m)}if("function"==typeof Selection.prototype.modify){if((e=getSelection()).removeAllRanges(),e.addRange(o),e.modify("move","backward","word"),e.modify("extend","forward","word"),0==e.rangeCount||null==e.toString().trim().match(/\w/))return e.removeAllRanges(),!1;if(n=e.getRangeAt(0).getClientRects()[0],e.removeAllRanges(),n.y>m||m>n.y+n.height)return!1}else if("function"==typeof Range.prototype.expand){if(o.expand("word"),null==o.toString().trim().match(/\w/))return!1;if(n=o.getClientRects()[0],o.detach(),n.y>m||m>n.y+n.height)return!1}else console.error("[This browser supports neither Selection.modify nor Range.expand.]");t.stopPropagation(),s.style.top=scrollY+n.top-3*a+"px",s.style.left=scrollX+n.right-a+"px",s.textContent="↓",document.body.appendChild(s)}}).on("click",'[data-mode="mod"] .semantics-result *',function(t){if(null==l)return!1;t.stopPropagation(),b(".mod-indicator").toggleClass("mod-indicator mod-start"),this.closest(".edit-svoc").dataset.mode="mod-end",b(".semantic-edit-guide-msg").text("피수식어 위치를 클릭 하세요.")}).on("click",'[data-mode="mod-end"] .semantics-result',function(t){if(0==b(".mod-indicator").length)return!1;t.stopPropagation(),b(".mod-start").remove(),x(this);var e,o=this.dataset.seq,n=0,s=(b(this).find(".rcm").each(function(){for(var t of this.classList)-1<t.indexOf("mfd")&&(n=Math.max(n,parseFloat(t.split("-")[2])))}),l.dataset.mfd=o+"-"+(n+1),document.createElement("span")),o=(s.className=`sem rcm mfd-${o}-`+(n+1),s.dataset.gc="수식",("touchstart"==t.type?t.touches[0]:t).clientX),t=("touchstart"==t.type?t.touches[0]:t).clientY;if(document.caretPositionFromPoint)e=document.caretPositionFromPoint(o,t);else{if(!document.caretRangeFromPoint)return console.error("[This browser supports neither document.caretRangeFromPoint nor document.caretPositionFromPoint.]"),!1;e=document.caretRangeFromPoint(o,t)}for((o=getSelection()).removeAllRanges(),o.addRange(e),o.modify("move","backward","word"),o.modify("extend","forward","word"),e=o.getRangeAt(0);e.toString().endsWith(" ");)e.setEnd(e.endContainer,e.endOffset-1);0==e.endOffset&&e.setEnd(e.startContainer,e.startContainer.data.length);try{e.surroundContents(s)}catch(t){s.appendChild(e.extractContents()),e.insertNode(s)}o.removeAllRanges(),l=null,b(".mod-indicator").remove(),b(".edit-svoc").attr("data-mode",null),y.find('[data-mode="mod"].active').removeClass("active"),C.empty(),checkGCDepth(this)}).on("click",".comment-target",function(t){const e=t.target.closest(".semantics-result")||t.target,o=this;b(document).off("mouseover",'[data-mode="comment"] .semantics-result .sem').off("mouseout",'[data-mode="comment"] .semantics-result *'),b(".edit-comment").remove();var t=o.getClientRects(),n=o.matches(".odd")?1:0,s=o.matches(".rcm")?1:0,a=n?-1:1,i=s?-1:1,c=["top","bottom"][n],r=["left","right"][s],l=getComputedStyle(o,"::after"),d=parseFloat(l[c]),m=parseFloat(l[r]),u=parseFloat(l.width),l=parseFloat(l.height),n=t[n][c]+a*d,c=n+a*l,d=t[s?t.length-1:0][r]+i*m,a=d+i*u;const p=document.createElement("div");function f(t){16!=(16&p.compareDocumentPosition(t.target))&&(b(document).off("mousedown",f),b(p).remove(),b(".edit-svoc").focus(),v())}p.className="edit-comment text-end",p.style.position="absolute",p.style.top=scrollY+Math.max(n,c)+"px",p.style.left=scrollX+Math.min(d,a)+"px",p.insertAdjacentHTML("afterbegin",'<form class="btn-group"><input class="form-control" type="text" placeholder="↵"/><div class="btn-group ms-1"><button class="btn btn-sm btn-fico" type="submit">확인</button><button class="btn btn-sm btn-outline-fico" type="button">취소</button></div></form>'),document.body.appendChild(p),p.style.top=scrollY+Math.min(n,c)-p.offsetHeight-10+"px",p.firstChild.firstChild.focus(),b(document).on("mousedown",f),b(p).find("form").on("submit",function(t){t.preventDefault(),o.classList.remove("comment-target"),e.closest('[data-mode="comment"]')&&x(e),v();t=b(this).find("input").val().trim();0==t.length?delete o.dataset.gc:o.dataset.gc=t,b(document).off("mousedown",f),b(p).remove(),checkGCDepth(o.closest(".semantics-result")),b(".edit-svoc").focus(),e.closest(".edit-svoc").removeAttribute("data-mode"),y.find('[data-mode="comment"].active').removeClass("active"),C.empty()}),b(p).find("button:eq(1)").on("click",function(){b(document).off("mousedown",f),b(p).remove(),v(),b(".edit-svoc").focus()})}),v()})),void 0===C&&(C=b('<div class="semantic-edit-guide-msg mx-auto"></div>')),this.wrap(b('<div class="edit-svoc" tabindex="0"></div>')).before(b(`<span class="svoc-editor-badge badge fs-6 rounded-pill">${t?"New":"Edit"}</span>`)).before(b('<span class="svoc-editor-emblem position-absolute end-0 me-2 p-1 pb-0 bg-white rounded-pill pe-none">『 <b class="app-name-text">fico </b><b class="text-fc-red" style="font-size:.9rem;">SVOC Editor</b>™』</span>')).before(y).after(C),b(".edit-svoc").focus()),this}}(jQuery);
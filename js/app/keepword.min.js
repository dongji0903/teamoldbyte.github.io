(()=>{let r="savedWordList",t="one-word-unit-section",i="."+t,s={el:"span",role:"button",class:"js-save-word keep-word-btn fas fa-download",dataset:{bsToggle:"tooltip",bsTitle:"보관하기"},children:[{el:"span",class:"keep-word-tail"}]},n={el:"span",role:"button",class:"js-unsave-word unkeep-word-btn fas fa-bookmark",dataset:{bsToggle:"tooltip",bsHtml:!0,bsTitle:"보관된 단어입니다.<br>보관을 해제하려면 다시 클릭"}},o={el:"div",class:"js-unsaved-toast toast align-items-center text-white p-0",role:"alert",style:{width:"150px",background:"#1b1f40",zIndex:9999},dataset:{bsDelay:1e3},ariaLive:"assertive",ariaAtomic:"true",children:[{el:"div",class:"toast-body p-1",textContent:"보관 해제되었습니다."}]},d,l;function c(n,e,a){return new Promise((d,t)=>{let s=l.findIndex(e=>e.wordId==n);if(-1<s){let e=l[s].keepWordId;$.ajax({url:"/memento/word/change-status",type:"POST",contentType:"application/json",data:JSON.stringify({keepWordId:e,del:!1}),success:()=>{l[s].del=!1,sessionStorage.setItem(r,JSON.stringify(l)),d(e)},error:t})}else new Promise((e,t)=>{Date.prototype.format?e((new Date).format("yyyy-MM-dd")):$.getScript("https://static.findsvoc.com/js/util/datetime-util.min.js",()=>e((new Date).format("yyyy-MM-dd")))}).then(i=>{$.ajax({url:"/memento/word/save",type:"POST",contentType:"application/json",data:JSON.stringify({wordId:n,sentenceId:e,workbookId:a,saveDate:i}),success:e=>{var{wordId:t,keepWordId:s,saveDate:a,del:o}=t={wordId:n,keepWordId:e,saveDate:i,del:!1},t={wordId:t,keepWordId:s,saveDate:a,del:o};l?l.push(t):l=[t],sessionStorage.setItem(r,JSON.stringify(l)),d(e)},error:t})})})}new Promise((e,o)=>{sessionStorage.getItem(r)?(l=JSON.parse(sessionStorage.getItem(r)),e()):$.getJSON("/memento/keepword/init",a=>{if(Array.isArray(a)){l=a;let s=0;!function t(){try{sessionStorage.setItem(r,JSON.stringify(l.slice(s))),0<s&&alertModal("브라우저 저장 공간이 부족하여 가장 오래 전 저장한 단어 "+s+"개는 제외되었습니다."),e()}catch(e){e instanceof QuotaExceededError&&(s>=a.length&&(alertModal("브라우저의 저장 공간이 부족합니다."),o()),s++,t())}}()}else alertModal("저장된 단어 목록을 읽어오지 못했습니다.",o)}).fail(()=>alertModal("저장된 단어 목록을 읽어오지 못했습니다.",o))}).then(()=>$.getScript("https://static.findsvoc.com/js/util/datetime-util.min.js")).then(()=>{$.getScript("https://static.findsvoc.com/js/public/peel.min.js",()=>{document.head.appendChild(createElement([{el:"link",rel:"stylesheet",href:"https://static.findsvoc.com/css/public/peel.min.css"},{el:"link",rel:"stylesheet",href:"https://static.findsvoc.com/css/app/keepword.min.css"}])),$(function(){d=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){d.unobserve(e.target);{e=e.target;let t=$(e).data().wordId,d=l.find(e=>e.wordId==t&&!e.del);d?($(e).addClass("saved").data("keepWordId",d.keepWordId).find(".title").before($(createElement(n)).show()),$(e).find(".meaning").each((e,t)=>{t.style.verticalAlign="middle";var s=Array.from(t.getClientRects(),e=>e.width).reduce((e,t)=>e+t),a=t.getClientRects()[0].height,t=($(t).wrapInner('<div class="d-inline-block peel"><div class="peel-bottom"></div></div>').find(".peel").prepend(`<div class="peel-top text-center fw-bold text-primary"><div class="position-relative top-50 translate-middle-y">${new Date(d.saveDate).format(s<54?"MM-dd":"yyyy-MM-dd")}</div></div><div class="peel-back"></div>`),$(t).find(".peel")[0]);t.style.width=s+10+"px",t.style.height=a+10+"px";let o=new Peel(t,{path:{"stroke-width":0,d:`M0,0 C0,5 ${s+10},5 ${s+10},0 ${s+10},0 ${s+10},${a+5} ${s+10},${a+5} ${s+10},${a+10} 0,${a+10} 0,${a+5} 0,${a+5} 0,0 0,0`},bottomShadowOffset:2,corner:Peel.Corners.TOP_LEFT});o.setFadeThreshold(.7),o.setPeelPosition(25,10),o.setPeelPath(25,10,o.width/2,2*o.height,o.width,2*o.height,2*o.width,o.height/2);let i;o.handleDrag(function(e,t,s){.85<o.getAmountClipped()&&(o.removeEvents(),$(o.el).closest(".meaning").css("verticalAlign","").text($(o.bottomLayer).text()));t=(t-(i=i||t))/o.width;this.setTimeAlongPath(t)}),$(t).data("peel",o)})):$(e).is(".saved")&&($(e).removeClass("saved").find(".js-unsave-word").remove(),$(e).find(".peel")?.data("peel")?.removeEvents(),$(e).find(".meaning").each((e,t)=>{$(t).text($(t).find(".peel-bottom").text())}))}}})}),$(i).each((e,t)=>{d.observe(t)}),new MutationObserver(e=>{e?.forEach(e=>{"childList"==e.type&&e.addedNodes?.forEach(e=>{e.nodeType==Node.ELEMENT_NODE&&e.classList?.contains(t)&&d.observe(e)})})}).observe(document,{childList:!0,subtree:!0})})})}),$(document).on("mouseover",i,function(){var e,t;$(this).is(".saved,.processing")||0<$(this).find(".js-save-word").length||(e=createElement(s),t=$(this).find(".title"),$(e).css("--offset",Math.max(t[0].offsetWidth/2,22)+"px"),$(e).insertAfter(t))}).on("mouseleave",i,function(){$(this).is(".processing")||$(this).find(".js-save-word").remove()}).on("click",".js-save-word",function(a){a.stopPropagation();a=$(this).closest(i);if(!a.is(".processing")){a.addClass("processing");let{wordId:e,sentenceId:t,workbookId:s}=a.data();setTimeout(()=>{c(e,t,s).then(e=>{{var a=this,o=e;let t=$(createElement(n));anime({targets:a,translateY:-20,opacity:0,easing:"linear",complete:e=>{let s=$(a).closest(i);$(i).filter((e,t)=>$(t).data("wordId")==s.data("wordId")&&!$(t).is(".saved,.processing")).each((e,t)=>{d.unobserve(t),d.observe(t)}),s.data("keepWordId",o).removeClass("processing").addClass("saved").find(".title").before(t),$(a).remove(),t.fadeIn()}})}}).catch(()=>alertModal("단어 보관에 실패했습니다."))},1e3)}}).on("click",".js-unsave-word",function(t){t.stopPropagation(),t.stopImmediatePropagation();t=$(this).closest(i);if(!t.is(".processing")){t.addClass("processing"),$(this).tooltip("hide");let e=t.data().keepWordId;$.ajax({url:"/memento/word/change-status",type:"POST",contentType:"application/json",data:JSON.stringify({keepWordId:e,del:!0}),success:()=>{var t;t=e,l&&(l.find(e=>e.keepWordId==t).del=!0,sessionStorage.setItem(r,JSON.stringify(l)));{var a=this;let e=createElement(o),t=createElement({el:"div",class:"position-absolute start-0 bottom-100"}),s=(t.appendChild(e),$(a).closest(i).removeData("keepWordId"));s.prepend(t),a.style.transformOrigin="200% 0",anime({targets:a,rotateX:"-90deg",rotateZ:"-150deg",scale:2,opacity:0,easing:"linear",duration:500,complete:()=>{$(a).remove(),s.removeClass("saved processing").find(".meaning").each(function(){$(this).find(".peel").each((e,t)=>{let s={t:0},a=$(t).data("peel");anime({targets:s,duration:2e3,t:1,change:e=>{a.setTimeAlongPath(s.t)},complete:e=>{a.removeEvents(),$(this).text($(this).find(".peel-bottom").text())}})})})}}),$(e).toast("show")}},error:()=>alertModal("단어 보관 해제에 실패했습니다.")})}}).on("hidden.bs.toast",".js-unsaved-toast",function(){$(this).parent().remove()}),Object.assign(window,{keepWord:c})})();
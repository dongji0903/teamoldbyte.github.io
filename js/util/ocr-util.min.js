class FicoOCR{#apiURL="https://vision.googleapis.com/v1/images:annotate";#apiKey="AIzaSyDaB537mMH2usYvkbdWDFqkmVkW8D22yE8";#imgOrientation=0;#$loadingModal;#$resultModal;#$textFeedback;#preview;constructor(){(async()=>{"undefined"==typeof EXIF&&(await $.getScript("https://cdn.jsdelivr.net/npm/exif-js")),"undefined"==typeof PinchZoom&&(await $.getScript("https://static.findsvoc.com/js/public/pinch-zoom.js")),"undefined"==typeof Dimmer&&(await $.getScript("https://static.findsvoc.com/js/public/dimmer.js")),"undefined"==typeof SelectionArea&&(await $.getScript("https://cdn.jsdelivr.net/npm/@viselect/vanilla/lib/viselect.cjs.min.js")),$(document.head).append($(`<style>
			/* 핀치줌 컨테이너 스타일 */
			.pinch-zoom-container {
				background: #000;
			}
			/* 드래그 상자가 올려지는 가상 레이어. 부트스트랩모달의 높이(1060)보다 높아야 함. */
			.selection-area-container { z-index: 1061!important;}
			.selection-area {
			    background: rgba(46, 115, 252, 0.11);
			    border: 2px solid rgba(98, 155, 255, 0.81);
			    border-radius: 0.1em;
			}
			/* 선택 가능 단어 스타일 */
			#ocrResultModal .candidate-text {
			    border: solid 1px #ddd7;
				border-radius: 1px;
			}
			/* 선택이 완료된 단어 스타일 */
			#ocrResultModal .candidate-text.selected-text {border: solid 1px #7f73;}
			/* 추가 선택될 단어 스타일 */
			#ocrResultModal .will-selected {border: solid 2px #0f0!important;}
			/* 선택 제외될 단어 스타일 */
			#ocrResultModal .will-removed {border: solid 2px #f00!important;}
			</style>`)),0==$("#ocrModal").length&&(this.#$loadingModal=$(`<div id="ocrModal" class="modal fade" data-bs-backdrop="static" tabindex="-1">
				<div class="modal-dialog modal-dialog-centered d-flex justify-content-center">
				<span class="btn btn-light">
				<span class="spinner-border text-yellow-400" role="status"></span><br>
				<span style="vertical-align: super;">분석 대상이 아닌 한글, 특수문자 등은<br><mark style="background-color:#f9d37a;">⨂</mark>기호로 바뀝니다.</span>
				</span></div></div>`),$(document.body).append(this.#$loadingModal)),0==$("#ocrResultModal").length&&(this.#$resultModal=$(`<div id="ocrResultModal" class="modal fade" data-bs-backdrop="static">
				<div class="modal-dialog modal-lg modal-fullscreen-lg-down modal-dialog-scrollable">
				<div class="modal-content h-100">
				<div class="modal-header row g-0 p-0">
				<div class="modal-title row g-0 bg-fc-purple">
				<span class="title col m-0 p-1 text-center text-white">편집하신 후 <b>완료</b>를 눌러주세요.</span>
				<button type="button" class="btn-close btn-close-white m-0 ms-auto" data-bs-dismiss="modal" title="취소"></button>
				</div>
				<div class="row g-0">
				<input type="radio" id="addArea" class="btn-check" name="selectArea" checked autocomplete="off">
				<label class="btn btn-outline-success col-3 ms-auto" for="addArea"><i class="fas fa-plus-square"></i> 추가</label>
				<input type="radio" id="removeArea" class="btn-check" name="selectArea" autocomplete="off">
				<label class="btn btn-outline-danger col-3" for="removeArea"><i class="fas fa-minus-square"></i> 제거</label>
				<button type="button" id="selectArea" class="btn btn-outline-fico col-3 ms-auto"><i class="fas fa-check-square"></i> 완료</button>
				</div></div>
				<div class="touch-msg bg-dark text-white text-center">두 손가락을 사용하여 스크롤하거나 확대하세요.</div>
				<div class="modal-body bg-dark p-0" style="user-select:none;">
				<img class="img-fluid position-relative pe-none" alt="OCR 이미지" style="filter:brightness(1.3) saturate(2);
				-webkit-filter:brightness(1.3) saturate(2);touch-action:none;user-select:none;-webkit-user-select: none;-webkit-user-drag: none;">
				</div></div></div></div>`),$(document.body).append(this.#$resultModal)),("ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints)&&(!/iPad|iPhone|iPod/.test(navigator.userAgent)||window.MSStream)||this.#$resultModal.find(".touch-msg").remove(),this.#$resultModal.on("shown.bs.modal",()=>{(/iPad|iPhone|iPod/.test(navigator.userAgent)||window.MSStream)&&(this.#$resultModal[0].style.touchAction="none")}).on("hidden.bs.modal",()=>{this.#$resultModal.find("#addArea").prop("checked",!0),this.#$resultModal.find(".modal-body .candidate-text").remove()}),this.#$resultModal.on("click","#selectArea",()=>{let a="",b=0;this.#$resultModal.find(".modal-body .selected-text").each(function(){this.offsetLeft<b&&(a+="\n"),a+=this.dataset.text+" ",b=this.offsetLeft}),this.#$resultModal.modal("hide"),this.#$textFeedback.call(null,a)}),console.info("Fico OCR is ready.")})()}readAsPreview(a,b,c){$("#ocrModal").modal("show"),this.#$textFeedback=b,this.imgFile2JSON(a,a=>{setTimeout(()=>{$("#ocrModal").modal("hide"),this.#ocrResultDisplay(a.preview,a.result)},1e3)},()=>{setTimeout(()=>$("#ocrModal").modal("hide"),1e3),c?.call()})}imgFile2Text(a,b,c){const d=this;d.#readFile(a,a=>d.#callVision(d.#removePrefix(a),a=>b(d.#joinResults(a)),c))}imgFile2JSON(a,b,c){const d=this;EXIF.getData(a,function(){switch(EXIF.getTag(this,"Orientation")){case 3:d.#imgOrientation=180;break;case 6:d.#imgOrientation=90;break;case 8:d.#imgOrientation=270;break;default:d.#imgOrientation=0;}}),d.#readFile(a,a=>d.#callVision(d.#removePrefix(a),a=>b({preview:d.imgUri,result:d.#extract1Page(a)}),c))}#callVision(a,b,c){$.post({url:`${this.#apiURL}?key=${this.#apiKey}`,data:JSON.stringify({requests:[{image:{content:a},features:[{type:"TEXT_DETECTION"}]}]}),contentType:"application/json"}).done(b).fail(c)}#readFile(a,b,c){const d=this;if(null==a||0==a.size||2e7<a.size)alert(null==a||0==a.size?"\uD30C\uC77C\uC744 \uC120\uD0DD\uD574 \uC8FC\uC138\uC694.":"\uCD5C\uB300 \uD30C\uC77C \uD06C\uAE30\uB294 20MB\uC785\uB2C8\uB2E4."),c?.call();else{const c=new FileReader;c.onloadend=function(a){d.imgUri=a.target.result,b(a.target.result)},c.readAsDataURL(a)}}#removePrefix(a){return a.replace(/data:image\/\w+;base64,/,"")}#joinResults(a){return Array.from(a.responses,a=>a.fullTextAnnotation?.text).join("\n")}#extract1Page(a){return a.responses[0]}#ocrResultDisplay(a,b){const c=b.fullTextAnnotation?.pages;this.#preview=this.#$resultModal.find(".modal-body img")[0];null==c||0==c?.length||(this.#$resultModal.modal("show").one("shown.bs.modal",()=>{this.#preview.src=a}),this.#preview.onload=()=>{this.#preview.decode().finally(()=>{var a=Math.max,b=Math.min;const d=this.#preview.naturalWidth,e=this.#preview.naturalHeight,f=this.#preview.width,g=this.#preview.height,h=c[0].blocks[0].boundingBox.vertices,i=h[0],j=h[1],k=h[2],l=h[3];let m=0;l.x<i.x&&i.y<j.y&&j.x>k.x&&k.y>l.y&&l.x<j.x&&l.y<j.y?m=90:k.x<l.x&&l.y<i.y&&i.x>j.x&&j.y>k.y&&k.x<i.x&&k.y<i.y?m=180:j.x<k.x&&k.y<l.y&&l.x>i.x&&i.y>j.y&&j.x<l.x&&j.y<l.y&&(m=270),this.#preview.style.transform=`rotate(${-this.#imgOrientation-m}deg)`;const n=(g-f)/2*Math.abs(Math.sin(Math.PI/180*(-this.#imgOrientation-m)));this.#preview.style.top=`${-n}px`,this.#preview.style.left=`${n}px`;const o=[];for(let h=0,i=c.length;h<i;h++){const i=c[h],j=c[h].blocks,k=i.width,l=i.height;for(let c=0,h=j.length;c<h;c++){if("TEXT"!=j[c].blockType)continue;const h=j[c].paragraphs;for(let c=0,i=h.length;c<i;c++){const i=h[c].words;for(let c=0,h=i.length;c<h;c++){const h=i[c];if(1<h.property?.detectedLanguages.length||"en"!=h.property?.detectedLanguages[0].languageCode)continue;const j=Array.from(h.boundingBox.vertices,a=>this.#rotate(k/2,l/2,a.x,a.y,m)),n=j[0],p=j[1],q=j[2],r=j[0],s=b(n.x,p.x,q.x,r.x),t=a(n.x,p.x,q.x,r.x),u=b(n.y,p.y,q.y,r.y),v=a(n.y,p.y,q.y,r.y),w=document.createElement("div");w.style.position="absolute",w.className="candidate-text selected-text",w.style.left=`${this.#resizeOffset(f,d,s)-2}px`,w.style.top=`${this.#resizeOffset(g,e,u)-2}px`,w.style.width=`${this.#resizeOffset(f,d,t-s)+4}px`,w.style.height=`${this.#resizeOffset(g,e,v-u)+4}px`,w.dataset.text=Array.from(h.symbols,a=>a.text).join(""),o.push(w)}}}}requestAnimationFrame(()=>this.#$resultModal.find(".modal-body").append(o)),this.selection=new SelectionArea({selectionContainerClass:"selection-area-container",selectables:["#ocrResultModal .modal-body>.candidate-text"],boundaries:["#ocrResultModal .modal-body"],behavior:{overlap:"keep"}}),this.selection.on("start",()=>{this.selection.clearSelection(),this.dimmer.resize(),this.#transformCanvas()}).on("move",({store:{changed:{added:a,removed:b}}})=>{if(this.#$resultModal.find("#addArea").is(":checked")){for(const b of a)b.matches(".selected-text")||b.classList.add("will-selected");for(const a of b)a.classList.remove("will-selected")}else{for(const b of a)b.matches(".selected-text")&&b.classList.add("will-removed");for(const a of b)a.classList.remove("will-removed")}}).on("stop",({store:{selected:a}})=>{if(this.#$resultModal.find("#addArea").is(":checked"))for(const b of a)b.classList.remove("will-selected"),b.classList.add("selected-text");else for(const b of a)b.classList.remove("will-removed"),b.classList.remove("selected-text");this.selection.clearSelection(),this.dimmer.highlight(".selected-text")}),requestAnimationFrame(()=>{"undefined"==typeof this.dimmer?(this.dimmer=new Dimmer({opacity:.5,padding:0,borderRadius:1,parent:this.#$resultModal.find(".modal-body")[0],fadeDuration:300,easing:"none",transitionDuration:0}),requestAnimationFrame(()=>{this.dimmer.highlight(".selected-text")})):(this.dimmer.clear(),this.dimmer.highlight(".selected-text"))}),("ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints)&&requestAnimationFrame(()=>{"undefined"==typeof this.pz&&(this.pz=new PinchZoom(this.#$resultModal.find(".modal-body")[0],{draggableUnzoomed:!1,setOffsetsOnce:!0,onZoomUpdate:()=>{this.selection.cancel(!0)},use2d:!1}))})})})}#transformCanvas(){this.parentTransform=getComputedStyle(this.#$resultModal.find(".modal-body")[0]).transform.match(/matrix\(([-\.\w\d]+), [-\.\w\d]+, [-\.\w\d]+, ([-\.\w\d]+), ([-\.\w\d]+), ([-\.\w\d]+)\)/)?.slice(1),null!=this.parentTransform&&(this.dimmer.canvas.width=1.5*this.dimmer.parent.getBoundingClientRect().width,this.dimmer.canvas.height=1.5*this.dimmer.parent.getBoundingClientRect().height,this.dimmer.canvas.getContext("2d").transform(1/parseFloat(this.parentTransform[0]),0,0,1/parseFloat(this.parentTransform[1]),0,0))}#rotate(a,b,c,d,e){var f=Math.abs;const g=Math.PI/180*e,h=Math.cos(g),i=Math.sin(g),j=h*(c-a)+i*(d-b)+a+f(i)*(b-a),k=h*(d-b)-i*(c-a)+b-f(i)*(b-a);return{x:j,y:k}}#resizeOffset(a,b,c){return c*a/b}}
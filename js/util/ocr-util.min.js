class FicoOCR{#apiURL="https://vision.googleapis.com/v1/images:annotate";#apiKey="AIzaSyDaB537mMH2usYvkbdWDFqkmVkW8D22yE8";#imgOrientation=0;#$loadingModal;#$resultModal;#$textFeedback;#preview;#cachedScript=$.cachedScript||function(e,t){return $.ajax($.extend(t||{},{dataType:"script",cache:!0,url:e}))};constructor(){(async()=>{"undefined"==typeof EXIF&&await this.#cachedScript("https://cdn.jsdelivr.net/npm/exif-js"),"undefined"==typeof PinchZoom&&await this.#cachedScript("https://static.findsvoc.com/js/public/pinch-zoom.min.js"),"undefined"==typeof Dimmer&&await this.#cachedScript("https://static.findsvoc.com/js/public/dimmer.min.js"),"undefined"==typeof SelectionArea&&await this.#cachedScript("https://cdn.jsdelivr.net/npm/@viselect/vanilla@3.1.1/lib/viselect.cjs.min.js"),$(document.head).append($("<style>/* 핀치줌 컨테이너 스타일 */.pinch-zoom-container {background: #000;}/* 드래그 상자가 올려지는 가상 레이어. 부트스트랩모달의 높이(1060)보다 높아야 함. */.selection-area-container { z-index: 1061!important;}.selection-area {background: rgba(46, 115, 252, 0.11);border: 2px solid rgba(98, 155, 255, 0.81);border-radius: 0.1em;}/* 선택 가능 단어 스타일 */#ocrResultModal .candidate-text {border: solid 1px #ddd7;border-radius: 1px;}/* 선택이 완료된 단어 스타일 */#ocrResultModal .candidate-text.selected-text {border: solid 1px #7f73;}/* 추가 선택될 단어 스타일 */#ocrResultModal .will-selected {border: solid 2px #0f0!important;}/* 선택 제외될 단어 스타일 */#ocrResultModal .will-removed {border: solid 2px #f00!important;}</style>")),0==$("#ocrModal").length&&(this.#$loadingModal=$(createElement({el:"div",id:"ocrModal",class:"modal fade","data-bs-backdrop":"static",tabindex:"-1",children:[{el:"div",class:"modal-dialog modal-dialog-centered d-flex justify-content-center",children:[{el:"span",class:"btn btn-light",children:[{el:"span",class:"spinner-border text-yellow-400",role:"status"},{el:"br"},{el:"span",style:"vertical-align: super;",children:["분석 대상이 아닌 한글, 특수문자 등은",{el:"br"},{el:"mark",style:"background-color:#f9d37a;",textContent:"⨂"},"기호로 바뀝니다."]}]}]}]})),$(document.body).append(this.#$loadingModal)),0==$("#ocrResultModal").length&&(this.#$resultModal=$(createElement({el:"div",id:"ocrResultModal",class:"modal fade","data-bs-backdrop":"static",children:[{el:"div",class:"modal-dialog modal-lg modal-fullscreen-lg-down modal-dialog-scrollable",children:[{el:"div",class:"modal-content h-100",children:[{el:"div",class:"modal-header row g-0 p-0",children:[{el:"div",class:"modal-title row g-0 bg-fc-purple",children:[{el:"span",class:"title col m-0 p-1 text-center text-white",children:["편집하신 후 ",{el:"b",textContent:"완료"},"를 눌러주세요."]},{el:"button",type:"button",class:"btn-close btn-close-white m-0 ms-auto","data-bs-dismiss":"modal",title:"취소"}]},{el:"div",class:"row g-0",children:[{el:"input",type:"radio",id:"addArea",class:"btn-check",name:"selectArea",checked:!0,autocomplete:"off"},{el:"label",class:"btn btn-outline-success col-3 ms-auto",for:"addArea",children:[{el:"i",class:"fas fa-plus-square"}," 추가"]},{el:"input",type:"radio",id:"removeArea",class:"btn-check",name:"selectArea",autocomplete:"off"},{el:"label",class:"btn btn-outline-danger col-3",for:"removeArea",children:[{el:"i",class:"fas fa-minus-square"}," 제거"]},{el:"button",type:"button",id:"selectArea",class:"btn btn-outline-fico col-3 ms-auto",children:[{el:"i",class:"fas fa-check-square"}," 완료"]}]}]},{el:"div",class:"touch-msg bg-dark text-white text-center",textContent:"두 손가락을 사용하여 스크롤하거나 확대하세요."},{el:"div",class:"modal-body bg-dark p-0",style:"user-select:none;",children:[{el:"img",class:"img-fluid position-relative pe-none",alt:"OCR 이미지",style:"filter:brightness(1.3) saturate(2);-webkit-filter:brightness(1.3) saturate(2);touch-action:none;user-select:none;-webkit-user-select: none;-webkit-user-drag: none;"}]}]}]}]})),$(document.body).append(this.#$resultModal)),("ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints)&&(!/iPad|iPhone|iPod/.test(navigator.userAgent)||window.MSStream)||this.#$resultModal.find(".touch-msg").remove(),this.#$resultModal.on("shown.bs.modal",()=>{(/iPad|iPhone|iPod/.test(navigator.userAgent)||window.MSStream)&&(this.#$resultModal[0].style.touchAction="none")}).on("hidden.bs.modal",()=>{this.#$resultModal.find("#addArea").prop("checked",!0),this.#$resultModal.find(".modal-body .candidate-text").remove()}),this.#$resultModal.on("click","#selectArea",()=>{let e="",t=0;this.#$resultModal.find(".modal-body .selected-text").each(function(){this.offsetLeft<t&&(e+="\n"),e+=this.dataset.text+" ",t=this.offsetLeft}),this.#$resultModal.modal("hide"),this.#$textFeedback.call(null,e)}),console.info("Fico OCR is ready.")})()}readAsPreview(e,t,i){$("#ocrModal").modal("show"),this.#$textFeedback=t;const s=this;this.imgFile2JSON(e,function(e){setTimeout(()=>{$("#ocrModal").modal("hide"),s.#ocrResultDisplay(e.preview,e.result)},1e3)},()=>{setTimeout(()=>$("#ocrModal").modal("hide"),1e3),i?.call()})}imgFile2Text(e,t,i){const s=this;s.#readFile(e,function(e){s.#callVision(s.#removePrefix(e),e=>t(s.#joinResults(e)),i)},i)}imgFile2JSON(e,t,i){const s=this;EXIF.getData(e,function(){switch(EXIF.getTag(this,"Orientation")){case 3:s.#imgOrientation=180;break;case 6:s.#imgOrientation=90;break;case 8:s.#imgOrientation=270;break;default:s.#imgOrientation=0}}),s.#readFile(e,e=>s.#callVision(s.#removePrefix(e),e=>t({preview:s.imgUri,result:s.#extract1Page(e)}),i))}#callVision(e,t,i){$.post({url:this.#apiURL+"?key="+this.#apiKey,data:JSON.stringify({requests:[{image:{content:e},features:[{type:"TEXT_DETECTION"}]}]}),contentType:"application/json"}).done(t).fail(i)}#readFile(e,t,i){const s=this;null==e||0==e.size||2e7<e.size?(alert(null==e||0==e.size?"파일을 선택해 주세요.":"최대 파일 크기는 20MB입니다."),i?.call()):((i=new FileReader).onloadend=function(e){s.imgUri=e.target.result,t(e.target.result)},i.readAsDataURL(e))}#removePrefix(e){return e.replace(/data:image\/\w+;base64,/,"")}#joinResults(e){return Array.from(e.responses,e=>e.fullTextAnnotation?.text).join("\n")}#extract1Page(e){return e.responses[0]}#ocrResultDisplay(e,t){const k=t.fullTextAnnotation?.pages;this.#preview=this.#$resultModal.find(".modal-body img")[0],null!=k&&0!=k?.length&&(this.#$resultModal.modal("show").one("shown.bs.modal",()=>{this.#preview.src=e}),this.#preview.onload=()=>{this.#preview.decode().finally(()=>{var i=this.#preview.naturalWidth,s=this.#preview.naturalHeight,a=this.#preview.width,o=this.#preview.height,e=k[0].blocks[0].boundingBox.vertices,t=e[0],l=e[1],n=e[2],e=e[3];let r=0;e.x<t.x&&t.y<l.y&&l.x>n.x&&n.y>e.y&&e.x<l.x&&e.y<l.y?r=90:n.x<e.x&&e.y<t.y&&t.x>l.x&&l.y>n.y&&n.x<t.x&&n.y<t.y?r=180:l.x<n.x&&n.y<e.y&&e.x>t.x&&t.y>l.y&&l.x<e.x&&l.y<e.y&&(r=270),this.#preview.style.transform=`rotate(${-this.#imgOrientation-r}deg)`;n=(o-a)/2*Math.abs(Math.sin(Math.PI/180*(-this.#imgOrientation-r)));this.#preview.style.top=-n+"px",this.#preview.style.left=n+"px";const d=[];for(let e=0,t=k.length;e<t;e++){const v=k[e],w=k[e].blocks,M=v.width,$=v.height;for(let e=0,t=w.length;e<t;e++)if("TEXT"==w[e].blockType){var c=w[e].paragraphs;for(let e=0,t=c.length;e<t;e++){var h=c[e].words;for(let e=0,t=h.length;e<t;e++){var m,u,p,f,g,x,b,y=h[e];1<y.property?.detectedLanguages.length||"en"!=y.property?.detectedLanguages[0].languageCode||(x=(u=Array.from(y.boundingBox.vertices,e=>this.#rotate(M/2,$/2,e.x,e.y,r)))[0],b=u[1],m=u[2],u=u[0],p=Math.min(x.x,b.x,m.x,u.x),f=Math.max(x.x,b.x,m.x,u.x),g=Math.min(x.y,b.y,m.y,u.y),x=Math.max(x.y,b.y,m.y,u.y),(b=document.createElement("div")).style.position="absolute",b.className="candidate-text selected-text",b.style.left=this.#resizeOffset(a,i,p)-2+"px",b.style.top=this.#resizeOffset(o,s,g)-2+"px",b.style.width=this.#resizeOffset(a,i,f-p)+4+"px",b.style.height=this.#resizeOffset(o,s,x-g)+4+"px",b.dataset.text=Array.from(y.symbols,e=>e.text).join(""),d.push(b))}}}}requestAnimationFrame(()=>this.#$resultModal.find(".modal-body").append(d)),this.selection=new SelectionArea({selectionContainerClass:"selection-area-container",selectables:["#ocrResultModal .modal-body>.candidate-text"],boundaries:["#ocrResultModal .modal-body"],behavior:{overlap:"keep"}}),this.selection.on("start",()=>{this.selection.clearSelection(),this.dimmer.resize(),this.#transformCanvas()}).on("move",({store:{changed:{added:e,removed:t}}})=>{if(this.#$resultModal.find("#addArea").is(":checked")){for(const i of e)i.matches(".selected-text")||i.classList.add("will-selected");for(const s of t)s.classList.remove("will-selected")}else{for(const a of e)a.matches(".selected-text")&&a.classList.add("will-removed");for(const o of t)o.classList.remove("will-removed")}}).on("stop",({store:{selected:e}})=>{if(this.#$resultModal.find("#addArea").is(":checked"))for(const t of e)t.classList.remove("will-selected"),t.classList.add("selected-text");else for(const i of e)i.classList.remove("will-removed"),i.classList.remove("selected-text");this.selection.clearSelection(),this.dimmer.highlight(".selected-text")}),requestAnimationFrame(()=>{void 0===this.dimmer?(this.dimmer=new Dimmer({opacity:.5,padding:0,borderRadius:1,parent:this.#$resultModal.find(".modal-body")[0],fadeDuration:300,easing:"none",transitionDuration:0}),requestAnimationFrame(()=>{this.dimmer.highlight(".selected-text")})):(this.dimmer.clear(),this.dimmer.highlight(".selected-text"))}),("ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints)&&requestAnimationFrame(()=>{void 0===this.pz&&(this.pz=new PinchZoom(this.#$resultModal.find(".modal-body")[0],{draggableUnzoomed:!1,setOffsetsOnce:!0,onZoomUpdate:(e,t)=>{this.selection.cancel(!0)},use2d:!1}))})})})}#transformCanvas(){this.parentTransform=getComputedStyle(this.#$resultModal.find(".modal-body")[0]).transform.match(/matrix\(([-\.\w\d]+), [-\.\w\d]+, [-\.\w\d]+, ([-\.\w\d]+), ([-\.\w\d]+), ([-\.\w\d]+)\)/)?.slice(1),null!=this.parentTransform&&(this.dimmer.canvas.width=1.5*this.dimmer.parent.getBoundingClientRect().width,this.dimmer.canvas.height=1.5*this.dimmer.parent.getBoundingClientRect().height,this.dimmer.canvas.getContext("2d").transform(1/parseFloat(this.parentTransform[0]),0,0,1/parseFloat(this.parentTransform[1]),0,0))}#rotate(e,t,i,s,a){var a=Math.PI/180*a,o=Math.cos(a),a=Math.sin(a);return{x:o*(i-e)+a*(s-t)+e+Math.abs(a)*(t-e),y:o*(s-t)-a*(i-e)+t-Math.abs(a)*(t-e)}}#resizeOffset(e,t,i){return i*e/t}}
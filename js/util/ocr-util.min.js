class FicoOCR{#apiURL="https://vision.googleapis.com/v1/images:annotate";#apiKey="AIzaSyDaB537mMH2usYvkbdWDFqkmVkW8D22yE8";#imgOrientation=0;#$loadingModal;#$resultModal;#$textFeedback;#preview;#cachedScript=$.cachedScript||function(e,t){return $.ajax($.extend(t||{},{dataType:"script",cache:!0,url:e}))};constructor(){(async()=>{0==$("#ocrModal").length&&(this.#$loadingModal=$(createElement({el:"div",id:"ocrModal",class:"modal fade","data-bs-backdrop":"static",tabindex:"-1",children:[{el:"div",class:"modal-dialog modal-dialog-centered d-flex justify-content-center",children:[{el:"span",class:"btn btn-light",children:[{el:"span",class:"spinner-border text-yellow-400",role:"status"},{el:"br"},{el:"span",style:"vertical-align: super;",children:["분석 대상이 아닌 한글, 특수문자 등은",{el:"br"},{el:"mark",style:"background-color:#f9d37a;",textContent:"⨂"},"기호로 바뀝니다."]}]}]}]})),$(document.body).append(this.#$loadingModal)),"undefined"==typeof EXIF&&await this.#cachedScript("https://cdn.jsdelivr.net/npm/exif-js"),"undefined"==typeof PinchZoom&&await this.#cachedScript("https://static.findsvoc.com/js/public/pinch-zoom.min.js"),"undefined"==typeof Dimmer&&await this.#cachedScript("https://static.findsvoc.com/js/public/dimmer.min.js"),"undefined"==typeof SelectionArea&&await this.#cachedScript("https://cdn.jsdelivr.net/npm/@viselect/vanilla@3.1.1/lib/viselect.cjs.min.js"),$(document.head).append($("<style>/* 핀치줌 컨테이너 스타일 */.pinch-zoom-container {background: #000;}/* 드래그 상자가 올려지는 가상 레이어. 부트스트랩모달의 높이(1060)보다 높아야 함. */.selection-area-container { z-index: 1061!important;}.selection-area {background: rgba(46, 115, 252, 0.11);border: 2px solid rgba(98, 155, 255, 0.81);border-radius: 0.1em;}/* 선택 가능 단어 스타일 */#ocrResultModal .candidate-text {border: solid 1px #ddd7;border-radius: 1px;}/* 선택이 완료된 단어 스타일 */#ocrResultModal .candidate-text.selected-text {border: solid 1px #7f73;}/* 추가 선택될 단어 스타일 */#ocrResultModal .will-selected {border: solid 2px #0f0!important;}/* 선택 제외될 단어 스타일 */#ocrResultModal .will-removed {border: solid 2px #f00!important;}</style>")),0==$("#ocrResultModal").length&&(this.#$resultModal=$(createElement({el:"div",id:"ocrResultModal",class:"modal fade","data-bs-backdrop":"static",children:[{el:"div",class:"modal-dialog modal-lg modal-fullscreen-lg-down modal-dialog-scrollable",children:[{el:"div",class:"modal-content h-100",children:[{el:"div",class:"modal-header row g-0 p-0",children:[{el:"div",class:"modal-title row g-0 bg-fc-purple",children:[{el:"span",class:"title col m-0 p-1 text-center text-white",children:["편집하신 후 ",{el:"b",textContent:"완료"},"를 눌러주세요."]},{el:"button",type:"button",class:"btn-close btn-close-white m-0 ms-auto","data-bs-dismiss":"modal",title:"취소"}]},{el:"div",class:"row g-0",children:[{el:"input",type:"radio",id:"addArea",class:"btn-check",name:"selectArea",checked:!0,autocomplete:"off"},{el:"label",class:"btn btn-outline-success col-3 ms-auto",for:"addArea",children:[{el:"i",class:"fas fa-plus-square"}," 추가"]},{el:"input",type:"radio",id:"removeArea",class:"btn-check",name:"selectArea",autocomplete:"off"},{el:"label",class:"btn btn-outline-danger col-3",for:"removeArea",children:[{el:"i",class:"fas fa-minus-square"}," 제거"]},{el:"button",type:"button",id:"selectArea",class:"btn btn-outline-fico col-3 ms-auto",children:[{el:"i",class:"fas fa-check-square"}," 완료"]}]}]},{el:"div",class:"touch-msg bg-dark text-white text-center",textContent:"두 손가락을 사용하여 스크롤하거나 확대하세요."},{el:"div",class:"modal-body bg-dark p-0",style:"user-select:none;",children:[{el:"img",class:"img-fluid position-relative pe-none",alt:"OCR 이미지",style:"filter:brightness(1.3) saturate(2);-webkit-filter:brightness(1.3) saturate(2);touch-action:none;user-select:none;-webkit-user-select: none;-webkit-user-drag: none;"}]}]}]}]})),$(document.body).append(this.#$resultModal)),("ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints)&&(!/iPad|iPhone|iPod/.test(navigator.userAgent)||window.MSStream)||this.#$resultModal.find(".touch-msg").remove(),this.#$resultModal.on("shown.bs.modal",()=>{(/iPad|iPhone|iPod/.test(navigator.userAgent)||window.MSStream)&&(this.#$resultModal[0].style.touchAction="none")}).on("hidden.bs.modal",()=>{this.#$resultModal.find("#addArea").prop("checked",!0),this.#$resultModal.find(".modal-body .candidate-text").remove()}),this.#$resultModal.on("click","#selectArea",()=>{let e="",t=0;this.#$resultModal.find(".modal-body .selected-text").each(function(){this.offsetLeft<t&&(e+="\n"),e+=this.dataset.text+" ",t=this.offsetLeft}),this.#$resultModal.modal("hide"),this.#$textFeedback.call(null,e)}),console.info("Fico OCR is ready.")})()}readAsPreview(e,t,i){$("#ocrModal").modal("show"),this.#$textFeedback=t;let a=this;this.imgFile2JSON(e,function(e){setTimeout(()=>{$("#ocrModal").modal("hide"),a.#ocrResultDisplay(e.preview,e.result)},1e3)},()=>{setTimeout(()=>$("#ocrModal").modal("hide"),1e3),i?.call()})}imgFile2Text(e,t,i){let a=this;a.#readFile(e,function(e){a.#callVision(a.#removePrefix(e),e=>t(a.#joinResults(e)),i)},i)}imgFile2JSON(e,t,i){let a=this;EXIF.getData(e,function(){switch(EXIF.getTag(this,"Orientation")){case 3:a.#imgOrientation=180;break;case 6:a.#imgOrientation=90;break;case 8:a.#imgOrientation=270;break;default:a.#imgOrientation=0}}),a.#readFile(e,e=>a.#callVision(a.#removePrefix(e),e=>t({preview:a.imgUri,result:a.#extract1Page(e)}),i))}#callVision(e,t,i){$.post({url:this.#apiURL+"?key="+this.#apiKey,data:JSON.stringify({requests:[{image:{content:e},features:[{type:"TEXT_DETECTION"}]}]}),contentType:"application/json"}).done(t).fail(i)}#readFile(e,t,i){let a=this;null==e||0==e.size||2e7<e.size?(alert(null==e||0==e.size?"파일을 선택해 주세요.":"최대 파일 크기는 20MB입니다."),i?.call()):((i=new FileReader).onloadend=function(e){a.imgUri=e.target.result,t(e.target.result)},i.readAsDataURL(e))}#removePrefix(e){return e.replace(/data:image\/\w+;base64,/,"")}#joinResults(e){return Array.from(e.responses,e=>e.fullTextAnnotation?.text).join("\n")}#extract1Page(e){return e.responses[0]}#ocrResultDisplay(e,t){let w=t.fullTextAnnotation?.pages;this.#preview=this.#$resultModal.find(".modal-body img")[0],null!=w&&0!=w?.length&&(this.#$resultModal.modal("show").one("shown.bs.modal",()=>{this.#preview.src=e}),this.#preview.onload=()=>{this.#preview.decode().finally(()=>{var l=this.#preview.naturalWidth,o=this.#preview.naturalHeight,r=this.#preview.width,n=this.#preview.height,e=w[0].blocks[0].boundingBox.vertices,t=e[0],i=e[1],a=e[2],e=e[3];let d=0;e.x<t.x&&t.y<i.y&&i.x>a.x&&a.y>e.y&&e.x<i.x&&e.y<i.y?d=90:a.x<e.x&&e.y<t.y&&t.x>i.x&&i.y>a.y&&a.x<t.x&&a.y<t.y?d=180:i.x<a.x&&a.y<e.y&&t.x<e.x&&i.y<t.y&&i.x<e.x&&i.y<e.y&&(d=270),this.#preview.style.transform=`rotate(${-this.#imgOrientation-d}deg)`;a=(n-r)/2*Math.abs(Math.sin(Math.PI/180*(-this.#imgOrientation-d)));this.#preview.style.top=-a+"px",this.#preview.style.left=a+"px";let c=[];for(let t=0,e=w.length;t<e;t++){let e=w[t],i=w[t].blocks,a=e.width,s=e.height;for(let e=0,t=i.length;e<t;e++)if("TEXT"==i[e].blockType){var h=i[e].paragraphs;for(let e=0,t=h.length;e<t;e++){var m=h[e].words;for(let e=0,t=m.length;e<t;e++){var u,p,f,g,x,b,y,v=m[e];1<v.property?.detectedLanguages.length||"en"!=v.property?.detectedLanguages[0].languageCode||(b=(p=Array.from(v.boundingBox.vertices,e=>this.#rotate(a/2,s/2,e.x,e.y,d)))[0],y=p[1],u=p[2],p=p[0],f=Math.min(b.x,y.x,u.x,p.x),g=Math.max(b.x,y.x,u.x,p.x),x=Math.min(b.y,y.y,u.y,p.y),b=Math.max(b.y,y.y,u.y,p.y),(y=document.createElement("div")).style.position="absolute",y.className="candidate-text selected-text",y.style.left=this.#resizeOffset(r,l,f)-2+"px",y.style.top=this.#resizeOffset(n,o,x)-2+"px",y.style.width=this.#resizeOffset(r,l,g-f)+4+"px",y.style.height=this.#resizeOffset(n,o,b-x)+4+"px",y.dataset.text=Array.from(v.symbols,e=>e.text).join(""),c.push(y))}}}}requestAnimationFrame(()=>this.#$resultModal.find(".modal-body").append(c)),this.selection=new SelectionArea({selectionContainerClass:"selection-area-container",selectables:["#ocrResultModal .modal-body>.candidate-text"],boundaries:["#ocrResultModal .modal-body"],behavior:{overlap:"keep"}}),this.selection.on("start",()=>{this.selection.clearSelection(),this.dimmer.resize(),this.#transformCanvas()}).on("move",({store:{changed:{added:e,removed:t}}})=>{if(this.#$resultModal.find("#addArea").is(":checked")){for(var i of e)i.matches(".selected-text")||i.classList.add("will-selected");for(var a of t)a.classList.remove("will-selected")}else{for(var s of e)s.matches(".selected-text")&&s.classList.add("will-removed");for(var l of t)l.classList.remove("will-removed")}}).on("stop",({store:{selected:e}})=>{if(this.#$resultModal.find("#addArea").is(":checked"))for(var t of e)t.classList.remove("will-selected"),t.classList.add("selected-text");else for(var i of e)i.classList.remove("will-removed"),i.classList.remove("selected-text");this.selection.clearSelection(),this.dimmer.highlight(".selected-text")}),requestAnimationFrame(()=>{void 0===this.dimmer?(this.dimmer=new Dimmer({opacity:.5,padding:0,borderRadius:1,parent:this.#$resultModal.find(".modal-body")[0],fadeDuration:300,easing:"none",transitionDuration:0}),requestAnimationFrame(()=>{this.dimmer.highlight(".selected-text")})):(this.dimmer.clear(),this.dimmer.highlight(".selected-text"))}),("ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints)&&requestAnimationFrame(()=>{void 0===this.pz&&(this.pz=new PinchZoom(this.#$resultModal.find(".modal-body")[0],{draggableUnzoomed:!1,setOffsetsOnce:!0,onZoomUpdate:(e,t)=>{this.selection.cancel(!0)},use2d:!1}))})})})}#transformCanvas(){this.parentTransform=getComputedStyle(this.#$resultModal.find(".modal-body")[0]).transform.match(/matrix\(([-\.\w\d]+), [-\.\w\d]+, [-\.\w\d]+, ([-\.\w\d]+), ([-\.\w\d]+), ([-\.\w\d]+)\)/)?.slice(1),null!=this.parentTransform&&(this.dimmer.canvas.width=1.5*this.dimmer.parent.getBoundingClientRect().width,this.dimmer.canvas.height=1.5*this.dimmer.parent.getBoundingClientRect().height,this.dimmer.canvas.getContext("2d").transform(1/parseFloat(this.parentTransform[0]),0,0,1/parseFloat(this.parentTransform[1]),0,0))}#rotate(e,t,i,a,s){var s=Math.PI/180*s,l=Math.cos(s),s=Math.sin(s);return{x:l*(i-e)+s*(a-t)+e+Math.abs(s)*(t-e),y:l*(a-t)-s*(i-e)+t-Math.abs(s)*(t-e)}}#resizeOffset(e,t,i){return i*e/t}}